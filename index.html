<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gogo Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        * {
            -webkit-tap-highlight-color: transparent;
        }
        .reel:not(:disabled) {
            cursor: pointer;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .shop-carousel {
            scroll-snap-type: x mandatory;
        }
        .shop-item {
            scroll-snap-align: center;
        }
        /* Minimal animation for damage/effect popups to ensure they are removed after appearing */
        @keyframes fade-out-quick {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        .damage-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2.5rem;
            font-weight: 700;
            color: #FFFFFF;
            pointer-events: none;
            animation: fade-out-quick 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="bg-black flex items-center justify-center min-h-screen">

    <!-- Mobile Phone Silhouette -->
    <div class="w-full max-w-sm h-[90vh] max-h-[800px] bg-gray-900 border border-gray-800 rounded-lg flex flex-col overflow-hidden relative">
        
        <!-- Top Status Bar -->
        <div id="top-status-bar" class="relative p-4 border-b border-gray-800 flex flex-col justify-center gap-3 text-white bg-gray-900 z-10">
            <!-- Counters -->
            <div class="grid grid-cols-4 gap-x-2 text-center items-center">
                <div id="player-armor-container" class="flex items-center justify-center gap-1.5">
                    <span id="status-armor-icon" class="text-2xl">üõ°Ô∏è</span>
                    <span id="player-armor" class="font-bold text-lg">0</span>
                </div>
                <div class="flex items-center justify-center gap-1.5">
                    <span id="status-weapon-icon" class="text-2xl">‚öîÔ∏è</span>
                    <span id="attack-power" class="font-bold text-lg">8</span>
                </div>
                <div class="flex items-center justify-center gap-1.5">
                    <span class="text-2xl">üí∞</span>
                    <span id="player-gold" class="font-bold text-lg">99</span>
                </div>
                <div class="flex items-center justify-center">
                    <button data-modal-target="world-map-modal-wrapper" class="text-3xl">üë§</button>
                </div>
            </div>
            <!-- Meters -->
            <div class="space-y-1.5">
                <!-- HP Bar -->
                <div id="player-hp-container" class="flex items-center">
                    <span class="text-xl w-10 text-center">‚ù§Ô∏è</span>
                    <div class="relative w-full bg-gray-800 rounded-full h-4 border border-gray-700">
                        <div id="hp-bar" class="bg-gray-200 h-full rounded-full" style="width: 100%"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="hp-text" class="text-xs font-bold text-black">10/10</span>
                        </div>
                    </div>
                </div>
                <!-- Enemy Bar -->
                <div class="flex items-center">
                    <span class="text-xl w-10 text-center">üíÄ</span>
                    <div class="relative w-full bg-gray-800 rounded-full h-4 border border-gray-700">
                        <div id="skull-meter-bar" class="bg-gray-200 h-full rounded-full" style="width: 0%"></div>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="skull-meter-text" class="text-xs font-bold text-black">0/10</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Screen Area (Central Area) -->
        <div class="flex-grow flex flex-col p-4 relative bg-gray-900">
            <!-- Top half for slot machine -->
            <div class="h-1/2 flex items-center justify-center">
                <!-- Slot Machine -->
                <div id="slot-machine" class="flex space-x-4 items-end">
                    <!-- Reel 1 Column -->
                    <div class="flex flex-col items-center gap-1">
                        <div class="h-4 flex items-center justify-center gap-0.5" style="min-width: 56px;">
                            <span class="enemy-status enemy-1-status-poison text-xs" style="display: none;">‚ò†Ô∏è</span>
                            <span class="enemy-status enemy-1-status-curse text-xs" style="display: none;">üïØÔ∏è</span>
                            <span class="enemy-status enemy-1-status-sluggish text-xs" style="display: none;">üêå</span>
                            <span class="enemy-status enemy-1-status-regen text-xs" style="display: none;">‚ùáÔ∏è</span>
                        </div>
                        <button id="reel1" class="relative reel text-6xl p-4 border border-gray-700 rounded-xl w-24 h-24 flex items-center justify-center bg-gray-800" disabled>
                            <span class="reel-content">‚ùî</span>
                            <div class="attack-value absolute top-1 left-1 bg-gray-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-md hidden">1</div>
                            <div class="special-value absolute top-1 right-1 bg-gray-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-md hidden"></div>
                        </button>
                    </div>
                    <!-- Reel 2 Column -->
                    <div class="flex flex-col items-center gap-1">
                         <div class="h-4 flex items-center justify-center gap-0.5" style="min-width: 56px;">
                            <span class="enemy-status enemy-2-status-poison text-xs" style="display: none;">‚ò†Ô∏è</span>
                            <span class="enemy-status enemy-2-status-curse text-xs" style="display: none;">üïØÔ∏è</span>
                            <span class="enemy-status enemy-2-status-sluggish text-xs" style="display: none;">üêå</span>
                            <span class="enemy-status enemy-2-status-regen text-xs" style="display: none;">‚ùáÔ∏è</span>
                        </div>
                        <button id="reel2" class="relative reel text-6xl p-4 border border-gray-700 rounded-xl w-24 h-24 flex items-center justify-center bg-gray-800" disabled>
                            <span class="reel-content">‚ùî</span>
                            <div class="attack-value absolute top-1 left-1 bg-gray-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-md hidden">1</div>
                            <div class="special-value absolute top-1 right-1 bg-gray-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-md hidden"></div>
                        </button>
                    </div>
                    <!-- Reel 3 Column -->
                    <div class="flex flex-col items-center gap-1">
                         <div class="h-4 flex items-center justify-center gap-0.5" style="min-width: 56px;">
                            <span class="enemy-status enemy-3-status-poison text-xs" style="display: none;">‚ò†Ô∏è</span>
                            <span class="enemy-status enemy-3-status-curse text-xs" style="display: none;">üïØÔ∏è</span>
                            <span class="enemy-status enemy-3-status-sluggish text-xs" style="display: none;">üêå</span>
                            <span class="enemy-status enemy-3-status-regen text-xs" style="display: none;">‚ùáÔ∏è</span>
                        </div>
                        <button id="reel3" class="relative reel text-6xl p-4 border border-gray-700 rounded-xl w-24 h-24 flex items-center justify-center bg-gray-800" disabled>
                            <span class="reel-content">‚ùî</span>
                            <div class="attack-value absolute top-1 left-1 bg-gray-600 text-white text-xs font-bold px-1.5 py-0.5 rounded-md hidden">1</div>
                            <div class="special-value absolute top-1 right-1 bg-gray-500 text-white text-xs font-bold px-1.5 py-0.5 rounded-md hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Bottom half for enemy info -->
            <div class="h-1/2 pt-4 flex justify-center items-start">
                <div id="enemy-info-area" class="flex space-x-4 text-white hidden">
                    <!-- Enemy 1 Info -->
                    <div id="enemy-info-1" class="text-center w-24">
                        <div class="relative w-full bg-gray-800 rounded-full h-4 border border-gray-700 mb-1">
                            <div class="health-bar bg-gray-200 h-full rounded-full" style="width: 100%"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="health-text-1" class="text-black font-bold" style="font-size: 0.7rem;">10/10</span>
                            </div>
                        </div>
                        <p id="enemy-name-1" class="text-xs font-bold truncate">-</p>
                    </div>
                    <!-- Enemy 2 Info -->
                    <div id="enemy-info-2" class="text-center w-24">
                        <div class="relative w-full bg-gray-800 rounded-full h-4 border border-gray-700 mb-1">
                            <div class="health-bar bg-gray-200 h-full rounded-full" style="width: 100%"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="health-text-2" class="text-black font-bold" style="font-size: 0.7rem;">10/10</span>
                            </div>
                        </div>
                        <p id="enemy-name-2" class="text-xs font-bold truncate">-</p>
                    </div>
                    <!-- Enemy 3 Info -->
                    <div id="enemy-info-3" class="text-center w-24">
                        <div class="relative w-full bg-gray-800 rounded-full h-4 border border-gray-700 mb-1">
                            <div class="health-bar bg-gray-200 h-full rounded-full" style="width: 100%"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="health-text-3" class="text-black font-bold" style="font-size: 0.7rem;">10/10</span>
                            </div>
                        </div>
                        <p id="enemy-name-3" class="text-xs font-bold truncate">-</p>
                    </div>
                </div>
            </div>
            <div id="wave-counter" class="absolute bottom-2 left-4 text-gray-400 text-sm font-medium">Wave <span id="wave-number">1</span> (<span id="spin-counter" class="text-gray-300">5</span>)</div>
            <!-- Player Status Effects -->
            <div id="player-status-effects" class="absolute bottom-2 right-4 flex flex-nowrap justify-end items-center gap-0.5 text-lg" style="min-width: 120px;">
                <span id="player-status-poison" style="display: none;">‚ò†Ô∏è</span>
                <span id="player-status-curse" style="display: none;">üïØÔ∏è</span>
                <span id="player-status-sluggish" style="display: none;">üêå</span>
                <span id="player-status-regen" style="display: none;">‚ùáÔ∏è</span>
                <span id="player-status-blessing" style="display: none;">üåü</span>
                <span id="player-status-rush" style="display: none;">‚ö°</span>
            </div>
            
            <!-- SKULL METER FULL MODAL -->
            <div id="skull-meter-modal" class="hidden absolute inset-x-4 top-1/3 flex flex-col items-center text-white z-20 gap-8">
                <h2 class="text-2xl font-bold text-center">Make a choice.</h2>
                <div class="w-full flex flex-col gap-4">
                    <button id="choice-hp" class="w-full py-3 bg-gray-700 rounded-lg font-bold border border-gray-600 text-lg">+1 Max HP</button>
                    <button id="choice-luck" class="w-full py-3 bg-gray-700 text-white rounded-lg font-bold border border-gray-600 text-lg">+5% Luck</button>
                </div>
            </div>
        </div>

        <!-- Controls Area -->
        <div id="controls-area" class="h-[35%] border-t border-gray-800 relative bg-black">
            <!-- Button Grid Container -->
            <div id="button-grid" class="p-6 h-full">
                <div class="grid grid-cols-3 grid-rows-2 gap-4 h-full items-center">
                    <button data-modal-target="items-modal-wrapper" class="h-16 bg-gray-800 text-white font-bold rounded-xl border border-gray-700 text-4xl">üè™</button>
                    <button data-modal-target="quests-modal-wrapper" class="h-16 bg-gray-800 text-white font-bold rounded-xl border border-gray-700 text-4xl">‚ú®</button>
                    <button data-modal-target="map-modal-wrapper" class="h-16 bg-gray-800 text-white font-bold rounded-xl border border-gray-700 text-4xl">üåô</button>
                    <button data-modal-target="equip-modal-wrapper" class="h-16 bg-gray-800 text-white font-bold rounded-xl border border-gray-700 text-4xl">üîÆ</button>
                    <button id="spin-button" class="bg-blue-800 text-white font-bold rounded-full aspect-square border border-blue-700 flex items-center justify-center text-xl">Spin</button>
                    <button data-modal-target="system-modal-wrapper" class="h-16 bg-gray-800 text-white font-bold rounded-xl border border-gray-700 text-4xl">‚öîÔ∏è</button>
                </div>
            </div>
            
            <!-- MODALS -->
            <!-- Items Modal -->
            <div id="items-modal-wrapper" class="modal-wrapper hidden absolute inset-0 z-50">
                <div class="h-full w-full bg-gray-900 flex flex-col">
                    <div id="shop-list-container" class="flex-grow p-4 space-y-2 overflow-y-auto scrollbar-hide">
                        <!-- Shop items are dynamically inserted here by JavaScript -->
                    </div>
                </div>
                <button class="close-modal-btn absolute left-1/2 -translate-x-1/2 -top-20 w-14 h-14 bg-gray-900 text-white text-3xl font-bold rounded-full border border-gray-800 flex items-center justify-center">&times;</button>
            </div>

            <!-- Map Modal -->
            <div id="map-modal-wrapper" class="modal-wrapper hidden absolute inset-0 z-50">
                <div class="h-full w-full bg-gray-900 flex flex-col">
                    <div class="h-1/2 w-full flex flex-col items-center justify-center text-center text-white p-4 relative">
                        <div class="flex items-center justify-center gap-2 mb-2">
                            <h3 id="map-item-title" class="text-xl font-bold"></h3>
                            <span id="map-item-owned" class="bg-gray-600 text-white text-xs font-bold px-2 py-1 rounded-md">x0</span>
                        </div>
                        <p id="map-item-description" class="text-sm text-gray-300"></p>
                        <button id="buy-map-item-btn" class="absolute top-4 right-4 bg-gray-800 text-white font-bold w-auto h-12 px-4 flex items-center justify-center rounded-md border border-gray-700 text-lg">
                            0üåô
                        </button>
                    </div>
                    <div id="map-carousel" class="shop-carousel h-1/2 w-full flex items-center overflow-x-auto scrollbar-hide">
                        <div class="flex space-x-4 px-[calc(50%-3.5rem)]">
                            <div class="shop-item map-item flex-shrink-0 w-28 h-28 rounded-lg flex items-center justify-center text-5xl select-none" data-index="0">‚ò†Ô∏è</div>
                            <div class="shop-item map-item flex-shrink-0 w-28 h-28 rounded-lg flex items-center justify-center text-5xl select-none" data-index="1">üïØÔ∏è</div>
                            <div class="shop-item map-item flex-shrink-0 w-28 h-28 rounded-lg flex items-center justify-center text-5xl select-none" data-index="2">üêå</div>
                            <div class="shop-item map-item flex-shrink-0 w-28 h-28 rounded-lg flex items-center justify-center text-5xl select-none" data-index="3">‚ùáÔ∏è</div>
                            <div class="shop-item map-item flex-shrink-0 w-28 h-28 rounded-lg flex items-center justify-center text-5xl select-none" data-index="4">üåü</div>
                            <div class="shop-item map-item flex-shrink-0 w-28 h-28 rounded-lg flex items-center justify-center text-5xl select-none" data-index="5">‚ö°</div>
                        </div>
                    </div>
                </div>
                <button class="close-modal-btn absolute left-1/2 -translate-x-1/2 -top-20 w-14 h-14 bg-gray-900 text-white text-3xl font-bold rounded-full border border-gray-800 flex items-center justify-center">&times;</button>
            </div>

            <!-- Fortunes Modal -->
            <div id="equip-modal-wrapper" class="modal-wrapper hidden absolute inset-0 z-50">
                <div class="h-full w-full bg-gray-900 p-4 text-white flex flex-col justify-center">
                    <h2 id="fortune-modal-title" class="text-xl font-bold mb-4 text-center">Choose a Sacrifice</h2>
                    <div id="sacrifices-container" class="flex justify-around items-start text-center">
                    </div>
                    <div id="fortunes-container" class="hidden flex justify-around items-stretch text-center gap-2">
                    </div>
                </div>
                <button class="close-modal-btn absolute left-1/2 -translate-x-1/2 -top-20 w-14 h-14 bg-gray-900 text-white text-3xl font-bold rounded-full border border-gray-800 flex items-center justify-center">&times;</button>
            </div>

            <!-- Spells Modal -->
            <div id="quests-modal-wrapper" class="modal-wrapper hidden absolute inset-0 z-50">
                <div class="h-full w-full bg-gray-900 p-4 text-white flex flex-col justify-around">
                    <div class="flex items-center gap-2 px-4">
                        <span class="text-2xl w-10 text-center">‚ú®</span>
                        <div class="relative w-full bg-gray-800 rounded-full h-4 border border-gray-700">
                            <div id="magic-bar" class="bg-gray-200 h-full rounded-full" style="width: 100%"></div>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <span id="magic-text" class="text-xs font-bold text-black">10/10</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-around items-start text-center">
                        <button data-spell="flameheart" class="w-1/3 flex flex-col items-center gap-1 p-2 rounded-lg">
                            <div class="text-6xl">‚ù§Ô∏è‚Äçüî•</div>
                            <h3 class="font-bold text-base">Flameheart</h3>
                            <p class="text-[11px] text-gray-300">Deal 5 damage and heal 5 HP.</p>
                        </button>
                        <button data-spell="frostbite" class="w-1/3 flex flex-col items-center gap-1 p-2 rounded-lg">
                            <div class="text-6xl">‚ùÑÔ∏è</div>
                            <h3 class="font-bold text-base">Frostbite</h3>
                            <p class="text-[11px] text-gray-300">Deal 5 damage & inflict üêå Sluggish.</p>
                        </button>
                        <button data-spell="armorheart" class="w-1/3 flex flex-col items-center gap-1 p-2 rounded-lg">
                            <div class="text-6xl">ü©∂</div>
                            <h3 class="font-bold text-base">Armorheart</h3>
                            <p class="text-[11px] text-gray-300">Add current health to armor.</p>
                        </button>
                    </div>
                </div>
                <button class="close-modal-btn absolute left-1/2 -translate-x-1/2 -top-20 w-14 h-14 bg-gray-900 text-white text-3xl font-bold rounded-full border border-gray-800 flex items-center justify-center">&times;</button>
            </div>

            <!-- Equipment Modal -->
            <div id="system-modal-wrapper" class="modal-wrapper hidden absolute inset-0 z-50">
                <div class="h-full w-full bg-gray-900 p-4 text-white flex flex-col text-center">
                    <div class="flex-grow flex flex-col justify-around">
                        <div class="grid grid-cols-3 gap-4 items-center">
                            <button data-target="weapon-choices" class="equip-slot-btn focus:outline-none group p-2 rounded-lg focus:bg-gray-700">
                                <div class="text-5xl truncate">‚öîÔ∏è</div>
                                <div class="font-bold text-sm truncate">Weapon</div>
                            </button>
                            <button data-target="armor-choices" class="equip-slot-btn focus:outline-none group p-2 rounded-lg focus:bg-gray-700">
                                <div class="text-5xl truncate">üõ°Ô∏è</div>
                                <div class="font-bold text-sm truncate">Armor</div>
                            </button>
                            <button data-target="ring-choices" class="equip-slot-btn focus:outline-none group p-2 rounded-lg focus:bg-gray-700">
                                <div class="text-5xl truncate">üíç</div>
                                <div class="font-bold text-sm truncate">Ring</div>
                            </button>
                        </div>
                        <div class="relative min-h-[84px]">
                            <div id="weapon-choices" class="equip-choices flex flex-col space-y-1 hidden">
                                <button data-emoji="üèπ" data-title="Bow" data-stat-type="attack" data-stat-value="1" class="w-full text-center py-1 px-2 bg-gray-800 rounded-lg focus:bg-gray-600 focus:outline-none">üèπ Bow (+1 üí•)</button>
                                <button data-emoji="üó°Ô∏è" data-title="Dagger" data-stat-type="attack" data-stat-value="2" class="w-full text-center py-1 px-2 bg-gray-800 rounded-lg focus:bg-gray-600 focus:outline-none">üó°Ô∏è Dagger (+2 üí•)</button>
                                <button data-emoji="üî®" data-title="Hammer" data-stat-type="attack" data-stat-value="5" class="w-full text-center py-1 px-2 bg-gray-800 rounded-lg focus:bg-gray-600 focus:outline-none">üî® Hammer (+5 üí•)</button>
                            </div>
                            <div id="armor-choices" class="equip-choices flex flex-col space-y-1 hidden">
                                <button data-emoji="üß•" data-title="Leather Gear" data-stat-type="special" data-stat-value="admirers" class="w-full text-center py-1 px-2 bg-gray-800 rounded-lg focus:bg-gray-600 focus:outline-none">üß• Leather Gear (Gain Admirers)</button>
                                <button data-emoji="ü™®" data-title="Rock Bracer" data-stat-type="armor" data-stat-value="4" class="w-full text-center py-1 px-2 bg-gray-800 rounded-lg focus:bg-gray-600 focus:outline-none">ü™® Rock Bracer (+4 üõ°Ô∏è)</button>
                                <button data-emoji="üï∏Ô∏è" data-title="Cloak" data-stat-type="luck" data-stat-value="15" class="w-full text-center py-1 px-2 bg-gray-800 rounded-lg focus:bg-gray-600 focus:outline-none">üï∏Ô∏è Cloak (+15% üçÄ)</button>
                            </div>
                            <div id="ring-choices" class="equip-choices flex flex-col space-y-1 hidden">
                                 <button data-emoji="üíç" data-title="Eccentric Jewel" data-stat-type="none" data-stat-value="0" class="w-full text-center py-1 px-2 bg-gray-800 rounded-lg focus:bg-gray-600 focus:outline-none">üíç Eccentric Jewel</button>
                                 <button id="ring-slot-2" class="w-full text-center py-1 px-2 bg-gray-800 rounded-lg opacity-50 cursor-not-allowed">-</button>
                                 <button class="w-full text-center py-1 px-2 bg-gray-800 rounded-lg opacity-50 cursor-not-allowed">-</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="close-modal-btn absolute left-1/2 -translate-x-1/2 -top-20 w-14 h-14 bg-gray-900 text-white text-3xl font-bold rounded-full border border-gray-800 flex items-center justify-center">&times;</button>
            </div>
        </div>

        <!-- Tutorial Modal -->
        <div id="tutorial-modal-wrapper" class="modal-wrapper hidden absolute inset-0 z-[60] p-4">
            <div class="h-full w-full bg-gray-900 rounded-lg border border-gray-800 flex flex-col items-center justify-center text-white relative">
                <h2 class="text-3xl font-bold mb-4">How to Play</h2>
                <div class="p-4 text-center">
                    <h3 class="font-bold text-xl mb-2 text-gray-300">Notes</h3>
                    <p class="text-base text-gray-300">Enemies are either animal-like or human-like.</p>
                </div>
                 <button id="tutorial-close-btn" class="absolute top-4 right-4 text-gray-400 text-4xl font-bold">&times;</button>
            </div>
        </div>

        <!-- Character Modal -->
        <div id="world-map-modal-wrapper" class="modal-wrapper hidden absolute inset-0 z-50">
            <div class="h-full w-full flex flex-col text-white bg-gray-900">
                <div class="h-1/2 w-full bg-gray-800 p-4 relative flex flex-col justify-center">
                    <div class="space-y-4 text-lg">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-300 w-28">Luck:</span>
                            <span id="player-luck-stat" class="font-medium">üçÄ 0%</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-300 w-28">Wave Record:</span>
                            <span class="font-medium">0</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-300 w-28">Unlocks:</span>
                            <div class="flex gap-2 text-2xl">
                                <span>‚ùì</span>
                                <span>‚ùì</span>
                                <span>‚ùì</span>
                                <span>‚ùì</span>
                            </div>
                        </div>
                    </div>
                    <button id="tutorial-open-btn" class="absolute bottom-4 right-4 text-3xl bg-gray-600 border border-gray-500 text-white w-12 h-12 rounded-full flex items-center justify-center">‚ùî</button>
                </div>
                 <div class="h-1/2 w-full border-t border-gray-800 bg-gray-900 flex flex-col justify-start items-center text-center p-4">
                    <h3 class="text-xl font-bold mb-4 text-gray-300">Collected Fortunes</h3>
                    <div id="collected-fortunes-container" class="grid grid-cols-3 gap-2 w-full">
                    </div>
                </div>
            </div>
            <button class="close-modal-btn absolute top-4 right-6 text-gray-400 text-5xl font-bold">&times;</button>
        </div>

        <!-- REWARD MODAL -->
        <div id="reward-modal" class="hidden absolute inset-0 bg-black/70 z-50 flex items-center justify-center p-8">
            <div id="reward-container" class="bg-gray-900 border border-gray-700 rounded-2xl p-6 w-full max-w-xs text-center text-white flex flex-col items-center gap-4">
                <h2 class="text-2xl font-bold text-gray-200">You got a reward!</h2>
                <div id="reward-display" class="text-7xl h-24 w-24 flex items-center justify-center overflow-hidden">
                    <span>‚ùî</span>
                </div>
                <p id="reward-text" class="text-xl font-bold h-7"></p>
                <div id="reward-action" class="h-14 w-full">
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // PLAYER STATS
            let player = {
                maxHp: 10,
                currentHp: 10,
                luck: 10, 
                gold: 99,
                baseAttack: 8,
                attackBonus: 0,
                maxBaseArmor: 2,
                baseArmor: 2,
                armorBonus: 0, // This is the dynamic total, including temporary spell effects
                equippedArmorBonus: 0, // Stores the persistent bonus from equipped armor
                maxMp: 10,
                currentMp: 10,
                moons: 3, // Moons for special arts
                statusEffects: [], // Handles active player buffs/debuffs
                activeFortunes: [], // FORTUNE: To track acquired fortune titles
                activeSacrifices: [], // To track which sacrifices are active
                disabledSpells: [], // To track disabled spells like from Heartbreak
                specialArmor: null, 
                equippedRing: null,
            };

            // GAME STATE
            let wave = 1;
            let spinsRemaining = 5;
            let actionsTakenThisTurn = 0;
            let isGamePaused = false;

            // UI ELEMENTS
            const hpBar = document.getElementById('hp-bar');
            const hpText = document.getElementById('hp-text');
            const playerGoldEl = document.getElementById('player-gold');
            const attackPowerEl = document.getElementById('attack-power');
            const playerArmorEl = document.getElementById('player-armor');
            const topStatusBar = document.getElementById('top-status-bar');
            const playerLuckStatEl = document.getElementById('player-luck-stat');
            const playerArmorContainer = document.getElementById('player-armor-container');
            const playerHpContainer = document.getElementById('player-hp-container');
            const buyMapItemBtn = document.getElementById('buy-map-item-btn');
            const magicBar = document.getElementById('magic-bar');
            const magicText = document.getElementById('magic-text');
            const spellButtons = document.querySelectorAll('#quests-modal-wrapper button:not(.close-modal-btn)');
            const waveNumberEl = document.getElementById('wave-number');
            const spinCounterEl = document.getElementById('spin-counter');

            // NEW: Helper function to check for active enemies
            function areEnemiesActive() {
                return currentEnemies.some(enemy => enemy && !enemy.isDefeated);
            }

            // Helper for visual effect popups (like sluggish, poison damage, etc.)
            function createEffectPopup(text, color, targetElement) {
                const popup = document.createElement('div');
                popup.textContent = text;
                popup.className = 'damage-popup';
                popup.style.color = color;
                popup.style.fontSize = '2rem';
                targetElement.appendChild(popup);
                popup.addEventListener('animationend', () => popup.remove());
            }

            function updatePlayerUI() {
                hpText.textContent = `${player.currentHp}/${player.maxHp}`;
                hpBar.style.width = `${(player.currentHp / player.maxHp) * 100}%`;
                playerGoldEl.textContent = player.gold;
                attackPowerEl.textContent = player.baseAttack + player.attackBonus;
                playerArmorEl.textContent = player.baseArmor + player.armorBonus;
                if (playerLuckStatEl) {
                    playerLuckStatEl.textContent = `üçÄ ${player.luck}%`;
                }
            }
            
            function updateMoonModalUI() {
                if (buyMapItemBtn) {
                    buyMapItemBtn.innerHTML = `${player.moons}üåô`;
                    if (player.moons > 0) {
                        buyMapItemBtn.disabled = false;
                        buyMapItemBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        buyMapItemBtn.disabled = true;
                        buyMapItemBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            }

            function updateMagicUI() {
                if (magicBar && magicText) {
                    magicText.textContent = `${player.currentMp}/${player.maxMp}`;
                    magicBar.style.width = `${(player.currentMp / player.maxMp) * 100}%`;

                    // FORTUNE CHANGE: Calculate spell cost based on 'Efficient Magic' fortune
                    const spellCost = player.activeFortunes.includes('Efficient Magic') ? 2 : 4;

                    spellButtons.forEach(button => {
                        // New check for disabled spells
                        if (player.disabledSpells.includes(button.dataset.spell)) {
                            button.disabled = true;
                            button.classList.add('opacity-50', 'cursor-not-allowed');
                            return; // Use return instead of continue in forEach callback
                        }

                        if (player.currentMp < spellCost) { // Use dynamic spellCost
                            button.disabled = true;
                            button.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            button.disabled = false;
                            button.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    });
                }
            }

            function updateWaveUI() {
                if (waveNumberEl && spinCounterEl) {
                    waveNumberEl.textContent = wave;
                    spinCounterEl.textContent = spinsRemaining;
                }
            }

            // MODAL LOGIC
            const modalButtons = document.querySelectorAll('[data-modal-target]');
            const closeButtons = document.querySelectorAll('.close-modal-btn');
            const buttonGrid = document.getElementById('button-grid');
            const allModals = document.querySelectorAll('.modal-wrapper');
            const rewardModal = document.getElementById('reward-modal');
            
            const openModal = (modal) => {
                if (modal == null) return;
                buttonGrid.classList.add('hidden');
                modal.classList.remove('hidden');
                
                if (modal.id === 'items-modal-wrapper') {
                    renderShop();
                } else if (modal.id === 'map-modal-wrapper') {
                    mapCarousel.scrollLeft = 0;
                    updateMapSelection();
                    updateMoonModalUI();
                } else if (modal.id === 'equip-modal-wrapper') {
                    initializeFortuneSelection();
                } else if (modal.id === 'quests-modal-wrapper') {
                    updateMagicUI();
                }
            }

            const closeModal = () => {
                allModals.forEach(modal => {
                    if (!modal.classList.contains('hidden')) {
                        modal.classList.add('hidden');
                    }
                });
                buttonGrid.classList.remove('hidden');
            }

            modalButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const modal = document.getElementById(button.dataset.modalTarget);
                    openModal(modal);
                });
            });

            closeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    closeModal();
                });
            });

            // SHOP LOGIC
            const shopItems = [
                { emoji: 'üç∂', title: 'Tonic', description: 'Restores 6 HP.', owned: 0, cost: 5 },
                { emoji: '‚úùÔ∏è', title: 'Cross', description: 'Cures curse, +1 max HP.', owned: 0, cost: 10 },
                { emoji: 'üíé', title: 'Gem', description: 'Gain a buff, give a debuff.', owned: 0, cost: 15 },
                { emoji: 'üßöüèº', title: 'Fairy', description: 'Restores magic meter.', owned: 0, cost: 15 },
                { emoji: 'üåô', title: 'Moonstone', description: 'Grants 1 Moon to spend.', owned: 0, cost: 20 },
                { emoji: '‚ôæÔ∏è', title: 'Infinity Ring', description: '+2 Spins.', owned: 0, cost: 25, purchased: false },
            ];
            const shopListContainer = document.getElementById('shop-list-container');

            function renderShop() {
                if (!shopListContainer) return;
                shopListContainer.innerHTML = ''; // Clear existing items

                shopItems.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'flex items-center justify-between bg-gray-800 p-2 rounded-lg text-white';

                    const hasBarteringEdge = player.activeFortunes.includes('Bartering Edge');
                    const currentCost = hasBarteringEdge ? Math.floor(item.cost * 0.75) : item.cost;

                    let isUsable = false;
                    if (item.owned > 0) {
                        switch (item.title) {
                            case 'Tonic': isUsable = player.currentHp < player.maxHp; break;
                            case 'Cross': isUsable = player.statusEffects.includes('curse'); break;
                            case 'Fairy': isUsable = player.currentMp < player.maxMp; break;
                            case 'Gem': isUsable = true; break;
                            default: isUsable = false; break;
                        }
                    }

                    itemEl.innerHTML = `
                        <div class="flex items-center gap-3 flex-1">
                            <span class="text-4xl">${item.emoji}</span>
                            <div class="flex-1">
                                <h4 class="font-bold text-white">${item.title} <span class="text-gray-400 font-normal">(x${item.owned})</span></h4>
                                <p class="text-xs text-gray-400">${item.description}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button data-use-index="${index}" class="use-item-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md text-sm ${!isUsable ? 'opacity-50 cursor-not-allowed' : ''}" ${!isUsable ? 'disabled' : ''}>Use</button>
                            <button data-buy-index="${index}" class="buy-item-btn bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md text-sm ${item.purchased || player.gold < currentCost ? 'opacity-50 cursor-not-allowed' : ''}" ${item.purchased || player.gold < currentCost ? 'disabled' : ''}>
                                ${item.purchased ? 'Owned' : `${currentCost} <span class="opacity-75">ü™ô</span>`}
                            </button>
                        </div>
                    `;

                    shopListContainer.appendChild(itemEl);
                });

                // Add event listeners after rendering
                shopListContainer.querySelectorAll('.use-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemIndex = parseInt(e.currentTarget.dataset.useIndex, 10);
                        useItem(itemIndex);
                    });
                });

                shopListContainer.querySelectorAll('.buy-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemIndex = parseInt(e.currentTarget.dataset.buyIndex, 10);
                        const itemToBuy = shopItems[itemIndex];
                        const hasBarteringEdge = player.activeFortunes.includes('Bartering Edge');
                        const currentCost = hasBarteringEdge ? Math.floor(itemToBuy.cost * 0.75) : itemToBuy.cost;

                        if (!itemToBuy.purchased && player.gold >= currentCost) {
                            player.gold -= currentCost;
                            itemToBuy.owned++;
                            if (itemToBuy.title === 'Infinity Ring') {
                                itemToBuy.purchased = true;
                                unlockInfinityRing();
                            }
                            if (itemToBuy.title === 'Moonstone') {
                                player.moons++;
                                updateMoonModalUI();
                            }
                            updatePlayerUI();
                            renderShop(); // Re-render to update UI
                        }
                    });
                });
            }

            // FORTUNE HELPER: Check for Battle Grace when receiving a buff
            function checkForBattleGrace() {
                if (player.activeFortunes.includes('Battle Grace')) {
                    player.maxBaseArmor++;
                    player.baseArmor++;
                    console.log("Battle Grace triggered! +1 Armor.");
                    updatePlayerUI();
                }
            }

            function useItem(itemIndex) {
                const itemData = shopItems[itemIndex];
                let itemUsed = false;

                switch (itemData.title) {
                    case 'Tonic':
                        if (player.currentHp < player.maxHp) {
                            const healAmount = 6;
                            player.currentHp = Math.min(player.maxHp, player.currentHp + healAmount);
                            itemUsed = true;

                            // --- UNSTABLE MIND SACRIFICE ---
                            if (player.activeSacrifices.includes('UNSTABLE MIND')) {
                                const livingEnemies = currentEnemies.filter(e => e && !e.isDefeated);
                                if (livingEnemies.length > 0) {
                                    let maxHpLost = -1;
                                    // First, find the maximum amount of HP any enemy has lost.
                                    livingEnemies.forEach(enemy => {
                                        const hpLost = enemy.maxHealth - enemy.currentHealth;
                                        if (hpLost > maxHpLost) {
                                            maxHpLost = hpLost;
                                        }
                                    });

                                    // If at least one enemy has lost health...
                                    if (maxHpLost > 0) {
                                        // Find all enemies who are tied for having lost the most health.
                                        const mostInjuredEnemies = livingEnemies.filter(enemy => (enemy.maxHealth - enemy.currentHealth) === maxHpLost);
                                        
                                        // Pick one of the most injured enemies to heal (randomly if there's a tie).
                                        const targetEnemy = mostInjuredEnemies[Math.floor(Math.random() * mostInjuredEnemies.length)];
                                        const enemyIndex = currentEnemies.indexOf(targetEnemy);
                                        
                                        console.log(`Unstable Mind heals ${targetEnemy.name} for ${healAmount}`);
                                        targetEnemy.currentHealth = Math.min(targetEnemy.maxHealth, targetEnemy.currentHealth + healAmount);
                                        
                                        // Update enemy UI
                                        const enemyInfo = document.getElementById(`enemy-info-${enemyIndex + 1}`);
                                        if (enemyInfo) {
                                            const healthBar = enemyInfo.querySelector('.health-bar');
                                            const healthText = document.getElementById(`health-text-${enemyIndex + 1}`);
                                            const healthPercent = (targetEnemy.currentHealth / targetEnemy.maxHealth) * 100;
                                            healthBar.style.width = `${healthPercent}%`;
                                            healthText.textContent = `${targetEnemy.currentHealth}/${targetEnemy.maxHealth}`;
                                            createEffectPopup(`+${healAmount}`, '#9ca3af', reels[enemyIndex]); // gray-400
                                        }
                                    }
                                }
                            }
                        }
                        break;
                    case 'Cross':
                        if (player.statusEffects.includes('curse')) {
                            player.statusEffects = player.statusEffects.filter(e => e !== 'curse');
                            player.maxHp += 1;
                            player.currentHp += 1;
                            itemUsed = true;
                        }
                        break;
                    case 'Gem':
                        const buffs = ['rush', 'regen', 'blessing'];
                        const randomBuff = buffs[Math.floor(Math.random() * buffs.length)];
                        if (!player.statusEffects.includes(randomBuff)) {
                            player.statusEffects.push(randomBuff);
                            checkForBattleGrace(); // FORTUNE: Check for Battle Grace
                        }

                        const livingEnemies = currentEnemies.filter(e => e && !e.isDefeated);
                        if (livingEnemies.length > 0) {
                            const randomEnemy = livingEnemies[Math.floor(Math.random() * livingEnemies.length)];
                            const debuffs = ['sluggish', 'curse', 'poison'];
                            const randomDebuff = debuffs[Math.floor(Math.random() * debuffs.length)];
                            if (!randomEnemy.statusEffects.includes(randomDebuff)) {
                                randomEnemy.statusEffects.push(randomDebuff);
                                const enemyIndex = currentEnemies.indexOf(randomEnemy);
                                checkForTorment(randomEnemy, enemyIndex); // FORTUNE: Check for Torment
                            }
                        }
                        itemUsed = true;
                        break;
                    case 'Fairy':
                        if (player.currentMp < player.maxMp) {
                            player.currentMp = player.maxMp;
                            itemUsed = true;
                            // --- ENCHANTMENT FORTUNE ---
                            if (player.activeFortunes.includes('Enchantment')) {
                                if (!player.statusEffects.includes('regen')) {
                                    player.statusEffects.push('regen');
                                    console.log("Enchantment triggered! Gained Regen.");
                                    checkForBattleGrace(); // A buff was granted
                                }
                            }
                        }
                        break;
                }

                if (itemUsed) {
                    console.log(`Used ${itemData.title}.`);
                    itemData.owned--;
                    updatePlayerUI();
                    updateMagicUI();
                    updateAllStatusIcons();
                    renderShop();
                } else {
                    console.log(`Could not use ${itemData.title}. Conditions not met.`);
                }
            }

            // MAP CAROUSEL LOGIC / STATUS EFFECTS
            const moonArts = [
                { id: 'poison', title: 'Poison', description: 'Deals damage each turn.', owned: 0, type: 'debuff' },
                { id: 'curse', title: 'Curse', description: 'Share damage.', owned: 0, type: 'debuff' },
                { id: 'sluggish', title: 'Sluggish', description: '50% chance to miss turn.', owned: 0, type: 'debuff' },
                { id: 'regen', title: 'Regen', description: 'Heal 1 HP per turn.', owned: 0, type: 'buff' },
                { id: 'blessing', title: 'Blessing', description: 'Add current armor to attack.', owned: 0, type: 'buff' },
                { id: 'rush', title: 'Rush', description: '2 actions per turn.', owned: 0, type: 'buff' }
            ];
            const mapCarousel = document.getElementById('map-carousel');
            const mapCarouselItems = mapCarousel.querySelectorAll('.map-item');
            const mapItemTitle = document.getElementById('map-item-title');
            const mapItemDescription = document.getElementById('map-item-description');
            const mapItemOwned = document.getElementById('map-item-owned');
            let currentMapIndex = 0;

            let isMapDown = false, mapStartX, mapScrollLeft;
            
            function checkForTorment(enemy, enemyIndex) {
                if (player.activeFortunes.includes('Torment')) {
                    if (enemy && !enemy.isDefeated) {
                        console.log(`Torment triggered on ${enemy.name}!`);
                        applyDamageAndAnimate(enemyIndex, 2);
                    }
                }
            }
            
            function updateAllStatusIcons() {
                const playerStatusContainer = document.getElementById('player-status-effects');
                const allPlayerStatusElements = { poison: document.getElementById('player-status-poison'), curse: document.getElementById('player-status-curse'), sluggish: document.getElementById('player-status-sluggish'), regen: document.getElementById('player-status-regen'), blessing: document.getElementById('player-status-blessing'), rush: document.getElementById('player-status-rush') };
                for (const id in allPlayerStatusElements) { if (allPlayerStatusElements[id]) allPlayerStatusElements[id].style.display = 'none'; }
                const orderedPlayerActiveIds = moonArts.map(art => art.id).filter(id => player.statusEffects.includes(id));
                orderedPlayerActiveIds.forEach(id => { const span = allPlayerStatusElements[id]; if (span) { span.style.display = 'inline'; playerStatusContainer.appendChild(span); } });

                const allEnemyStatusIds = ['poison', 'curse', 'sluggish', 'regen'];
                for (let i = 1; i <= 3; i++) {
                    const enemy = currentEnemies[i - 1];
                    const reelElement = document.getElementById(`reel${i}`);
                    if (!reelElement) continue;
                    const enemyStatusContainer = reelElement.parentElement.querySelector('.h-4');
                    if(!enemyStatusContainer) continue;
                    const allEnemySpansForSlot = { poison: document.querySelector(`.enemy-${i}-status-poison`), curse: document.querySelector(`.enemy-${i}-status-curse`), sluggish: document.querySelector(`.enemy-${i}-status-sluggish`), regen: document.querySelector(`.enemy-${i}-status-regen`) };
                    for (const id in allEnemySpansForSlot) { if (allEnemySpansForSlot[id]) allEnemySpansForSlot[id].style.display = 'none'; }
                    if (enemy && !enemy.isDefeated) {
                        const orderedEnemyActiveIds = allEnemyStatusIds.filter(id => enemy.statusEffects.includes(id));
                        orderedEnemyActiveIds.forEach(id => { const span = allEnemySpansForSlot[id]; if (span) { span.style.display = 'inline'; enemyStatusContainer.appendChild(span); } });
                    }
                }
            }

            mapCarouselItems.forEach(item => {
                item.addEventListener('click', () => {
                    const itemIndex = parseInt(item.dataset.index, 10);
                    const selectedArt = moonArts[itemIndex];
                    if (itemIndex !== currentMapIndex) { const targetScroll = item.offsetLeft - (mapCarousel.offsetWidth / 2) + (item.offsetWidth / 2); mapCarousel.scrollTo({ left: targetScroll, behavior: 'auto' }); return; }
                    if (selectedArt.owned > 0) {
                        if (!areEnemiesActive()) { console.log("Cannot use Moon Arts without active enemies."); return; }
                        selectedArt.owned--;
                        closeModal();
                        reels.forEach(r => r.disabled = true);
                        if (selectedArt.type === 'buff') { if (!player.statusEffects.includes(selectedArt.id)) { player.statusEffects.push(selectedArt.id); checkForBattleGrace(); }
                        } else if (selectedArt.type === 'debuff') { currentEnemies.forEach((enemy, index) => { if (enemy && !enemy.isDefeated && !enemy.statusEffects.includes(selectedArt.id)) { enemy.statusEffects.push(selectedArt.id); checkForTorment(enemy, index); } }); }
                        console.log(`Used ${selectedArt.title}. Remaining: ${selectedArt.owned}`);
                        updateAllStatusIcons();
                        startEnemyTurn();
                    }
                });
            });

            const startMapDragging = (e) => { isMapDown = true; mapStartX = (e.pageX || e.touches[0].pageX) - mapCarousel.offsetLeft; mapScrollLeft = mapCarousel.scrollLeft; };
            const stopMapDragging = () => { isMapDown = false; };
            const dragMap = (e) => { if (!isMapDown) return; e.preventDefault(); const x = (e.pageX || e.touches[0].pageX) - mapCarousel.offsetLeft; const walk = (x - mapStartX); mapCarousel.scrollLeft = mapScrollLeft - walk; };
            if (mapCarousel) { mapCarousel.addEventListener('mousedown', startMapDragging); mapCarousel.addEventListener('touchstart', startMapDragging); mapCarousel.addEventListener('mouseleave', stopMapDragging); mapCarousel.addEventListener('mouseup', stopMapDragging); mapCarousel.addEventListener('touchend', stopMapDragging); mapCarousel.addEventListener('mousemove', dragMap); mapCarousel.addEventListener('touchmove', dragMap); }

            let mapScrollTimeout;
            const updateMapSelection = () => {
                clearTimeout(mapScrollTimeout);
                mapScrollTimeout = setTimeout(() => {
                    const carouselCenter = mapCarousel.offsetWidth / 2;
                    let closestItem = null;
                    let smallestDistance = Infinity;
                    mapCarouselItems.forEach(item => { const itemRect = item.getBoundingClientRect(); const carouselRect = mapCarousel.getBoundingClientRect(); const itemCenter = (itemRect.left - carouselRect.left) + (itemRect.width / 2); const distance = Math.abs(carouselCenter - itemCenter); if (distance < smallestDistance) { smallestDistance = distance; closestItem = item; } });
                    if (closestItem) {
                        const itemIndex = parseInt(closestItem.dataset.index);
                        currentMapIndex = itemIndex;
                        const selectedItemData = moonArts[itemIndex];
                        mapItemTitle.textContent = selectedItemData.title;
                        mapItemDescription.textContent = selectedItemData.description;
                        mapItemOwned.textContent = `x${selectedItemData.owned}`;
                        if (selectedItemData.owned > 0) { closestItem.classList.add('cursor-pointer'); } else { closestItem.classList.remove('cursor-pointer'); }
                    }
                }, 50);
            };
            if (mapCarousel) mapCarousel.addEventListener('scroll', updateMapSelection);

            buyMapItemBtn.addEventListener('click', () => {
                if (player.moons >= 1) {
                    player.moons--;
                    const selectedItemIndex = parseInt(mapCarousel.querySelector('.shop-item').dataset.index); // Simplified selection
                    const purchasedArt = moonArts[selectedItemIndex];
                    const hasDoubleMoon = player.activeFortunes.includes('Double Moon');
                    purchasedArt.owned += hasDoubleMoon ? 2 : 1;
                    console.log(`Purchased ${purchasedArt.title}. You have ${player.moons} moons left.`);
                    updateMoonModalUI();
                    updateMapSelection();
                }
            });

            // SPELLS MODAL LOGIC
            spellButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.disabled) return;
                    if (!areEnemiesActive()) { console.log("Cannot cast spells without active enemies."); return; }
                    const spellCost = player.activeFortunes.includes('Efficient Magic') ? 2 : 4;
                    if (player.currentMp >= spellCost) {
                        player.currentMp -= spellCost;
                        updateMagicUI();
                        const spellName = button.dataset.spell;
                        castSpell(spellName);
                    }
                });
            });
            
            // FORTUNE MODAL LOGIC
            const fortuneModalTitle = document.getElementById('fortune-modal-title');
            const sacrificesContainer = document.getElementById('sacrifices-container');
            const fortunesContainer = document.getElementById('fortunes-container');
            let usedSacrifices = [], usedFortunes = [], currentSacrifice = null;
            const allSacrifices = [ { emoji: 'ü©∏', title: 'BLOOD PACT', description: '-3 Max HP.' }, { emoji: 'ü¶∂', title: 'BROKEN ANKLE', description: '-10% üçÄ.' }, { emoji: 'üíî', title: 'HEARTBREAK', description: 'Lose ‚ù§Ô∏è‚Äçüî• or ü©∂.' }, { emoji: 'üìú', title: 'GAMBLING DEBT', description: '-30 Gold.' }, { emoji: 'ü´¥', title: 'CLUMSY', description: 'Lose 1 üåô.' }, { emoji: 'üé≠', title: 'UNSTABLE MIND', description: 'Share üç∂.' } ];
            const allFortunes = [ { title: 'Double Moon', description: 'üåô Gives 2 uses.', color: 'blue' }, { title: 'Efficient Magic', description: 'Spells use 50% less MP.', color: 'blue' }, { title: 'Bartering Edge', description: '25% shop discount.', color: 'blue' }, { title: 'Archer\'s Edge', description: 'Attacks all with üèπ.', color: 'yellow' }, { title: 'Enchantment', description: 'Using üßöüèº grants ‚ùáÔ∏è.', color: 'yellow' }, { title: 'Battle Grace', description: 'Receive buff = +1 üõ°Ô∏è.', color: 'yellow' }, { title: 'Torment', description: 'Applying debuffs also deals 2 damage.', color: 'pink' }, { title: 'Thief Strike', description: 'Steal 5 ü™ô when attacking with üó°Ô∏è.', color: 'pink' }, { title: 'Toxic Decay', description: '+2 ‚ò†Ô∏è Damage.', color: 'pink' } ];
            function getRandomItems(arr, num) { return [...arr].sort(() => 0.5 - Math.random()).slice(0, num); }
            function getRandomFortuneByWeight(availableFortunes) { const weightedList = []; availableFortunes.forEach(fortune => { if (fortune.color === 'blue') { for (let i = 0; i < 40; i++) weightedList.push(fortune); } else if (fortune.color === 'yellow') { for (let i = 0; i < 30; i++) weightedList.push(fortune); } else if (fortune.color === 'pink') { for (let i = 0; i < 20; i++) weightedList.push(fortune); } }); if (weightedList.length === 0) return null; return weightedList[Math.floor(Math.random() * weightedList.length)]; }
            function acquireFortune(fortune) { console.log('Acquiring Fortune:', fortune.title); if (!player.activeFortunes.includes(fortune.title)) player.activeFortunes.push(fortune.title); if (collectedFortunes.length < 6) { collectedFortunes.push({ sacrifice: currentSacrifice, fortune: fortune }); usedFortunes.push(fortune.title); currentSacrifice = null; updateCollectedFortunesDisplay(); } else { console.log("Maximum fortunes collected."); } updateShopSelection(); updateMagicUI(); closeModal(); }
            function selectSacrifice() {
                sacrificesContainer.classList.add('hidden');
                fortunesContainer.classList.remove('hidden');
                fortuneModalTitle.textContent = 'Choose your Fortune';
                const availableFortunes = allFortunes.filter(f => !usedFortunes.includes(f.title));
                const chosenFortunes = new Set();
                if (availableFortunes.length <= 3) { availableFortunes.forEach(f => chosenFortunes.add(f)); } else { while (chosenFortunes.size < 3) { const newFortune = getRandomFortuneByWeight(availableFortunes); if (newFortune) chosenFortunes.add(newFortune); } }
                const randomFortunes = Array.from(chosenFortunes);
                fortunesContainer.innerHTML = ''; 
                randomFortunes.forEach((fortune, index) => {
                    const fortuneEl = document.createElement('button');
                    let borderColorClass = 'border-gray-700';
                    if (fortune.color === 'blue') borderColorClass = 'border-blue-500';
                    else if (fortune.color === 'yellow') borderColorClass = 'border-yellow-500';
                    else if (fortune.color === 'pink') borderColorClass = 'border-pink-500';
                    fortuneEl.className = `w-1/3 flex flex-col items-center justify-center gap-1 p-2 rounded-lg bg-gray-800 border ${borderColorClass}`;
                    fortuneEl.innerHTML = `<h3 class="font-bold text-sm text-center">${fortune.title}</h3><p class="text-[11px] text-gray-400 text-center">${fortune.description}</p>`;
                    fortuneEl.onclick = () => acquireFortune(fortune);
                    fortunesContainer.appendChild(fortuneEl);
                });
            }
            function initializeFortuneSelection() {
                fortuneModalTitle.textContent = 'Choose a Sacrifice';
                sacrificesContainer.classList.remove('hidden');
                fortunesContainer.classList.add('hidden');
                fortunesContainer.innerHTML = '';
                sacrificesContainer.innerHTML = '';
                const availableSacrifices = allSacrifices.filter(s => !usedSacrifices.includes(s.title));
                const randomSacrifices = getRandomItems(availableSacrifices, 3);
                randomSacrifices.forEach((sacrifice, index) => {
                    const sacrificeEl = document.createElement('button');
                    sacrificeEl.className = 'w-1/3 flex flex-col items-center gap-1 p-2 rounded-lg';
                    sacrificeEl.innerHTML = `<div class="text-5xl">${sacrifice.emoji}</div><h3 class="font-bold text-sm">${sacrifice.title}</h3><p class="text-[11px] text-gray-400">${sacrifice.description}</p>`;
                    sacrificeEl.onclick = () => { console.log('Sacrifice selected:', sacrifice.title); applySacrifice(sacrifice); currentSacrifice = sacrifice; usedSacrifices.push(sacrifice.title); selectSacrifice(); };
                    sacrificesContainer.appendChild(sacrificeEl);
                });
            }

            // GAME LOGIC
            const spinButton = document.getElementById('spin-button');
            const reels = [ document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3') ];
            const enemyInfoArea = document.getElementById('enemy-info-area');
            const skullMeterBar = document.getElementById('skull-meter-bar');
            const skullMeterText = document.getElementById('skull-meter-text');
            const skullMeterModal = document.getElementById('skull-meter-modal');
            const choiceHpButton = document.getElementById('choice-hp');
            const choiceLuckButton = document.getElementById('choice-luck');
            let skullCount = 0;
            let collectedFortunes = [];
            const collectedFortunesContainer = document.getElementById('collected-fortunes-container');

            function updateCollectedFortunesDisplay() {
                if (!collectedFortunesContainer) return;
                collectedFortunesContainer.innerHTML = '';
                for (let i = 0; i < 6; i++) {
                    const collection = collectedFortunes[i];
                    const slotEl = document.createElement('div');
                    if (collection) {
                        const fortune = collection.fortune;
                        const sacrifice = collection.sacrifice;
                        let borderColorClass = 'border-gray-600';
                        if (fortune.color === 'blue') borderColorClass = 'border-blue-500';
                        else if (fortune.color === 'yellow') borderColorClass = 'border-yellow-500';
                        else if (fortune.color === 'pink') borderColorClass = 'border-pink-500';
                        slotEl.className = `relative h-20 bg-gray-800 rounded-lg flex flex-col items-center justify-center text-center p-1 border ${borderColorClass}`;
                        slotEl.innerHTML = `<span class="font-bold text-[11px] leading-tight">${fortune.title}</span><span class="text-[10px] text-gray-400 leading-tight mt-1">${sacrifice.title}</span>`;
                    } else {
                        slotEl.className = 'h-20 bg-gray-800 rounded-lg flex items-center justify-center text-center p-1 border border-dashed border-gray-700';
                        slotEl.innerHTML = `<span class="text-3xl text-gray-700">?</span>`;
                    }
                    collectedFortunesContainer.appendChild(slotEl);
                }
            }
            const showSkullModal = () => skullMeterModal.classList.remove('hidden');
            const hideSkullModal = () => { skullMeterModal.classList.add('hidden'); skullCount = 0; skullMeterBar.style.width = '0%'; skullMeterText.textContent = '0/10'; };
            choiceHpButton.addEventListener('click', () => { player.maxHp += 1; player.currentHp += 1; updatePlayerUI(); console.log("Player chose +1 Max HP."); hideSkullModal(); });
            choiceLuckButton.addEventListener('click', () => { player.luck += 5; updatePlayerUI(); console.log("Player chose +5% Luck."); hideSkullModal(); });
            
            const enemies = [ { name: 'Wolf', emoji: 'üê∫', special: null, attack: 2, maxHealth: 13, class: 'animal' }, { name: 'Frog', emoji: 'üê∏', special: '‚ò†Ô∏è', attack: 1, maxHealth: 9, class: 'animal' }, { name: 'Unicorn', emoji: 'ü¶Ñ', special: '‚ùáÔ∏è', attack: 1, maxHealth: 14, class: 'animal' }, { name: 'Dragon', emoji: 'üê≤', special: null, attack: 3, maxHealth: 18, class: 'animal' }, { name: 'Serpent', emoji: 'üêç', special: '‚ò†Ô∏è', attack: 1, maxHealth: 9, class: 'animal' }, { name: 'Rat', emoji: 'üêÄ', special: null, attack: 1, maxHealth: 8, class: 'animal' }, { name: 'Crow', emoji: 'üê¶‚Äç‚¨õ', special: 'üïØÔ∏è', attack: 1, maxHealth: 9, class: 'animal' }, { name: 'Spider', emoji: 'üï∑Ô∏è', special: '‚ò†Ô∏è', attack: 1, maxHealth: 8, class: 'animal' }, { name: 'Scorpion', emoji: 'ü¶Ç', special: null, attack: 2, maxHealth: 10, class: 'animal' }, { name: 'Mosquito', emoji: 'ü¶ü', special: 'üêå', attack: 5, maxHealth: 5, class: 'animal' }, { name: 'Ghost', emoji: 'üëª', special: null, attack: 1, maxHealth: 20, class: 'human' }, { name: 'Zombie', emoji: 'üßü', special: 'üêå', attack: 1, maxHealth: 9, class: 'human' }, { name: 'Genie', emoji: 'üßû', special: '‚ùáÔ∏è', attack: 2, maxHealth: 12, class: 'human' }, { name: 'Troll', emoji: 'üßå', special: null, attack: 3, maxHealth: 12, class: 'human' }, { name: 'Ninja', emoji: 'ü•∑', special: 'ü´≥', attack: 2, maxHealth: 10, class: 'human' }, { name: 'Vampire', emoji: 'üßõ', special: 'üïØÔ∏è', attack: 2, maxHealth: 12, class: 'human' }, { name: 'Supervillain', emoji: 'ü¶π', special: null, attack: 6, maxHealth: 18, class: 'human' }, { name: 'Gift', emoji: 'üéÅ', special: 'üéâ', attack: 0, maxHealth: 1, class: 'human' } ];
            let currentEnemies = [];

            const displayEnemyInfo = (finalEnemies) => {
                finalEnemies.forEach((enemy, i) => {
                    let baseHealth = enemy.maxHealth || 10;
                    if (enemy.name !== 'Gift') baseHealth += (wave - 1);
                    enemy.maxHealth = baseHealth;
                    enemy.currentHealth = enemy.maxHealth;
                    enemy.isDefeated = false;
                    enemy.statusEffects = [];
                    enemy.specialUsed = false; 
                    if (enemy.special === '‚ùáÔ∏è') enemy.statusEffects.push('regen');
                    const enemyInfo = document.getElementById(`enemy-info-${i + 1}`);
                    enemyInfo.style.visibility = 'visible';
                    document.getElementById(`enemy-name-${i + 1}`).textContent = enemy.name;
                    enemyInfo.querySelector('.health-bar').style.width = '100%';
                    document.getElementById(`health-text-${i + 1}`).textContent = `${enemy.currentHealth}/${enemy.maxHealth}`;
                    const reel = document.getElementById(`reel${i + 1}`);
                    const attackValueEl = reel.querySelector('.attack-value');
                    const specialValueEl = reel.querySelector('.special-value');
                    if (attackValueEl) { attackValueEl.innerHTML = enemy.attack; attackValueEl.classList.remove('hidden'); }
                    if (specialValueEl && enemy.special) { specialValueEl.textContent = enemy.special; specialValueEl.classList.remove('hidden'); } else if (specialValueEl) { specialValueEl.classList.add('hidden'); }
                });
                enemyInfoArea.classList.remove('hidden');
                updateAllStatusIcons();
            };

            const showRewardModal = (reelIndex) => {
                isGamePaused = true;
                const rewards = [ { icon: '‚ù§Ô∏è', text: '+1 Max HP', type: 'hp', value: 1 }, { icon: 'üçÄ', text: '+3 Luck', type: 'luck', value: 3 }, { icon: 'üí∞', text: '+25 Gold', type: 'gold', value: 25 } ];
                const rewardDisplay = document.getElementById('reward-display');
                const rewardText = document.getElementById('reward-text');
                const rewardAction = document.getElementById('reward-action');

                rewardModal.classList.remove('hidden');
                
                const finalReward = rewards[Math.floor(Math.random() * rewards.length)];
                rewardDisplay.innerHTML = `<div class="text-8xl">${finalReward.icon}</div>`;
                rewardText.textContent = finalReward.text;
                const claimButton = document.createElement('button');
                claimButton.id = 'claim-reward-btn';
                claimButton.className = 'w-full py-2 bg-gray-700 rounded-lg font-bold border border-gray-600';
                claimButton.textContent = 'Claim';
                rewardAction.innerHTML = '';
                rewardAction.appendChild(claimButton);

                document.getElementById('claim-reward-btn').addEventListener('click', () => {
                    if (finalReward.type === 'hp') { player.maxHp += finalReward.value; player.currentHp += finalReward.value; }
                    else if (finalReward.type === 'luck') player.luck += finalReward.value;
                    else if (finalReward.type === 'gold') player.gold += finalReward.value;
                    updatePlayerUI();
                    rewardModal.classList.add('hidden');
                    isGamePaused = false;
                    const reel = reels[reelIndex];
                    reel.querySelector('.reel-content').textContent = '‚ùî';
                    reel.disabled = true;
                    reel.classList.add('opacity-50', 'cursor-not-allowed');
                    currentEnemies[reelIndex] = null;
                    if (player.statusEffects.includes('rush') && actionsTakenThisTurn < 2) startPlayerTurn(); else startEnemyTurn();
                }, { once: true });
            };

            const spinReels = () => {
                if (spinButton.disabled) return;
                player.baseArmor = player.maxBaseArmor;
                player.armorBonus = player.equippedArmorBonus;
                updatePlayerUI();
                spinsRemaining--;
                if (spinsRemaining < 0) { wave++; const maxSpins = player.equippedRing === 'infinity' ? 7 : 5; spinsRemaining = maxSpins - 1; }
                updateWaveUI();
                spinButton.disabled = true;
                reels.forEach(reel => { reel.disabled = true; reel.classList.remove('opacity-50', 'cursor-not-allowed'); reel.querySelector('.attack-value')?.classList.add('hidden'); reel.querySelector('.special-value')?.classList.add('hidden'); });
                enemyInfoArea.classList.add('hidden');
                currentEnemies = [];
                player.statusEffects = [];
                updateAllStatusIcons();
                let spinIntervals = [];
                reels.forEach((reel, i) => {
                    const reelContent = reel.querySelector('.reel-content');
                    spinIntervals[i] = setInterval(() => { reelContent.textContent = enemies[Math.floor(Math.random() * enemies.length)].emoji; }, 100);
                    setTimeout(() => {
                        clearInterval(spinIntervals[i]);
                        const finalEnemy = { ...enemies[Math.floor(Math.random() * enemies.length)] };
                        currentEnemies[i] = finalEnemy;
                        reelContent.textContent = finalEnemy.emoji;
                        if (i === reels.length - 1) { spinButton.disabled = false; displayEnemyInfo(currentEnemies); actionsTakenThisTurn = 0; startPlayerTurn(); }
                    }, 100 + (i * 50)); 
                });
            };

            spinButton.addEventListener('click', spinReels);
            
            function enemyAttack(enemy, reel, index) {
                if (!enemy || enemy.isDefeated || enemy.attack <= 0) return;
                if (enemy.statusEffects.includes('sluggish') && Math.random() < 0.5) { console.log(`${enemy.name} is sluggish and missed.`); createEffectPopup('Miss!', '#9ca3af', reel); applyPostActionStatusEffects(enemy, false, index); return; }

                setTimeout(() => {
                    const totalArmor = player.baseArmor + player.armorBonus;
                    let damageFromEnemy = enemy.attack;
                    if (player.specialArmor === 'admirers' && enemy.class === 'human') damageFromEnemy = damageFromEnemy === 1 ? 1 : Math.floor(damageFromEnemy / 2);
                    if (enemy.statusEffects.includes('curse')) { const selfDamage = Math.ceil(damageFromEnemy / 2); damageFromEnemy = selfDamage; applyDamageAndAnimate(index, selfDamage); }
                    const damageToBonusArmor = Math.min(damageFromEnemy, player.armorBonus);
                    player.armorBonus -= damageToBonusArmor;
                    damageFromEnemy -= damageToBonusArmor;
                    if (damageFromEnemy > 0) { const damageToBaseArmor = Math.min(damageFromEnemy, player.baseArmor); player.baseArmor -= damageToBaseArmor; damageFromEnemy -= damageToBaseArmor; }
                    if (damageFromEnemy > 0) player.currentHp = Math.max(0, player.currentHp - damageFromEnemy);
                    updatePlayerUI();

                    const debuffSpecials = { '‚ò†Ô∏è': 'poison', 'üïØÔ∏è': 'curse', 'üêå': 'sluggish' };
                    const statusToApply = debuffSpecials[enemy.special];
                    if (statusToApply && !enemy.specialUsed && !player.statusEffects.includes(statusToApply)) { player.statusEffects.push(statusToApply); updateAllStatusIcons(); enemy.specialUsed = true; reel.querySelector('.special-value')?.classList.add('hidden'); }
                    if (enemy.special === 'ü´≥' && !enemy.specialUsed) { const goldStolen = 15; player.gold = Math.max(0, player.gold - goldStolen); createEffectPopup(`-${goldStolen}ü™ô`, '#d1d5db', topStatusBar); updatePlayerUI(); enemy.specialUsed = true; reel.querySelector('.special-value')?.classList.add('hidden'); }
                    applyPostActionStatusEffects(enemy, false, index);
                    if (player.currentHp <= 0) { document.body.style.filter = 'grayscale(100%)'; spinButton.disabled = true; reels.forEach(r => r.disabled = true); }
                }, 160);
            }

            async function allEnemiesAttack() {
                for (let i = 0; i < currentEnemies.length; i++) { if (currentEnemies[i] && !currentEnemies[i].isDefeated) { await new Promise(resolve => setTimeout(resolve, 250)); enemyAttack(currentEnemies[i], reels[i], i); } }
                await new Promise(resolve => setTimeout(resolve, 250));
                startPlayerTurn();
            }

            function applyDamageAndAnimate(index, damageAmount) {
                const enemy = currentEnemies[index];
                if (!enemy || enemy.isDefeated) return false;
                let giftDefeated = false;
                const reel = reels[index];
                const damagePopup = document.createElement('div');
                damagePopup.textContent = `${damageAmount}`;
                damagePopup.className = 'damage-popup';
                reel.appendChild(damagePopup);
                damagePopup.addEventListener('animationend', () => damagePopup.remove());
                enemy.currentHealth -= damageAmount;
                const enemyInfo = document.getElementById(`enemy-info-${index + 1}`);
                const healthBar = enemyInfo.querySelector('.health-bar');
                const healthText = document.getElementById(`health-text-${index + 1}`);
                if (enemy.currentHealth <= 0) {
                    enemy.currentHealth = 0;
                    enemy.isDefeated = true;
                    healthBar.style.width = '0%';
                    healthText.textContent = `0/${enemy.maxHealth}`;
                    updateAllStatusIcons();
                    if (enemy.emoji === 'üéÅ') { giftDefeated = true; setTimeout(() => { enemyInfo.style.visibility = 'hidden'; reel.querySelector('.attack-value')?.classList.add('hidden'); reel.querySelector('.special-value')?.classList.add('hidden'); showRewardModal(index); }, 300); } else { setTimeout(() => { reel.querySelector('.reel-content').textContent = enemy.name === 'Unicorn' ? 'üëë' : 'üíÄ'; reel.classList.remove('opacity-50', 'cursor-not-allowed'); enemyInfo.style.visibility = 'hidden'; reel.querySelector('.attack-value')?.classList.add('hidden'); reel.querySelector('.special-value')?.classList.add('hidden'); }, 300); }
                } else {
                    const healthPercent = (enemy.currentHealth / enemy.maxHealth) * 100;
                    healthBar.style.width = `${healthPercent}%`;
                    healthText.textContent = `${enemy.currentHealth}/${enemy.maxHealth}`;
                }
                return giftDefeated;
            }

            function castSpell(spellName) {
                closeModal();
                reels.forEach(r => r.disabled = true);
                let aGiftWasDefeated = false;
                if (spellName === 'flameheart') { currentEnemies.forEach((enemy, index) => { if (enemy && !enemy.isDefeated) if (applyDamageAndAnimate(index, 5)) aGiftWasDefeated = true; }); player.currentHp = Math.min(player.maxHp, player.currentHp + 5); updatePlayerUI(); }
                else if (spellName === 'frostbite') { currentEnemies.forEach((enemy, index) => { if (enemy && !enemy.isDefeated) { if (applyDamageAndAnimate(index, 5)) aGiftWasDefeated = true; if (!enemy.statusEffects.includes('sluggish')) { enemy.statusEffects.push('sluggish'); checkForTorment(enemy, index); } } }); updateAllStatusIcons(); }
                else if (spellName === 'armorheart') { player.armorBonus += player.currentHp; updatePlayerUI(); }
                if (!aGiftWasDefeated) startEnemyTurn();
            }

            function applySacrifice(sacrifice) {
                player.activeSacrifices.push(sacrifice.title);
                console.log("Applying sacrifice:", sacrifice.title);
                if (sacrifice.title === 'BLOOD PACT') { player.maxHp = Math.max(1, player.maxHp - 3); player.currentHp = Math.min(player.currentHp, player.maxHp); }
                else if (sacrifice.title === 'BROKEN ANKLE') player.luck = Math.max(0, player.luck - 10);
                else if (sacrifice.title === 'HEARTBREAK') { const spellToDisable = ['flameheart', 'armorheart'][Math.floor(Math.random() * 2)]; player.disabledSpells.push(spellToDisable); updateMagicUI(); }
                else if (sacrifice.title === 'GAMBLING DEBT') player.gold = Math.max(0, player.gold - 30);
                else if (sacrifice.title === 'CLUMSY') { player.moons = Math.max(0, player.moons - 1); updateMoonModalUI(); }
                updatePlayerUI();
            }

            function applyPostActionStatusEffects(character, isPlayer, index = -1) {
                if (!character || (isPlayer ? player.currentHp <= 0 : character.isDefeated)) return;
                if (character.statusEffects.includes('poison')) { if (isPlayer) { player.currentHp -= 1; createEffectPopup('‚ò†Ô∏è1', '#ef4444', playerHpContainer); } else { const poisonDamage = player.activeFortunes.includes('Toxic Decay') ? 3 : 1; applyDamageAndAnimate(index, poisonDamage); } }
                if (character.statusEffects.includes('regen')) { if (isPlayer) { if(player.currentHp < player.maxHp) { player.currentHp += 1; createEffectPopup('‚ùáÔ∏è1', '#9ca3af', playerHpContainer); } } else { if (character.currentHealth < character.maxHealth && !character.isDefeated) { character.currentHealth += 1; const enemyInfo = document.getElementById(`enemy-info-${index + 1}`); if (enemyInfo) { const healthBar = enemyInfo.querySelector('.health-bar'); const healthText = document.getElementById(`health-text-${index + 1}`); const healthPercent = (character.currentHealth / character.maxHealth) * 100; healthBar.style.width = `${healthPercent}%`; healthText.textContent = `${character.currentHealth}/${character.maxHealth}`; createEffectPopup('‚ùáÔ∏è1', '#9ca3af', reels[index]); } } } }
                if (isPlayer) { updatePlayerUI(); if (player.currentHp <= 0) { document.body.style.filter = 'grayscale(100%)'; spinButton.disabled = true; reels.forEach(r => r.disabled = true); } }
            }
            
            function startPlayerTurn() { reels.forEach((reel, i) => { reel.disabled = !(currentEnemies[i] && player.currentHp > 0); }); }
            function startEnemyTurn() { if (isGamePaused) return; actionsTakenThisTurn = 0; setTimeout(() => allEnemiesAttack(), 300); }

            reels.forEach((reel, index) => {
                reel.addEventListener('click', () => {
                    const enemy = currentEnemies[index];
                    const reelContent = reel.querySelector('.reel-content');
                    const isSkull = reelContent.textContent === 'üíÄ' || reelContent.textContent === 'üëë';
                    if (enemy && enemy.isDefeated && isSkull) {
                        skullCount += (reelContent.textContent === 'üëë' ? 2 : 1);
                        skullMeterBar.style.width = `${Math.min((skullCount / 10) * 100, 100)}%`;
                        skullMeterText.textContent = `${skullCount}/10`;
                        reelContent.textContent = '‚ùî'; reel.disabled = true; reel.classList.add('opacity-50', 'cursor-not-allowed'); currentEnemies[index] = null; 
                        if (skullCount >= 10) setTimeout(showSkullModal, 300);
                        return;
                    }
                    if (reel.disabled || !enemy || enemy.isDefeated) return;
                    reels.forEach(r => r.disabled = true);
                    if (player.statusEffects.includes('sluggish') && Math.random() < 0.5) { createEffectPopup('Miss!', '#9ca3af', document.getElementById('slot-machine')); applyPostActionStatusEffects(player, true); if (player.currentHp > 0) startEnemyTurn(); return; }
                    actionsTakenThisTurn++;
                    let totalPlayerAttack = player.baseAttack + player.attackBonus;
                    if (player.statusEffects.includes('blessing')) totalPlayerAttack += player.baseArmor + player.armorBonus;
                    if (player.statusEffects.includes('curse')) { const selfDamage = Math.ceil(totalPlayerAttack / 2); totalPlayerAttack = selfDamage; player.currentHp -= selfDamage; updatePlayerUI(); if (player.currentHp <= 0) { document.body.style.filter = 'grayscale(100%)'; spinButton.disabled = true; reels.forEach(r => r.disabled = true); return; } }
                    if (statusWeaponIcon.textContent === 'üèπ' && player.activeFortunes.includes("Archer's Edge")) { currentEnemies.forEach((e, i) => { if(e && !e.isDefeated) applyDamageAndAnimate(i, totalPlayerAttack); }); } else { applyDamageAndAnimate(index, totalPlayerAttack); }
                    if (statusWeaponIcon.textContent === 'üó°Ô∏è' && player.activeFortunes.includes('Thief Strike') && enemy) { player.gold += 5; createEffectPopup('+5ü™ô', '#d1d5db', document.getElementById('slot-machine')); updatePlayerUI(); }
                    applyPostActionStatusEffects(player, true);
                    if (player.currentHp <= 0) return;
                    const defeatedEnemy = currentEnemies[index];
                    if (defeatedEnemy && defeatedEnemy.isDefeated && defeatedEnemy.emoji === 'üéÅ') return;
                    if (player.statusEffects.includes('rush') && actionsTakenThisTurn < 2) startPlayerTurn(); else startEnemyTurn();
                });
            });

            // EQUIPMENT MODAL LOGIC
            const equipSlotButtons = document.querySelectorAll('.equip-slot-btn');
            const equipChoices = document.querySelectorAll('.equip-choices');
            const equipChoiceButtons = document.querySelectorAll('.equip-choices button:not([disabled])');
            const statusWeaponIcon = document.getElementById('status-weapon-icon');
            const statusArmorIcon = document.getElementById('status-armor-icon');

            function handleEquipChoice(event) {
                const choiceButton = event.currentTarget;
                const newEmoji = choiceButton.dataset.emoji, newTitle = choiceButton.dataset.title;
                const parentChoicesId = choiceButton.closest('.equip-choices').id;
                const slotButton = document.querySelector(`.equip-slot-btn[data-target='${parentChoicesId}']`);
                if (slotButton) { slotButton.children[0].textContent = newEmoji; slotButton.children[1].textContent = newTitle; }
                const statType = choiceButton.dataset.statType, statValue = statType === 'special' ? choiceButton.dataset.statValue : parseInt(choiceButton.dataset.statValue, 10);
                if (parentChoicesId === 'weapon-choices') { statusWeaponIcon.textContent = newEmoji; player.attackBonus = (statType === 'attack') ? statValue : 0; }
                else if (parentChoicesId === 'armor-choices') { statusArmorIcon.textContent = newEmoji; player.equippedArmorBonus = 0; player.specialArmor = null; if (statType === 'armor') player.equippedArmorBonus = statValue; else if (statType === 'special' && statValue === 'admirers') player.specialArmor = 'admirers'; }
                else if (parentChoicesId === 'ring-choices') { const wasInfinityEquipped = player.equippedRing === 'infinity'; let newRingType = null; if (newTitle === 'Infinity Ring') newRingType = 'infinity'; if (newRingType === 'infinity' && !wasInfinityEquipped) spinsRemaining += 2; else if (newRingType !== 'infinity' && wasInfinityEquipped) spinsRemaining = Math.max(0, spinsRemaining - 2); player.equippedRing = newRingType; }
                player.armorBonus = player.equippedArmorBonus;
                updatePlayerUI();
                updateWaveUI();
            }

            function unlockInfinityRing() {
                const ringChoicesContainer = document.getElementById('ring-choices');
                const placeholderButton = document.getElementById('ring-slot-2');
                if (!ringChoicesContainer || !placeholderButton) return;
                const newRingButton = document.createElement('button');
                newRingButton.dataset.emoji = "‚ôæÔ∏è"; newRingButton.dataset.title = "Infinity Ring"; newRingButton.dataset.statType = "none"; newRingButton.dataset.statValue = "0";
                newRingButton.className = "w-full text-center py-1 px-2 bg-gray-800 rounded-lg focus:bg-gray-600 focus:outline-none";
                newRingButton.innerHTML = `‚ôæÔ∏è Infinity Ring (+2 Spins)`;
                newRingButton.addEventListener('click', handleEquipChoice);
                ringChoicesContainer.replaceChild(newRingButton, placeholderButton);
            }
            equipSlotButtons.forEach(button => button.addEventListener('click', () => { const targetId = button.dataset.target; const targetChoices = document.getElementById(targetId); equipChoices.forEach(div => div.classList.add('hidden')); if (targetChoices) targetChoices.classList.remove('hidden'); }));
            equipChoiceButtons.forEach(button => button.addEventListener('click', handleEquipChoice));
            document.querySelector('[data-modal-target="system-modal-wrapper"]').addEventListener('click', () => { setTimeout(() => { const firstSlot = document.querySelector('#system-modal-wrapper .equip-slot-btn'); if(firstSlot) { firstSlot.focus(); firstSlot.click(); } },0); });

            // TUTORIAL MODAL LOGIC
            const tutorialOpenBtn = document.getElementById('tutorial-open-btn');
            const tutorialModal = document.getElementById('tutorial-modal-wrapper');
            const tutorialCloseBtn = document.getElementById('tutorial-close-btn');
            if (tutorialOpenBtn && tutorialModal && tutorialCloseBtn) {
                tutorialOpenBtn.addEventListener('click', (e) => { e.stopPropagation(); tutorialModal.classList.remove('hidden'); });
                tutorialCloseBtn.addEventListener('click', (e) => { e.stopPropagation(); tutorialModal.classList.add('hidden'); });
            }

            updatePlayerUI();
            updateCollectedFortunesDisplay();
            updateMagicUI();
            updateAllStatusIcons();
            updateWaveUI();
        });
    </script>
</body>
</html>


