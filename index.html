<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Synergy Slots ‚Äî Mobile</title>
  <style>
    :root {
      --bg: 222 22% 10%;
      --panel: 222 22% 14%;
      --panel-2: 222 22% 18%;
      --text: 210 20% 98%;
      --muted: 216 12% 72%;
      --brand: 268 84% 62%;
      --brand-2: 208 100% 60%;
      --accent: 148 64% 55%;
      --danger: 0 84% 62%;
      --gold: 46 95% 62%;
      --card: 218 22% 22%;
      --shadow: 220 40% 2%;
      --radius: 20px;
      --gap: 10px;
      --tile-size: min(16.5vw, 90px);
      --tile-radius: 18px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Apple Color Emoji", "Segoe UI Emoji";
      color: hsl(var(--text));
      background: radial-gradient(1200px 800px at 50% -10%, hsl(var(--brand)/.25), transparent 60%),
                  radial-gradient(1200px 800px at 50% 110%, hsl(var(--brand-2)/.2), transparent 60%),
                  hsl(var(--bg));
      overflow: hidden;
    }

    /* Orientation guard */
    #rotate-guard {
      position: fixed; inset: 0; display: none; place-items: center; z-index: 9999;
      background: linear-gradient(180deg, hsl(var(--panel)/.9), hsl(var(--panel-2)/.9));
      backdrop-filter: blur(8px);
      text-align: center; padding: 32px;
    }
    #rotate-guard.show { display: grid; }
    #rotate-guard .box {
      background: hsl(var(--card)); border: 1px solid hsl(var(--panel-2));
      border-radius: 24px; padding: 28px; box-shadow: 0 20px 60px hsl(var(--shadow)/.7);
    }

    .app {
      position: relative; height: 100dvh; width: 100%;
      display: grid; grid-template-rows: auto 1fr auto;
      gap: var(--gap);
      padding: calc(8px + var(--safe-top)) 10px calc(10px + var(--safe-bottom));
    }

    .header {
      display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 10px;
    }
    .brand {
      display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 999px;
      background: linear-gradient(135deg, hsl(var(--panel)), hsl(var(--panel-2)));
      border: 1px solid hsl(var(--panel-2));
      box-shadow: inset 0 1px 0 hsl(0 0% 100%/.05), 0 4px 20px hsl(var(--shadow)/.5);
      font-weight: 800; letter-spacing: 0.5px;
    }
    .brand .logo { width: 28px; height: 28px; border-radius: 8px; display: grid; place-items: center;
      background: conic-gradient(from 200deg, hsl(var(--brand)), hsl(var(--brand-2)), hsl(var(--accent)), hsl(var(--brand)));
      box-shadow: 0 6px 18px hsl(var(--brand)/.4);
      font-size: 16px; color: white; font-weight: 900;
    }

    .header .meters {
      display: flex; gap: 8px; justify-content: center;
    }
    .pill {
      display: flex; align-items: center; gap: 8px; border-radius: 999px; padding: 8px 12px;
      background: linear-gradient(180deg, hsl(var(--panel)), hsl(var(--panel-2)));
      border: 1px solid hsl(var(--panel-2));
      box-shadow: inset 0 1px 0 hsl(0 0% 100%/.06), 0 6px 18px hsl(var(--shadow)/.6);
      font-weight: 700; min-width: 0;
    }
    .pill .ico { font-size: 18px; line-height: 0; }
    .pill .val { font-size: clamp(14px, 3.6vw, 16px); }

    .header .actions { display: flex; gap: 8px; }
    .icon-btn {
      width: 38px; height: 38px; border-radius: 12px; display: grid; place-items: center;
      background: linear-gradient(180deg, hsl(var(--panel)), hsl(var(--panel-2)));
      border: 1px solid hsl(var(--panel-2)); cursor: pointer; position: relative;
      box-shadow: inset 0 1px 0 hsl(0 0% 100%/.06), 0 4px 16px hsl(var(--shadow)/.6);
      transition: transform .06s ease;
    }
    .icon-btn:active { transform: translateY(1px) scale(.98); }

    /* GRID */
    .stage {
      position: relative; display: grid; place-items: center; padding: 6px;
    }
    .grid {
      width: 100%;
      display: grid; grid-template-columns: repeat(5, var(--tile-size));
      grid-template-rows: repeat(3, var(--tile-size));
      justify-content: center; gap: 10px; padding: 6px;
      border-radius: calc(var(--radius) * 1.2);
      background: linear-gradient(180deg, hsl(var(--panel)/.6), hsl(var(--panel-2)/.8));
      border: 1px solid hsl(var(--panel-2));
      box-shadow: inset 0 2px 0 hsl(0 0% 100%/.04), 0 20px 50px hsl(var(--shadow)/.65);
      position: relative;
    }

    .tile {
      position: relative; display: grid; grid-template-rows: 1fr auto; align-items: center; justify-items: center;
      border-radius: var(--tile-radius); user-select: none; overflow: hidden;
      background: linear-gradient(180deg, hsl(var(--card)), hsl(var(--panel-2)));
      border: 1px solid hsl(var(--panel-2));
      box-shadow: inset 0 1px 0 hsl(0 0% 100%/.06), 0 10px 24px hsl(var(--shadow)/.75);
      padding: 6px; isolation: isolate;
      transform: translateZ(0);
    }
    .tile .emoji { font-size: clamp(24px, 7.6vw, 48px); filter: drop-shadow(0 6px 12px rgba(0,0,0,.4)); }
    .tile .label { font-size: clamp(10px, 2.6vw, 13px); opacity: .8; font-weight: 700; letter-spacing: .2px; }
    .tile .badge { position: absolute; top: 6px; left: 6px; font-size: 10px; padding: 4px 6px; border-radius: 999px;
      background: hsl(var(--panel)); border: 1px solid hsl(var(--panel-2)); opacity: .9; font-weight: 800; }
    .tile.locked::after { content: "üîí"; position: absolute; top: 6px; right: 6px; }

    .toast {
      position: absolute; bottom: 6px; left: 50%; transform: translate(-50%, 10px);
      font-size: 11px; padding: 4px 8px; border-radius: 10px; white-space: nowrap;
      background: hsl(var(--panel)/.85); border: 1px solid hsl(var(--panel-2)); opacity: 0;
      box-shadow: 0 10px 20px hsl(var(--shadow)/.7); pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
    }
    .toast.show { opacity: 1; transform: translate(-50%, 0); }

    /* BOTTOM BAR */
    .footer {
      display: grid; grid-template-columns: 1fr; gap: var(--gap);
    }
    .big-primary {
      appearance: none; border: none; cursor: pointer; color: white; font-weight: 900; letter-spacing: .6px;
      font-size: clamp(18px, 6vw, 22px); padding: 16px 18px; border-radius: 18px;
      background: linear-gradient(135deg, hsl(var(--brand)), hsl(var(--brand-2)));
      box-shadow: 0 16px 40px hsl(var(--brand)/.5), inset 0 1px 0 hsl(0 0% 100%/.15);
      text-shadow: 0 2px 8px rgba(0,0,0,.4);
    }
    .big-primary:disabled { opacity: .6; filter: saturate(.7); }

    .actions-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--gap); }
    .action-btn {
      appearance: none; border: 1px solid hsl(var(--panel-2)); background: linear-gradient(180deg, hsl(var(--panel)), hsl(var(--panel-2)));
      color: hsl(var(--text)); border-radius: 16px; padding: 12px; font-weight: 800; letter-spacing: .4px;
      box-shadow: 0 12px 30px hsl(var(--shadow)/.6), inset 0 1px 0 hsl(0 0% 100%/.06);
    }

    /* Drawers */
    .drawer { position: fixed; left: 0; right: 0; bottom: 0; z-index: 60; transform: translateY(105%);
      transition: transform .28s cubic-bezier(.2,.9,.2,1);
    }
    .drawer.open { transform: translateY(0); }
    .sheet {
      margin: 0 auto; width: min(640px, 100%); background: linear-gradient(180deg, hsl(var(--panel)), hsl(var(--panel-2)));
      border-radius: 24px 24px 0 0; border: 1px solid hsl(var(--panel-2));
      box-shadow: 0 -20px 60px hsl(var(--shadow)/.7);
      padding: 12px 12px calc(18px + env(safe-area-inset-bottom));
    }
    .sheet .handle { width: 48px; height: 5px; border-radius: 999px; background: hsl(var(--panel-2)); margin: 8px auto 12px; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .title { font-weight: 900; font-size: 18px; letter-spacing: .4px; }
    .grid-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .card {
      background: linear-gradient(180deg, hsl(var(--card)), hsl(var(--panel-2)));
      border: 1px solid hsl(var(--panel-2)); border-radius: 16px; padding: 10px; display: grid; gap: 6px;
      box-shadow: inset 0 1px 0 hsl(0 0% 100%/.06), 0 10px 30px hsl(var(--shadow)/.7);
    }
    .card .name { font-weight: 900; font-size: 14px; }
    .card .desc { font-size: 12px; opacity: .8; }
    .tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 800;
      background: hsl(var(--panel)); border: 1px solid hsl(var(--panel-2)); }
    .card .row { gap: 8px; }
    .tiny { font-size: 11px; opacity: .8; }
    .pill.bad { border-color: hsl(var(--danger)); color: hsl(var(--danger)); }

    /* Spin animation */
    @keyframes spinA { from { filter: blur(0px); transform: translateY(0) scale(1); } 25% { filter: blur(2px); }
      50% { transform: translateY(-10%) scale(0.98); } 75% { filter: blur(1px); } to { filter: blur(0px); transform: translateY(0) scale(1);} }
    .spinning .tile { animation: spinA .55s ease; }

    /* Utilities */
    .hidden { display: none !important; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .muted { color: hsl(var(--muted)); }

    @media (min-width: 520px) {
      :root { --tile-size: min(14vw, 96px); }
    }
  </style>
</head>
<body>
  <div id="rotate-guard">
    <div class="box">
      <div style="font-size:42px">üì±‚Ü©Ô∏è</div>
      <h2 style="margin:10px 0 6px">Please rotate to portrait</h2>
      <p class="muted">This prototype is tuned for vertical play.</p>
    </div>
  </div>

  <main class="app">
    <!-- Header -->
    <header class="header">
      <div class="brand"><div class="logo">S</div> Synergy Slots</div>
      <div class="meters">
        <div class="pill" title="Coins"><span class="ico">ü™ô</span><span class="val" id="coins">0</span></div>
        <div class="pill" title="HP"><span class="ico">‚ù§Ô∏è</span><span class="val" id="hp">3</span></div>
        <div class="pill" title="Turn"><span class="ico">üìÖ</span><span class="val" id="turn">1</span></div>
      </div>
      <div class="actions">
        <button class="icon-btn" id="btnSettings" title="Settings">‚öôÔ∏è</button>
        <button class="icon-btn" id="btnHelp" title="Help">‚ùî</button>
      </div>
    </header>

    <!-- Stage -->
    <section class="stage">
      <div class="grid" id="grid"></div>
    </section>

    <!-- Footer / Controls -->
    <footer class="footer">
      <button class="big-primary" id="btnSpin">SPIN</button>
      <div class="actions-row">
        <button class="action-btn" id="btnInventory">Inventory</button>
        <button class="action-btn" id="btnShop">Shop</button>
        <button class="action-btn" id="btnReroll">Reroll (<span id="rerollCost">1</span>)</button>
      </div>
    </footer>
  </main>

  <!-- Inventory Drawer -->
  <div class="drawer" id="drawerInventory" aria-hidden="true">
    <div class="sheet">
      <div class="handle"></div>
      <div class="row">
        <div class="title">Deck & Inventory</div>
        <button class="action-btn" id="btnCloseInv">Close</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">Tap a card to toggle it in the deck. Long-press on grid tiles to lock them between spins.</div>
      <h4 style="margin:10px 0 4px">In Deck</h4>
      <div class="grid-cards" id="deckCards"></div>
      <h4 style="margin:10px 0 4px">Collection</h4>
      <div class="grid-cards" id="collectionCards"></div>
    </div>
  </div>

  <!-- Shop Drawer -->
  <div class="drawer" id="drawerShop" aria-hidden="true">
    <div class="sheet">
      <div class="handle"></div>
      <div class="row">
        <div class="title">Shop</div>
        <button class="action-btn" id="btnCloseShop">Close</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">Buy symbols to add to your collection. Reroll for new offers.</div>
      <div class="grid-cards" id="shopCards"></div>
    </div>
  </div>

  <!-- Simple Settings (inline modal via alert) handled in JS -->

  <script>
  // ======= DATA =======
  const SYMBOLS = [
    { id: 'cherry', name: 'Cherry', emoji: 'üçí', base: 1, tags: ['fruit'], color: '#FF6B6B', desc: '+1 base. Pairs with other fruit.' },
    { id: 'lemon', name: 'Lemon', emoji: 'üçã', base: 1, tags: ['fruit'], color: '#FFD166', desc: '+1 base. Pairs with other fruit.' },
    { id: 'seven', name: 'Seven', emoji: '7Ô∏è‚É£', base: 3, tags: ['lucky'], color: '#B197FC', desc: 'Lucky 7! Solid base value.' },
    { id: 'clover', name: 'Clover', emoji: '‚òòÔ∏è', base: 1, tags: ['lucky'], color: '#2DD4BF', desc: 'Doubles adjacent scores.' },
    { id: 'diamond', name: 'Diamond', emoji: 'üíé', base: 2, tags: ['gem'], color: '#60A5FA', desc: '1.5x all gems on board.' },
    { id: 'star', name: 'Star', emoji: '‚≠ê', base: 2, tags: ['wild'], color: '#F7D154', desc: '+1 per unique tag this spin.' },
    { id: 'gear', name: 'Gear', emoji: '‚öôÔ∏è', base: 1, tags: ['mech'], color: '#94A3B8', desc: '+1 per other mech on board.' },
    { id: 'bomb', name: 'Bomb', emoji: 'üí£', base: 0, tags: ['item'], color: '#FB7185', desc: '+3 if next to any fruit.' },
    { id: 'heart', name: 'Heart', emoji: '‚ù§Ô∏è', base: 1, tags: ['life'], color: '#F43F5E', desc: '3+ hearts heal 1 HP.' },
    { id: 'bar', name: 'BAR', emoji: 'üß±', base: 2, tags: ['bar'], color: '#F59E0B', desc: 'Sturdy payout.' },
  ];

  const START_DECK = ['cherry','lemon','seven','bar','cherry','lemon','cherry','gear','star','bar','heart','diamond','clover','lemon','cherry'];

  const state = {
    coins: 10,
    hp: 3,
    turn: 1,
    deck: [...START_DECK], // multiset by id
    collection: [...new Set(START_DECK)],
    grid: Array(15).fill(null),
    locked: new Set(), // indexes locked between spins
    rerollCost: 1,
    shop: [],
    settings: { haptics: true, speed: 1 }
  };

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // ======= UI HELPERS =======
  function setText(id, val){ const el = (typeof id === 'string') ? document.getElementById(id) : id; if (el) el.textContent = val; }
  function vibrate(ms){ try { if (state.settings.haptics && navigator.vibrate) navigator.vibrate(ms); } catch(e){} }
  function toast(el, text){
    let t = el.querySelector('.toast');
    if(!t){ t = document.createElement('div'); t.className = 'toast'; el.appendChild(t); }
    t.textContent = text; requestAnimationFrame(()=>{ t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); });
  }

  function badge(colorText){
    const b = document.createElement('span'); b.className = 'badge'; b.style.color = colorText; b.textContent = '√ó1'; return b;
  }

  function openDrawer(id){ const d = $(id); d.classList.add('open'); d.setAttribute('aria-hidden','false'); }
  function closeDrawer(id){ const d = $(id); d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }

  function checkOrientation(){
    const portrait = window.innerHeight >= window.innerWidth;
    $('#rotate-guard').classList.toggle('show', !portrait);
  }
  window.addEventListener('resize', checkOrientation);

  // ======= GRID RENDER =======
  function renderHUD(){ setText('coins', state.coins); setText('hp', state.hp); setText('turn', state.turn); setText('rerollCost', state.rerollCost); }

  function makeTile(symId, idx){
    const sym = SYMBOLS.find(s=>s.id===symId) || { name:'Empty', emoji:'', base:0, tags:[] };
    const el = document.createElement('div'); el.className = 'tile'; el.dataset.index = idx; el.dataset.id = symId || '';
    const em = document.createElement('div'); em.className = 'emoji'; em.textContent = sym.emoji;
    const lb = document.createElement('div'); lb.className = 'label'; lb.textContent = sym.name;
    el.appendChild(em); el.appendChild(lb);
    el.addEventListener('click', ()=>{
      const i = Number(el.dataset.index);
      if (state.locked.has(i)) { state.locked.delete(i); el.classList.remove('locked'); toast(el,'Unlocked'); }
      else { state.locked.add(i); el.classList.add('locked'); toast(el,'Locked'); }
    });
    el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); alert(`${sym.name}\n\nTags: ${sym.tags.join(', ') || '‚Äî'}\nBase: ${sym.base}\n\n${sym.desc||''}`); });
    return el;
  }

  function renderGrid(){
    const wrap = $('#grid'); wrap.innerHTML = '';
    state.grid.forEach((id, i)=>{ const t = makeTile(id, i); if(state.locked.has(i)) t.classList.add('locked'); wrap.appendChild(t); });
  }

  // ======= SPIN / SCORING =======
  function randomFromDeck(){
    if (!state.deck.length) return null;
    // Weight rarer symbols slightly lower by duplicating commons in a pool (simple heuristic)
    const pool = state.deck.flatMap(id=>{
      const s = SYMBOLS.find(x=>x.id===id); const w = (s && (s.base <= 1 ? 3 : 1)); return Array(w).fill(id);
    });
    return pool[Math.floor(Math.random()*pool.length)] || state.deck[Math.floor(Math.random()*state.deck.length)];
  }

  function neighbors(idx){
    const col = idx % 5; const row = Math.floor(idx / 5);
    const list = [];
    const push = i => { if (i>=0 && i<15) list.push(i); };
    if (col>0) push(idx-1);
    if (col<4) push(idx+1);
    if (row>0) push(idx-5);
    if (row<2) push(idx+5);
    return list;
  }

  function spin(){
    if ($('#btnSpin').disabled) return;
    if (state.coins <= 0) { vibrate(60); alert('You need coins to spin! Try the shop or synergies to earn more.'); return; }
    state.coins -= 1; renderHUD();

    // Fill non-locked slots with new random symbols from the deck
    state.grid = state.grid.map((id, i)=> state.locked.has(i) ? id : randomFromDeck());

    const gridEl = $('#grid'); gridEl.classList.add('spinning');
    setTimeout(()=>{
      gridEl.classList.remove('spinning');
      renderGrid();
      const { total, notes } = scoreGrid();
      state.coins += Math.round(total);
      state.turn += 1; renderHUD();
      vibrate(20);
      // Show per-tile toasts from notes
      notes.forEach(n=>{
        const tile = gridEl.children[n.index]; if (!tile) return;
        toast(tile, `+${n.delta} ${n.reason}`);
      });
      // occasional HP heal if 3+ hearts
      const heartCount = state.grid.filter(id=>id==='heart').length;
      if (heartCount >= 3) { state.hp = Math.min(5, state.hp + 1); renderHUD(); }
    }, 560 / state.settings.speed);
  }

  function scoreGrid(){
    const tiles = state.grid.map(id => SYMBOLS.find(s=>s.id===id));
    const countsByTag = new Map();
    tiles.forEach(s => (s?.tags||[]).forEach(t=> countsByTag.set(t,(countsByTag.get(t)||0)+1)));

    let total = 0; const notes = [];
    const mult = Array(15).fill(1); let gemBoost = 1;

    // Gem global multiplier
    const gems = tiles.filter(s=>s?.tags.includes('gem')).length;
    if (gems>0 && tiles.some(s=>s?.id==='diamond')) gemBoost = 1.5;

    // Adjacent synergies & specials
    tiles.forEach((s, i)=>{
      if (!s) return;
      // base
      total += s.base; notes.push({ index: i, delta: s.base, reason: s.name });

      // pair bonus: +1 for each adjacent tile sharing any tag
      const ns = neighbors(i);
      ns.forEach(j=>{
        const t = tiles[j]; if (!t) return;
        if (s.tags.some(tag => t.tags.includes(tag))) { total += .5; notes.push({ index: i, delta: .5, reason: 'pair'}); }
      });

      // specials
      if (s.id==='clover') { neighbors(i).forEach(j=> mult[j]*=2); notes.push({ index: i, delta: 0, reason: '√ó2 aura' }); }
      if (s.id==='gear') { const others = tiles.filter(x=>x?.tags.includes('mech')).length - 1; if (others>0) { total += others; notes.push({ index: i, delta: others, reason: '+mech' }); } }
      if (s.id==='bomb') { const anyFruit = neighbors(i).some(j=> tiles[j]?.tags.includes('fruit')); if (anyFruit) { total += 3; notes.push({ index: i, delta: 3, reason: '+bomb' }); } }
      if (s.id==='star') { total += countsByTag.size; notes.push({ index: i, delta: countsByTag.size, reason: '+unique' }); }
    });

    // Apply multipliers
    const perTile = Array(15).fill(0);
    tiles.forEach((s,i)=>{ if (!s) return; perTile[i] += s.base; });

    // recompute with simple per-tile capture to reflect multipliers in notes
    // For simplicity, scale part of total with multipliers at the end
    total = 0; // recalc more consistently
    tiles.forEach((s,i)=>{
      if (!s) return;
      let t = s.base;
      // pair bonus again for per-tile t
      neighbors(i).forEach(j=>{ const u = tiles[j]; if (u && s.tags.some(tag=>u.tags.includes(tag))) t += .5; });
      if (s.id==='gear') { const others = tiles.filter(x=>x?.tags.includes('mech')).length - 1; t += Math.max(0, others); }
      if (s.id==='bomb') { const anyFruit = neighbors(i).some(j=> tiles[j]?.tags.includes('fruit')); if (anyFruit) t += 3; }
      if (s.id==='star') { t += countsByTag.size; }
      // gem global
      if (s.tags.includes('gem')) t *= gemBoost;
      // external mult (clover)
      t *= mult[i];
      total += t;
    });

    // annotate multiplier toasts for visibly affected tiles
    mult.forEach((m,i)=>{ if (m>1) notes.push({ index: i, delta: `√ó${m}`, reason: 'mult' }); });
    if (gemBoost>1) tiles.forEach((s,i)=>{ if (s?.tags.includes('gem')) notes.push({ index: i, delta: '√ó1.5', reason: 'gem' }); });

    return { total, notes };
  }

  // ======= INVENTORY / SHOP =======
  function renderCard(symId, opts={}){
    const s = SYMBOLS.find(x=>x.id===symId); const el = document.createElement('div'); el.className = 'card';
    const name = document.createElement('div'); name.className = 'name'; name.textContent = `${s.emoji} ${s.name}`;
    const row = document.createElement('div'); row.className = 'row';
    const tagBox = document.createElement('div'); s.tags.forEach(t=>{ const tg = document.createElement('span'); tg.className='tag'; tg.textContent = t; tagBox.appendChild(tg); });
    const add = document.createElement('button'); add.className = 'action-btn'; add.textContent = opts.cta || 'Toggle';
    const desc = document.createElement('div'); desc.className='desc'; desc.textContent = s.desc;
    row.appendChild(tagBox); row.appendChild(add);
    el.appendChild(name); el.appendChild(row); el.appendChild(desc);
    if (opts.onClick) add.addEventListener('click', opts.onClick);
    return el;
  }

  function renderInventory(){
    const deckWrap = $('#deckCards'); const colWrap = $('#collectionCards'); deckWrap.innerHTML = ''; colWrap.innerHTML = '';
    const deckCounts = Object.fromEntries(state.deck.reduce((m,id)=> (m.set(id,(m.get(id)||0)+1), m), new Map()));
    const addToDeck = (id)=>{ state.deck.push(id); renderInventory(); };
    const removeFromDeck = (id)=>{ const i = state.deck.indexOf(id); if (i>=0) state.deck.splice(i,1); renderInventory(); };

    // In deck
    Object.keys(deckCounts).forEach(id=>{
      const c = deckCounts[id]; const card = renderCard(id, { cta: `Remove (x${c})`, onClick: ()=> removeFromDeck(id) }); deckWrap.appendChild(card);
    });
    // Collection
    state.collection.forEach(id=>{
      const card = renderCard(id, { cta: 'Add', onClick: ()=> addToDeck(id) }); colWrap.appendChild(card);
    });
  }

  function rollShop(){
    const pool = SYMBOLS.map(s=>s.id);
    state.shop = Array.from({length: 6}, ()=> pool[Math.floor(Math.random()*pool.length)]);
  }
  function priceOf(id){ const s = SYMBOLS.find(x=>x.id===id); return Math.max(1, s.base + (s.tags.includes('gem')?2:0) + (s.id==='clover'?2:0)); }

  function renderShop(){
    const wrap = $('#shopCards'); wrap.innerHTML = '';
    state.shop.forEach(id=>{
      const price = priceOf(id);
      const card = renderCard(id, { cta: `Buy ‚Ä¢ ${price}ü™ô`, onClick: ()=>{
        if (state.coins < price) { vibrate(60); alert('Not enough coins!'); return; }
        state.coins -= price; if (!state.collection.includes(id)) state.collection.push(id); state.deck.push(id); renderHUD(); renderInventory(); renderShop();
      }});
      wrap.appendChild(card);
    });
  }

  // ======= INIT =======
  function firstFill(){
    state.grid = state.grid.map((_,i)=> randomFromDeck());
  }

  function attach(){
    $('#btnSpin').addEventListener('click', spin);
    $('#btnInventory').addEventListener('click', ()=>{ renderInventory(); openDrawer('#drawerInventory'); });
    $('#btnCloseInv').addEventListener('click', ()=> closeDrawer('#drawerInventory'));
    $('#btnShop').addEventListener('click', ()=>{ renderShop(); openDrawer('#drawerShop'); });
    $('#btnCloseShop').addEventListener('click', ()=> closeDrawer('#drawerShop'));
    $('#btnReroll').addEventListener('click', ()=>{
      if (state.coins < state.rerollCost) { vibrate(60); alert('Not enough coins to reroll the shop.'); return; }
      state.coins -= state.rerollCost; state.rerollCost += 1; rollShop(); renderShop(); renderHUD();
    });
    $('#btnSettings').addEventListener('click', ()=>{
      const h = confirm('Haptics (vibrate) is currently ' + (state.settings.haptics?'ON':'OFF') + '.\n\nOK = toggle, Cancel = keep');
      if (h) state.settings.haptics = !state.settings.haptics;
    });
    $('#btnHelp').addEventListener('click', ()=>{
      alert('How to play:\n\n‚Ä¢ Tap SPIN to roll the 5√ó3 grid from your deck.\n‚Ä¢ Matching tags next to each other add bonus.\n‚Ä¢ Special tiles like Clover (√ó2 aura) and Diamond (√ó1.5 gems) boost scores.\n‚Ä¢ Long‚Äëpress grid tiles to lock them between spins.\n‚Ä¢ Use Inventory to add/remove symbols from your deck.\n‚Ä¢ Buy new symbols in the Shop; Reroll for fresh offers.');
    });
  }

  function load(){
    try { const saved = JSON.parse(localStorage.getItem('synergy-slots-v1')||'null'); if (saved) Object.assign(state, saved, { locked: new Set(saved.locked||[]) }); } catch(e){}
  }
  function save(){ const toSave = { ...state, locked: Array.from(state.locked) }; localStorage.setItem('synergy-slots-v1', JSON.stringify(toSave)); }

  window.addEventListener('beforeunload', save);

  function start(){
    checkOrientation();
    load();
    if (state.grid.every(x=>x===null)) firstFill();
    renderHUD(); renderGrid(); rollShop();
    attach();
  }

  start();
  </script>
</body>
</html>
