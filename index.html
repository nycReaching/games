import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Sparkles, Swords, Shield, PlayCircle, Backpack, Coins, XCircle } from "lucide-react";

// --- Utility: small haptic ping if available ---
const haptic = (pattern = 15) => {
  if (typeof window !== "undefined" && navigator?.vibrate) navigator.vibrate(pattern);
};

// --- Types ---
type View = "hub" | "battle" | "rewards" | "inventory";

type Item = {
  id: string;
  name: string;
  rarity: "common" | "rare" | "epic";
  icon?: string;
  value: number;
};

type Enemy = {
  id: string;
  name: string;
  power: number; // simple scalar for mock battle
  img?: string; // optional JPG url in the future
};

// --- Mock Data ---
const ENEMIES: Enemy[] = [
  { id: "wisp", name: "Gloom Wisp", power: 3 },
  { id: "bandit", name: "Wayward Bandit", power: 5 },
  { id: "coloss", name: "Stone Coloss", power: 8 },
];

const LOOT_TABLE: Item[] = [
  { id: "coin", name: "Coin Pouch", rarity: "common", value: 5 },
  { id: "tonic", name: "Swift Tonic", rarity: "rare", value: 1 },
  { id: "blade", name: "Ivory Blade", rarity: "epic", value: 1 },
  { id: "scrap", name: "Iron Scrap", rarity: "common", value: 3 },
];

// rarity -> color ring
const rarityRing = (r: Item["rarity"]) => ({
  common: "ring-gray-300",
  rare: "ring-sky-400",
  epic: "ring-fuchsia-500",
}[r]);

// --- Simple RNG helpers ---
const rand = (n: number) => Math.floor(Math.random() * n);
const sample = <T,>(arr: T[]) => arr[rand(arr.length)];

// Weighted pick favoring commons
const pickLoot = (): Item => {
  const pool = [
    ...LOOT_TABLE.filter(i => i.rarity === "common"),
    ...LOOT_TABLE,
    ...LOOT_TABLE.filter(i => i.rarity !== "epic"),
  ];
  return { ...sample(pool) };
};

// --- Slot Reel (self-contained) ---
function SlotReel({ spinning, stopIndex, items, delay = 0 }: {
  spinning: boolean;
  stopIndex: number | null;
  items: Item[];
  delay?: number;
}) {
  const reelRef = useRef<HTMLDivElement>(null);
  const [offset, setOffset] = useState(0);

  // Loop animation via requestAnimationFrame for precise control
  useEffect(() => {
    let raf = 0;
    let speed = 0;
    let start = performance.now();
    const tick = (t: number) => {
      const dt = Math.min(32, t - start);
      start = t;
      // accelerate then clamp
      speed = Math.min(spinning ? 1.6 : speed - 0.05, 1.6);
      if (!spinning) speed = Math.max(0, speed);
      setOffset(o => (o + dt * 0.2 * speed) % (items.length * 64));
      raf = requestAnimationFrame(tick);
    };
    raf = requestAnimationFrame(tick);
    return () => cancelAnimationFrame(raf);
  }, [spinning, items.length]);

  // Snap to stopIndex when told to stop
  useEffect(() => {
    if (stopIndex == null) return;
    // smooth snap
    const target = stopIndex * 64; // each cell height
    const id = setTimeout(() => setOffset(target), delay);
    return () => clearTimeout(id);
  }, [stopIndex, delay]);

  const visible = useMemo(() => {
    // Build a looping list
    const extended = [...items, ...items, ...items];
    return extended;
  }, [items]);

  return (
    <div className="h-40 w-24 overflow-hidden rounded-xl ring-2 ring-white/10 bg-black/20 backdrop-blur-sm">
      <div
        ref={reelRef}
        style={{ transform: `translateY(${-offset}px)` }}
        className="transition-transform duration-500"
      >
        {visible.map((it, i) => (
          <div key={i} className="h-16 flex items-center justify-center">
            <div className={`px-2 py-1 rounded-md text-xs ring-2 ${rarityRing(it.rarity)} bg-white/5`}>{it.name}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// --- Battle FX Overlay ---
function BattleFX({ show, onDone }: { show: boolean; onDone: () => void }) {
  useEffect(() => {
    if (show) {
      haptic([20, 40, 20]);
      const id = setTimeout(onDone, 650);
      return () => clearTimeout(id);
    }
  }, [show, onDone]);

  return (
    <AnimatePresence>
      {show && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.2 }}
          className="absolute inset-0 pointer-events-none"
        >
          <motion.div
            initial={{ scale: 0.9, opacity: 0 }}
            animate={{ scale: 1.1, opacity: 1 }}
            exit={{ scale: 1.0, opacity: 0 }}
            transition={{ duration: 0.6, ease: "easeOut" }}
            className="absolute inset-0 bg-white/5"
          />
          <div className="absolute inset-0 bg-radial from-white/40 via-transparent to-transparent" />
        </motion.div>
      )}
    </AnimatePresence>
  );
}

// --- JPG Stage (placeholder with motion) ---
function StageImage({ label }: { label: string }) {
  return (
    <motion.div
      key={label}
      initial={{ opacity: 0, scale: 1.05 }}
      animate={{ opacity: 1, scale: 1 }}
      exit={{ opacity: 0, scale: 0.98 }}
      transition={{ duration: 0.4 }}
      className="relative h-64 w-full overflow-hidden rounded-2xl"
    >
      <div className="absolute inset-0 bg-gradient-to-br from-indigo-600 via-fuchsia-600 to-amber-500 opacity-60" />
      <div className="absolute inset-0 mix-blend-overlay bg-[url('https://images.unsplash.com/photo-1542751371-adc38448a05e?q=80&w=1200&auto=format&fit=crop')] bg-cover bg-center" />
      <div className="absolute inset-0 backdrop-blur-[1px]" />
      <div className="absolute bottom-2 left-3 text-white/90 text-sm font-semibold drop-shadow-lg">
        {label}
      </div>
    </motion.div>
  );
}

// --- Main Component ---
export default function MobileRogueSlot() {
  const [view, setView] = useState<View>("hub");
  const [hp, setHp] = useState(20);
  const [coinsAmt, setCoins] = useState(0);
  const [inventory, setInventory] = useState<Item[]>([]);

  const [currentEnemy, setCurrentEnemy] = useState<Enemy | null>(null);
  const [battleFx, setBattleFx] = useState(false);

  // Rewards/slot state
  const [spinning, setSpinning] = useState(false);
  const [stops, setStops] = useState<(number | null)[]>([null, null, null]);
  const [slotLoot, setSlotLoot] = useState<Item[]>([pickLoot(), pickLoot(), pickLoot()]);

  // Start a battle
  const beginBattle = () => {
    setCurrentEnemy(sample(ENEMIES));
    setView("battle");
  };

  const endBattleToRewards = () => {
    setView("rewards");
    requestAnimationFrame(() => {
      haptic(30);
      setSpinning(true);
      setStops([null, null, null]);
      // Automatically schedule stops
      setTimeout(() => setStops(([a, b, c]) => [rand(slotLoot.length), b, c]), 700);
      setTimeout(() => setStops(([a, b, c]) => [a, rand(slotLoot.length), c]), 1200);
      setTimeout(() => setStops(([a, b, c]) => [a, b, rand(slotLoot.length)]), 1700);
      // end spin
      setTimeout(() => setSpinning(false), 2000);
    });
  };

  const applyStrike = () => {
    // simple resolution: win if hp + coin buff >= enemy power (mock)
    if (!currentEnemy) return;
    setBattleFx(true);
    const win = hp >= currentEnemy.power || Math.random() > 0.35;
    setTimeout(() => {
      setBattleFx(false);
      if (win) {
        setCoins(c => c + 3);
        endBattleToRewards();
      } else {
        setHp(h => Math.max(1, h - 3));
        // stay in battle for another choice
      }
    }, 650);
  };

  const applyGuard = () => {
    setBattleFx(true);
    setTimeout(() => {
      setBattleFx(false);
      setHp(h => Math.min(20, h + 1));
    }, 650);
  };

  const flee = () => {
    haptic(10);
    setView("hub");
  };

  // Collect slot results
  const collectRewards = () => {
    const chosen: Item[] = stops.map((s) => (s == null ? pickLoot() : slotLoot[s]));
    setInventory(inv => [...chosen, ...inv].slice(0, 12));
    const coinGain = chosen.reduce((sum, it) => sum + (it.id === "coin" ? it.value : 0), 0);
    if (coinGain) setCoins(c => c + coinGain);
    setView("hub");
  };

  // Layout helpers
  const card = "rounded-2xl bg-white/5 border border-white/10 shadow-lg";
  const btn = "px-4 py-3 rounded-2xl active:scale-[.98] transition transform font-medium";

  return (
    <div className="w-full h-full min-h-screen bg-[conic-gradient(at_10%_10%,#0b1021,30%,#151a3a_60%,#12121a_100%)] text-white flex items-center justify-center">
      {/* Phone frame */}
      <div className="w-[380px] max-w-[92vw] aspect-[9/16] bg-black/30 backdrop-blur-xl border border-white/10 rounded-[2rem] overflow-hidden relative">
        {/* HUD */}
        <div className="absolute top-0 left-0 right-0 p-3 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="flex items-center gap-1 px-3 py-1.5 rounded-xl bg-rose-500/20 border border-rose-300/20"><Shield size={16}/><span className="text-sm">HP {hp}</span></div>
            <div className="flex items-center gap-1 px-3 py-1.5 rounded-xl bg-yellow-500/20 border border-yellow-300/20"><Coins size={16}/><span className="text-sm">{coinsAmt}</span></div>
          </div>
          <button className={`${btn} bg-white/10`} onClick={() => setView(v => v === "inventory" ? "hub" : "inventory")}><Backpack className="inline mr-1" size={16}/>Bag</button>
        </div>

        {/* Content */}
        <div className="absolute inset-0 pt-14 pb-4 px-4">
          <AnimatePresence mode="wait">
            {view === "hub" && (
              <motion.div
                key="hub"
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
                transition={{ duration: 0.3 }}
                className="h-full flex flex-col gap-4"
              >
                <StageImage label="Sanctuary — Base" />
                <div className={`p-4 ${card} flex-1 flex flex-col gap-3`}>
                  <h2 className="font-semibold text-lg flex items-center gap-2"><Sparkles size={18}/> Actions</h2>
                  <button className={`${btn} bg-indigo-600`} onClick={beginBattle}><Swords className="inline mr-2"/>Explore (Battle)</button>
                  <button className={`${btn} bg-white/10`} onClick={() => setView("rewards")}><PlayCircle className="inline mr-2"/>Test Slots</button>
                </div>
              </motion.div>
            )}

            {view === "inventory" && (
              <motion.div key="inv" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="h-full flex flex-col gap-4">
                <div className={`p-4 ${card}`}>
                  <h2 className="font-semibold text-lg mb-2 flex items-center gap-2"><Backpack size={18}/> Inventory</h2>
                  {inventory.length === 0 ? (
                    <p className="text-white/60">Empty. Win battles or spin slots to earn loot.</p>
                  ) : (
                    <div className="grid grid-cols-3 gap-2">
                      {inventory.map((it, idx) => (
                        <div key={idx} className={`p-2 ${card} ring-2 ${rarityRing(it.rarity)} text-xs text-center`}>{it.name}</div>
                      ))}
                    </div>
                  )}
                </div>
                <button className={`${btn} bg-white/10`} onClick={() => setView("hub")}>Back</button>
              </motion.div>
            )}

            {view === "battle" && (
              <motion.div key="battle" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="h-full flex flex-col gap-3 relative">
                <StageImage label={currentEnemy ? currentEnemy.name : "Encounter"} />
                <div className={`p-4 ${card} flex flex-col gap-3`}>
                  <div className="text-sm text-white/80">Choose an action. Fast, punchy, minimal.</div>
                  <div className="grid grid-cols-3 gap-2">
                    <button className={`${btn} bg-rose-600`} onClick={applyStrike}><Swords className="inline mr-1" size={16}/>Strike</button>
                    <button className={`${btn} bg-sky-600`} onClick={applyGuard}><Shield className="inline mr-1" size={16}/>Guard</button>
                    <button className={`${btn} bg-white/10`} onClick={flee}><XCircle className="inline mr-1" size={16}/>Flee</button>
                  </div>
                </div>
                <BattleFX show={battleFx} onDone={() => {}} />
              </motion.div>
            )}

            {view === "rewards" && (
              <motion.div key="rewards" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} className="h-full flex flex-col gap-3">
                <StageImage label="Spoils — Slot Chamber" />
                <div className={`p-4 ${card} flex flex-col items-center gap-3`}>
                  <div className="text-sm text-white/80">Spin to reveal loot. (Auto-stops)</div>
                  <div className="flex items-center gap-3">
                    {[0,1,2].map((i) => (
                      <SlotReel key={i} spinning={spinning} stopIndex={stops[i]} items={slotLoot} delay={i * 120} />
                    ))}
                  </div>
                  <div className="flex gap-2 mt-2">
                    <button className={`${btn} bg-indigo-600`} onClick={() => { haptic(20); setSpinning(true); setStops([null,null,null]); setTimeout(() => setStops(([a,b,c]) => [rand(slotLoot.length), b, c]), 700); setTimeout(() => setStops(([a,b,c]) => [a, rand(slotLoot.length), c]), 1200); setTimeout(() => setStops(([a,b,c]) => [a, b, rand(slotLoot.length)]), 1700); setTimeout(() => setSpinning(false), 2000); }}>Spin</button>
                    <button className={`${btn} bg-white/10`} onClick={collectRewards}>Collect</button>
                  </div>
                </div>
                <button className={`${btn} bg-white/10`} onClick={() => setView("hub")}>Back</button>
              </motion.div>
            )}
          </AnimatePresence>
        </div>
      </div>
    </div>
  );
}

// Notes:
// - Replace StageImage's background URL with your own JPGs when ready; they fade and scale for life-like motion.
// - The view layer is a tiny state machine (hub/battle/rewards/inventory) with animated transitions.
// - The slot machine uses programmatic scrolling to avoid heavy libraries and allows precise stops.
// - Haptics (navigator.vibrate) give quick, satisfying feedback on mobile where supported.
// - Keep interactions single-tap and large to feel fast and thumb-friendly in portrait.
