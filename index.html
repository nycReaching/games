<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Synergy Slots — Mobile</title>
  <style>
    /* ===== THEME & LAYOUT GUARANTEES ===== */
    :root {
      --bg: 222 22% 10%;
      --panel: 222 22% 14%;
      --panel-2: 222 22% 18%;
      --text: 210 20% 98%;
      --muted: 216 12% 72%;
      --brand: 268 84% 62%;
      --brand-2: 208 100% 60%;
      --accent: 148 64% 55%;
      --danger: 0 84% 62%;
      --gold: 46 95% 62%;
      --card: 218 22% 22%;
      --shadow: 220 40% 2%;
      --radius: 20px;
      --gap: 10px;
      --grid-gap: 10px;
      --grid-pad: 8px;
      --columns: 5;
      --tile-radius: 18px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);
      --pad-inline: clamp(10px, 4vw, 18px);
      --dock-h: 110px; /* visually reserve space for the spin dock */
      --viw: 100vw; /* fallback inline viewport */
    }
    @supports (width: 100vi) { :root { --viw: 100vi; } }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Apple Color Emoji", "Segoe UI Emoji";
      color: hsl(var(--text));
      background: radial-gradient(1200px 800px at 50% -10%, hsl(var(--brand)/.25), transparent 60%),
                  radial-gradient(1200px 800px at 50% 110%, hsl(var(--brand-2)/.2), transparent 60%),
                  hsl(var(--bg));
      overflow: hidden; /* prevent horizontal scroll */
      overscroll-behavior: none;
    }

    /* Orientation guard */
    #rotate-guard { position: fixed; inset: 0; display: none; place-items: center; z-index: 9999;
      background: linear-gradient(180deg, hsl(var(--panel)/.9), hsl(var(--panel-2)/.9)); backdrop-filter: blur(8px);
      text-align: center; padding: 32px; }
    #rotate-guard.show { display: grid; }
    #rotate-guard .box { background: hsl(var(--card)); border: 1px solid hsl(var(--panel-2)); border-radius: 24px; padding: 28px; box-shadow: 0 20px 60px hsl(var(--shadow)/.7); }

    /* ===== APP WRAPPER ===== */
    .app {
      position: relative; height: 100vh; width: 100%;
      display: grid; grid-template-rows: auto auto 1fr; gap: var(--gap);
      padding-top: calc(8px + var(--safe-top));
      padding-left: calc(var(--pad-inline) + var(--safe-left));
      padding-right: calc(var(--pad-inline) + var(--safe-right));
      padding-bottom: calc(var(--dock-h) + var(--safe-bottom)); /* reserve FAB dock */
      overflow: clip; /* ensure no bleed */
    }
    @supports(height: 100svh){ .app { height: 100svh; } }

    /* ===== TOP BAR & HUD ===== */
    .topbar { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px; }
    .brand { display: inline-flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 999px;
      background: linear-gradient(135deg, hsl(var(--panel)), hsl(var(--panel-2))); border: 1px solid hsl(var(--panel-2));
      box-shadow: inset 0 1px 0 hsl(0 0% 100%/.05), 0 4px 20px hsl(var(--shadow)/.5); font-weight: 800; letter-spacing: .5px; }
    .brand .logo { width: 28px; height: 28px; border-radius: 8px; display: grid; place-items: center; font-size: 16px; color: white; font-weight: 900;
      background: conic-gradient(from 200deg, hsl(var(--brand)), hsl(var(--brand-2)), hsl(var(--accent)), hsl(var(--brand))); box-shadow: 0 6px 18px hsl(var(--brand)/.4); }
    .toolbar { display: inline-flex; gap: 8px; }
    .icon-btn { width: 38px; height: 38px; border-radius: 12px; display: grid; place-items: center; cursor: pointer; position: relative;
      background: linear-gradient(180deg, hsl(var(--panel)), hsl(var(--panel-2))); border: 1px solid hsl(var(--panel-2));
      box-shadow: inset 0 1px 0 hsl(0 0% 100%/.06), 0 4px 16px hsl(var(--shadow)/.6); transition: transform .06s ease; }
    .icon-btn:active { transform: translateY(1px) scale(.98); }

    .hudbar { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: stretch; }
    .wallet { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius: 14px; font-weight: 900; letter-spacing:.4px;
      background: linear-gradient(135deg, hsl(var(--brand)/.35), hsl(var(--brand-2)/.25)); border:1px solid hsl(var(--panel-2));
      box-shadow: 0 8px 24px hsl(var(--brand)/.3), inset 0 1px 0 hsl(0 0% 100%/.1); }
    .wallet .ico { font-size: 20px; }
    .hud-pill { display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius: 12px; font-weight:800;
      background: linear-gradient(180deg, hsl(var(--panel)), hsl(var(--panel-2))); border:1px solid hsl(var(--panel-2));
      box-shadow: 0 6px 18px hsl(var(--shadow)/.6), inset 0 1px 0 hsl(0 0% 100%/.06); }

    /* ===== TAG RAIL ===== */
    .tag-rail { display:flex; gap:8px; overflow-x:auto; padding: 2px 2px 4px; -webkit-overflow-scrolling: touch; }
    .tag-chip { flex:0 0 auto; display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:800;
      background:hsl(var(--panel)); border:1px solid hsl(var(--panel-2)); opacity:.95; }

    /* ===== STAGE & GRID (no-cutoff guarantee) ===== */
    .stage { position: relative; display:grid; place-items:center; padding: 6px 0; }
    .grid {
      /* exact-fit size: compute tile from inline viewport minus paddings & gaps */
      --tile-size: calc((var(--viw) - (2 * var(--pad-inline)) - var(--safe-left) - var(--safe-right) - (2 * var(--grid-pad)) - ((var(--columns) - 1) * var(--grid-gap))) / var(--columns));
      display:grid; grid-template-columns: repeat(var(--columns), var(--tile-size));
      grid-template-rows: repeat(3, var(--tile-size));
      gap: var(--grid-gap); padding: var(--grid-pad);
      border-radius: calc(var(--radius) * 1.2);
      background: linear-gradient(180deg, hsl(var(--panel)/.6), hsl(var(--panel-2)/.8));
      border: 1px solid hsl(var(--panel-2));
      box-shadow: inset 0 2px 0 hsl(0 0% 100%/.04), 0 20px 50px hsl(var(--shadow)/.65);
      width: calc((var(--tile-size) * var(--columns)) + ((var(--columns) - 1) * var(--grid-gap)) + (2 * var(--grid-pad)));
      max-width: calc(100% - var(--safe-left) - var(--safe-right));
      justify-content: center; margin-inline: auto;
      position: relative; overflow: visible;
    }

    .tile { position: relative; display:grid; grid-template-rows: 1fr auto; align-items:center; justify-items:center; border-radius: var(--tile-radius);
      user-select: none; overflow: hidden; padding: 6px; isolation: isolate; transform: translateZ(0);
      background: linear-gradient(180deg, hsl(var(--card)), hsl(var(--panel-2))); border: 1px solid hsl(var(--panel-2));
      box-shadow: inset 0 1px 0 hsl(0 0% 100%/.06), 0 10px 24px hsl(var(--shadow)/.75);
    }
    .tile .emoji { font-size: clamp(24px, 7.6vw, 48px); filter: drop-shadow(0 6px 12px rgba(0,0,0,.4)); }
    .tile .label { font-size: clamp(10px, 2.6vw, 13px); opacity: .8; font-weight: 700; letter-spacing: .2px; }
    .tile .badge { position: absolute; top: 6px; left: 6px; font-size: 10px; padding: 4px 6px; border-radius: 999px;
      background: hsl(var(--panel)); border: 1px solid hsl(var(--panel-2)); opacity: .9; font-weight: 800; }
    .tile.locked::after { content: "🔒"; position: absolute; top: 6px; right: 6px; }

    .toast { position: absolute; bottom: 6px; left: 50%; transform: translate(-50%, 10px); font-size: 11px; padding: 4px 8px; border-radius: 10px; white-space: nowrap;
      background: hsl(var(--panel)/.85); border: 1px solid hsl(var(--panel-2)); opacity: 0; box-shadow: 0 10px 20px hsl(var(--shadow)/.7); pointer-events: none;
      transition: opacity .25s ease, transform .25s ease; }
    .toast.show { opacity: 1; transform: translate(-50%, 0); }

    /* Spin animation */
    @keyframes spinA { from { filter: blur(0px); transform: translateY(0) scale(1); } 25% { filter: blur(2px); }
      50% { transform: translateY(-10%) scale(0.98); } 75% { filter: blur(1px); } to { filter: blur(0px); transform: translateY(0) scale(1);} }
    .spinning .tile { animation: spinA .55s ease; }

    /* ===== CONTROL DOCK (creative layout) ===== */
    .dock { position: fixed; left: 0; right: 0; bottom: 0; z-index: 60; pointer-events: none; }
    .dock-inner { pointer-events: auto; margin: 0 auto; width: min(760px, calc(100% - var(--safe-left) - var(--safe-right))); padding-bottom: calc(8px + var(--safe-bottom));
      display:grid; place-items:center; }
    .segmented { display:grid; grid-template-columns: repeat(3,1fr); gap: 8px; width: 100%; padding: 0 var(--pad-inline); }
    .seg-btn { appearance:none; border:1px solid hsl(var(--panel-2)); border-radius: 16px; padding: 12px; font-weight: 800; letter-spacing:.4px;
      background: linear-gradient(180deg, hsl(var(--panel)), hsl(var(--panel-2))); color:hsl(var(--text)); box-shadow: 0 12px 30px hsl(var(--shadow)/.6), inset 0 1px 0 hsl(0 0% 100%/.06); }

    .fab-wrap { position: relative; width: 100%; height: 0; }
    .fab-spin { position: absolute; left: 50%; bottom: 10px; transform: translateX(-50%);
      width: 92px; height: 92px; border-radius: 999px; appearance:none; border:none; cursor:pointer; color:white;
      font-weight: 900; letter-spacing:.6px; font-size: 18px; text-shadow: 0 2px 8px rgba(0,0,0,.4);
      background: radial-gradient(60% 60% at 50% 35%, hsl(var(--gold)/.95), hsl(var(--brand-2)) 60%), linear-gradient(135deg, hsl(var(--brand)), hsl(var(--brand-2)));
      box-shadow: 0 24px 60px hsl(var(--brand)/.55), 0 12px 20px hsl(var(--shadow)/.7), inset 0 1px 0 hsl(0 0% 100%/.2);
    }
    .fab-spin:disabled { opacity:.6; filter: saturate(.7); }
    .spin-sub { position:absolute; top:-18px; left:50%; transform:translateX(-50%); font-size:12px; font-weight:800; opacity:.9; }

    /* Drawers (Inventory / Shop) */
    .drawer { position: fixed; left: 0; right: 0; bottom: 0; z-index: 70; transform: translateY(105%);
      transition: transform .28s cubic-bezier(.2,.9,.2,1); }
    .drawer.open { transform: translateY(0); }
    .sheet { margin: 0 auto; width: min(640px, 100%); background: linear-gradient(180deg, hsl(var(--panel)), hsl(var(--panel-2)));
      border-radius: 24px 24px 0 0; border: 1px solid hsl(var(--panel-2)); box-shadow: 0 -20px 60px hsl(var(--shadow)/.7);
      padding: 12px 12px calc(18px + env(safe-area-inset-bottom)); }
    .sheet .handle { width: 48px; height: 5px; border-radius: 999px; background: hsl(var(--panel-2)); margin: 8px auto 12px; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .title { font-weight: 900; font-size: 18px; letter-spacing: .4px; }
    .grid-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 12px; }
    .card { background: linear-gradient(180deg, hsl(var(--card)), hsl(var(--panel-2))); border: 1px solid hsl(var(--panel-2)); border-radius: 16px; padding: 10px; display: grid; gap: 6px;
      box-shadow: inset 0 1px 0 hsl(0 0% 100%/.06), 0 10px 30px hsl(var(--shadow)/.7); }
    .card .name { font-weight: 900; font-size: 14px; }
    .card .desc { font-size: 12px; opacity: .8; }
    .tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 800; background: hsl(var(--panel)); border: 1px solid hsl(var(--panel-2)); }
    .tiny { font-size: 11px; opacity: .8; }

    .hidden { display:none !important; }
  </style>
</head>
<body>
  <div id="rotate-guard">
    <div class="box">
      <div style="font-size:42px">📱↩️</div>
      <h2 style="margin:10px 0 6px">Please rotate to portrait</h2>
      <p class="muted">This prototype is tuned for vertical play.</p>
    </div>
  </div>

  <main class="app">
    <!-- Top Bar -->
    <div class="topbar">
      <div class="brand"><div class="logo">S</div> Synergy Slots</div>
      <div class="toolbar">
        <button class="icon-btn" id="btnHelp" title="Help">❔</button>
        <button class="icon-btn" id="btnSettings" title="Settings">⚙️</button>
      </div>
    </div>

    <!-- HUD -->
    <div class="hudbar">
      <div class="wallet" title="Coins"><span class="ico">🪙</span><span id="coins">0</span></div>
      <div class="hud-pill" title="HP">❤️ <span id="hp">3</span></div>
      <div class="hud-pill" title="Turn">📅 <span id="turn">1</span></div>
    </div>

    <!-- Deck Tag Overview -->
    <div class="tag-rail" id="tagRail" aria-label="Deck tags"></div>

    <!-- Stage -->
    <section class="stage">
      <div class="grid" id="grid"></div>
    </section>
  </main>

  <!-- Spin Dock -->
  <div class="dock">
    <div class="dock-inner">
      <div class="spin-sub" id="lastPayout">Last: +0</div>
      <div class="fab-wrap">
        <button class="fab-spin" id="btnSpin">SPIN</button>
      </div>
      <div class="segmented" role="group" aria-label="Actions">
        <button class="seg-btn" id="btnInventory">Inventory</button>
        <button class="seg-btn" id="btnReroll">Reroll (<span id="rerollCost">1</span>)</button>
        <button class="seg-btn" id="btnShop">Shop</button>
      </div>
    </div>
  </div>

  <!-- Inventory Drawer -->
  <div class="drawer" id="drawerInventory" aria-hidden="true">
    <div class="sheet">
      <div class="handle"></div>
      <div class="row">
        <div class="title">Deck & Inventory</div>
        <button class="seg-btn" id="btnCloseInv">Close</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">Tap a card to toggle it in the deck. Tap a grid tile to lock/unlock between spins.</div>
      <h4 style="margin:10px 0 4px">In Deck</h4>
      <div class="grid-cards" id="deckCards"></div>
      <h4 style="margin:10px 0 4px">Collection</h4>
      <div class="grid-cards" id="collectionCards"></div>
    </div>
  </div>

  <!-- Shop Drawer -->
  <div class="drawer" id="drawerShop" aria-hidden="true">
    <div class="sheet">
      <div class="handle"></div>
      <div class="row">
        <div class="title">Shop</div>
        <button class="seg-btn" id="btnCloseShop">Close</button>
      </div>
      <div class="tiny muted" style="margin-top:6px">Buy symbols to add to your collection. Reroll for new offers.</div>
      <div class="grid-cards" id="shopCards"></div>
    </div>
  </div>

  <script>
  // ======= DATA =======
  const SYMBOLS = [
    { id: 'cherry', name: 'Cherry', emoji: '🍒', base: 1, tags: ['fruit'], color: '#FF6B6B', desc: '+1 base. Pairs with other fruit.' },
    { id: 'lemon', name: 'Lemon', emoji: '🍋', base: 1, tags: ['fruit'], color: '#FFD166', desc: '+1 base. Pairs with other fruit.' },
    { id: 'seven', name: 'Seven', emoji: '7️⃣', base: 3, tags: ['lucky'], color: '#B197FC', desc: 'Lucky 7! Solid base value.' },
    { id: 'clover', name: 'Clover', emoji: '☘️', base: 1, tags: ['lucky'], color: '#2DD4BF', desc: 'Doubles adjacent scores.' },
    { id: 'diamond', name: 'Diamond', emoji: '💎', base: 2, tags: ['gem'], color: '#60A5FA', desc: '1.5x all gems on board.' },
    { id: 'star', name: 'Star', emoji: '⭐', base: 2, tags: ['wild'], color: '#F7D154', desc: '+1 per unique tag this spin.' },
    { id: 'gear', name: 'Gear', emoji: '⚙️', base: 1, tags: ['mech'], color: '#94A3B8', desc: '+1 per other mech on board.' },
    { id: 'bomb', name: 'Bomb', emoji: '💣', base: 0, tags: ['item'], color: '#FB7185', desc: '+3 if next to any fruit.' },
    { id: 'heart', name: 'Heart', emoji: '❤️', base: 1, tags: ['life'], color: '#F43F5E', desc: '3+ hearts heal 1 HP.' },
    { id: 'bar', name: 'BAR', emoji: '🧱', base: 2, tags: ['bar'], color: '#F59E0B', desc: 'Sturdy payout.' },
  ];

  const START_DECK = ['cherry','lemon','seven','bar','cherry','lemon','cherry','gear','star','bar','heart','diamond','clover','lemon','cherry'];

  const state = {
    coins: 10,
    hp: 3,
    turn: 1,
    deck: [...START_DECK], // multiset by id
    collection: [...new Set(START_DECK)],
    grid: Array(15).fill(null),
    locked: new Set(), // indexes locked between spins
    rerollCost: 1,
    shop: [],
    lastPayout: 0,
    settings: { haptics: true, speed: 1 }
  };

  const $ = sel => document.querySelector(sel);

  // ======= UI HELPERS =======
  function setText(id, val){ const el = (typeof id === 'string') ? document.getElementById(id) : id; if (el) el.textContent = val; }
  function vibrate(ms){ try { if (state.settings.haptics && navigator.vibrate) navigator.vibrate(ms); } catch(e){} }
  function toast(el, text){ let t = el.querySelector('.toast'); if(!t){ t = document.createElement('div'); t.className = 'toast'; el.appendChild(t); }
    t.textContent = text; requestAnimationFrame(()=>{ t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }); }

  function openDrawer(id){ const d = $(id); d.classList.add('open'); d.setAttribute('aria-hidden','false'); }
  function closeDrawer(id){ const d = $(id); d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }

  function checkOrientation(){ const portrait = window.innerHeight >= window.innerWidth; $('#rotate-guard').classList.toggle('show', !portrait); }
  addEventListener('resize', checkOrientation);

  // ======= HUD & TAG RAIL =======
  function renderHUD(){ setText('coins', state.coins); setText('hp', state.hp); setText('turn', state.turn); setText('rerollCost', state.rerollCost); setText('lastPayout', `Last: +${Math.round(state.lastPayout)}`); }

  function renderTagRail(){
    const rail = $('#tagRail'); if (!rail) return; rail.innerHTML = '';
    const counts = new Map();
    state.deck.forEach(id=>{ const s = SYMBOLS.find(x=>x.id===id); (s?.tags||[]).forEach(t=> counts.set(t, (counts.get(t)||0)+1)); });
    const items = Array.from(counts.entries()).sort((a,b)=> b[1]-a[1]).slice(0,6);
    if (items.length===0) { const chip = document.createElement('div'); chip.className='tag-chip'; chip.textContent = 'No tags yet'; rail.appendChild(chip); return; }
    items.forEach(([tag, n])=>{ const chip = document.createElement('div'); chip.className='tag-chip'; chip.textContent = `${tag} • x${n}`; rail.appendChild(chip); });
  }

  // ======= GRID RENDER =======
  function makeTile(symId, idx){
    const sym = SYMBOLS.find(s=>s.id===symId) || { name:'Empty', emoji:'', base:0, tags:[] };
    const el = document.createElement('div'); el.className = 'tile'; el.dataset.index = idx; el.dataset.id = symId || '';
    const em = document.createElement('div'); em.className = 'emoji'; em.textContent = sym.emoji;
    const lb = document.createElement('div'); lb.className = 'label'; lb.textContent = sym.name;
    el.appendChild(em); el.appendChild(lb);
    el.addEventListener('click', ()=>{ const i = Number(el.dataset.index); if (state.locked.has(i)) { state.locked.delete(i); el.classList.remove('locked'); toast(el,'Unlocked'); } else { state.locked.add(i); el.classList.add('locked'); toast(el,'Locked'); } });
    el.addEventListener('contextmenu', (e)=>{ e.preventDefault(); alert(`${sym.name}\n\nTags: ${sym.tags.join(', ') || '—'}\nBase: ${sym.base}\n\n${sym.desc||''}`); });
    return el;
  }

  function renderGrid(){ const wrap = $('#grid'); wrap.innerHTML = ''; state.grid.forEach((id, i)=>{ const t = makeTile(id, i); if(state.locked.has(i)) t.classList.add('locked'); wrap.appendChild(t); }); }

  // ======= SPIN / SCORING =======
  function randomFromDeck(){ if (!state.deck.length) return null; const pool = state.deck.flatMap(id=>{ const s = SYMBOLS.find(x=>x.id===id); const w = (s && (s.base <= 1 ? 3 : 1)); return Array(w).fill(id); }); return pool[Math.floor(Math.random()*pool.length)] || state.deck[Math.floor(Math.random()*state.deck.length)]; }

  function neighbors(idx){ const col = idx % 5; const row = Math.floor(idx / 5); const list = []; const push = i => { if (i>=0 && i<15) list.push(i); }; if (col>0) push(idx-1); if (col<4) push(idx+1); if (row>0) push(idx-5); if (row<2) push(idx+5); return list; }

  function spin(){
    const btn = $('#btnSpin'); if (btn.disabled) return;
    if (state.coins <= 0) { vibrate(60); alert('You need coins to spin! Try the shop or synergies to earn more.'); return; }
    state.coins -= 1; renderHUD();
    state.grid = state.grid.map((id, i)=> state.locked.has(i) ? id : randomFromDeck());
    const gridEl = $('#grid'); gridEl.classList.add('spinning');
    setTimeout(()=>{
      gridEl.classList.remove('spinning'); renderGrid();
      const { total, notes } = scoreGrid(); state.lastPayout = total; state.coins += Math.round(total); state.turn += 1; renderHUD(); vibrate(20);
      notes.forEach(n=>{ const tile = gridEl.children[n.index]; if (!tile) return; toast(tile, `+${n.delta} ${n.reason}`); });
      const heartCount = state.grid.filter(id=>id==='heart').length; if (heartCount >= 3) { state.hp = Math.min(5, state.hp + 1); renderHUD(); }
    }, 560 / state.settings.speed);
  }

  function scoreGrid(){
    const tiles = state.grid.map(id => SYMBOLS.find(s=>s.id===id));
    const countsByTag = new Map(); tiles.forEach(s => (s?.tags||[]).forEach(t=> countsByTag.set(t,(countsByTag.get(t)||0)+1)));
    let total = 0; const notes = []; const mult = Array(15).fill(1); let gemBoost = 1;
    const gems = tiles.filter(s=>s?.tags.includes('gem')).length; if (gems>0 && tiles.some(s=>s?.id==='diamond')) gemBoost = 1.5;
    tiles.forEach((s, i)=>{ if (!s) return; total += s.base; notes.push({ index: i, delta: s.base, reason: s.name });
      const ns = neighbors(i); ns.forEach(j=>{ const t = tiles[j]; if (!t) return; if (s.tags.some(tag => t.tags.includes(tag))) { total += .5; notes.push({ index: i, delta: .5, reason: 'pair'}); } });
      if (s.id==='clover') { neighbors(i).forEach(j=> mult[j]*=2); notes.push({ index: i, delta: 0, reason: '×2 aura' }); }
      if (s.id==='gear') { const others = tiles.filter(x=>x?.tags.includes('mech')).length - 1; if (others>0) { total += others; notes.push({ index: i, delta: others, reason: '+mech' }); } }
      if (s.id==='bomb') { const anyFruit = neighbors(i).some(j=> tiles[j]?.tags.includes('fruit')); if (anyFruit) { total += 3; notes.push({ index: i, delta: 3, reason: '+bomb' }); } }
      if (s.id==='star') { total += countsByTag.size; notes.push({ index: i, delta: countsByTag.size, reason: '+unique' }); }
    });
    total = 0; tiles.forEach((s,i)=>{ if (!s) return; let t = s.base; neighbors(i).forEach(j=>{ const u = tiles[j]; if (u && s.tags.some(tag=>u.tags.includes(tag))) t += .5; }); if (s.id==='gear') { const others = tiles.filter(x=>x?.tags.includes('mech')).length - 1; t += Math.max(0, others); } if (s.id==='bomb') { const anyFruit = neighbors(i).some(j=> tiles[j]?.tags.includes('fruit')); if (anyFruit) t += 3; } if (s.id==='star') { t += countsByTag.size; } if (s.tags.includes('gem')) t *= gemBoost; t *= mult[i]; total += t; });
    mult.forEach((m,i)=>{ if (m>1) notes.push({ index: i, delta: `×${m}`, reason: 'mult' }); }); if (gemBoost>1) tiles.forEach((s,i)=>{ if (s?.tags.includes('gem')) notes.push({ index: i, delta: '×1.5', reason: 'gem' }); });
    return { total, notes };
  }

  // ======= INVENTORY / SHOP =======
  function renderCard(symId, opts={}){ const s = SYMBOLS.find(x=>x.id===symId); const el = document.createElement('div'); el.className = 'card';
    const name = document.createElement('div'); name.className = 'name'; name.textContent = `${s.emoji} ${s.name}`;
    const row = document.createElement('div'); row.className = 'row';
    const tagBox = document.createElement('div'); s.tags.forEach(t=>{ const tg = document.createElement('span'); tg.className='tag'; tg.textContent = t; tagBox.appendChild(tg); });
    const add = document.createElement('button'); add.className = 'seg-btn'; add.textContent = opts.cta || 'Toggle';
    const desc = document.createElement('div'); desc.className='desc'; desc.textContent = s.desc;
    row.appendChild(tagBox); row.appendChild(add); el.appendChild(name); el.appendChild(row); el.appendChild(desc);
    if (opts.onClick) add.addEventListener('click', opts.onClick); return el; }

  function renderInventory(){ const deckWrap = document.getElementById('deckCards'); const colWrap = document.getElementById('collectionCards'); deckWrap.innerHTML = ''; colWrap.innerHTML = '';
    const deckCounts = Object.fromEntries(state.deck.reduce((m,id)=> (m.set(id,(m.get(id)||0)+1), m), new Map()));
    const addToDeck = (id)=>{ state.deck.push(id); renderInventory(); renderTagRail(); };
    const removeFromDeck = (id)=>{ const i = state.deck.indexOf(id); if (i>=0) state.deck.splice(i,1); renderInventory(); renderTagRail(); };
    Object.keys(deckCounts).forEach(id=>{ const c = deckCounts[id]; const card = renderCard(id, { cta: `Remove (x${c})`, onClick: ()=> removeFromDeck(id) }); deckWrap.appendChild(card); });
    state.collection.forEach(id=>{ const card = renderCard(id, { cta: 'Add', onClick: ()=> addToDeck(id) }); colWrap.appendChild(card); }); }

  function rollShop(){ const pool = SYMBOLS.map(s=>s.id); state.shop = Array.from({length: 6}, ()=> pool[Math.floor(Math.random()*pool.length)]); }
  function priceOf(id){ const s = SYMBOLS.find(x=>x.id===id); return Math.max(1, s.base + (s.tags.includes('gem')?2:0) + (s.id==='clover'?2:0)); }

  function renderShop(){ const wrap = document.getElementById('shopCards'); wrap.innerHTML = ''; state.shop.forEach(id=>{ const price = priceOf(id);
      const card = renderCard(id, { cta: `Buy • ${price}🪙`, onClick: ()=>{ if (state.coins < price) { vibrate(60); alert('Not enough coins!'); return; } state.coins -= price; if (!state.collection.includes(id)) state.collection.push(id); state.deck.push(id); renderHUD(); renderInventory(); renderShop(); renderTagRail(); }});
      wrap.appendChild(card); }); }

  // ======= INIT =======
  function firstFill(){ state.grid = state.grid.map(()=> randomFromDeck()); }

  function attach(){
    document.getElementById('btnSpin').addEventListener('click', spin);
    document.getElementById('btnInventory').addEventListener('click', ()=>{ renderInventory(); openDrawer('#drawerInventory'); });
    document.getElementById('btnCloseInv').addEventListener('click', ()=> closeDrawer('#drawerInventory'));
    document.getElementById('btnShop').addEventListener('click', ()=>{ renderShop(); openDrawer('#drawerShop'); });
    document.getElementById('btnCloseShop').addEventListener('click', ()=> closeDrawer('#drawerShop'));
    document.getElementById('btnReroll').addEventListener('click', ()=>{ if (state.coins < state.rerollCost) { vibrate(60); alert('Not enough coins to reroll the shop.'); return; } state.coins -= state.rerollCost; state.rerollCost += 1; rollShop(); renderShop(); renderHUD(); });
    document.getElementById('btnSettings').addEventListener('click', ()=>{
      const h = confirm(`Haptics (vibrate) is currently ${state.settings.haptics ? 'ON' : 'OFF'}.\n\nOK = toggle, Cancel = keep`);
      if (h) state.settings.haptics = !state.settings.haptics;
    });
    document.getElementById('btnHelp').addEventListener('click', ()=>{
      alert(`How to play:\n\n• Tap SPIN to roll the 5×3 grid from your deck.\n• Matching tags next to each other add bonus.\n• Specials like Clover (×2 aura) and Diamond (×1.5 gems) boost scores.\n• Tap a grid tile to lock it.\n• Inventory manages your deck; Shop adds new symbols; Reroll refreshes the Shop.`);
    });
  }

  function load(){ try { const saved = JSON.parse(localStorage.getItem('synergy-slots-v1')||'null'); if (saved) Object.assign(state, saved, { locked: new Set(saved.locked||[]) }); } catch(e){} }
  function save(){ const toSave = { ...state, locked: Array.from(state.locked) }; localStorage.setItem('synergy-slots-v1', JSON.stringify(toSave)); }
  addEventListener('beforeunload', save);

  function start(){ checkOrientation(); load(); if (state.grid.every(x=>x===null)) firstFill(); renderHUD(); renderTagRail(); renderGrid(); rollShop(); attach(); }
  start();

  // ======= TESTS (smoke) =======
  function runTests(){
    const results = [];
    const ok = (name, cond) => { if (!cond) throw new Error(name); results.push(name); };

    // neighbors edges
    ok('neighbors(0) has right & down', JSON.stringify(neighbors(0).sort()) === JSON.stringify([1,5]));
    ok('neighbors(4) has left & down', JSON.stringify(neighbors(4).sort()) === JSON.stringify([3,9]));
    ok('neighbors(7) has 4 dirs', neighbors(7).length === 4);

    // makeTile returns element
    const t = makeTile('cherry', 0); ok('makeTile returns .tile', t.classList.contains('tile'));

    // scoreGrid shape
    const prev = [...state.grid];
    state.grid = Array(15).fill('cherry');
    const sc = scoreGrid();
    ok('scoreGrid returns number total', typeof sc.total === 'number');
    ok('scoreGrid returns notes array', Array.isArray(sc.notes));
    state.grid = prev;

    // responsive fit: grid width <= viewport
    const gridEl = document.getElementById('grid');
    const r = gridEl.getBoundingClientRect();
    ok('grid fits within viewport width', r.right <= document.documentElement.clientWidth + 0.5);

    console.log(`✅ Smoke tests passed (${results.length})`, results);
  }
  try { setTimeout(runTests, 0); } catch (e) { console.warn('Tests failed:', e); }
  </script>
</body>
</html>
