<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Food Slot Machine - Polished</title>
    <style>
        /* style.css - Visual Polish Overhaul v8 - Layout & Animation Fix */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');

        /* --- New "Blueprint" Theme --- */
        :root {
            /* Primary Palette - Greys & Blues */
            --bg-main: #222831; /* Dark Charcoal */
            --bg-panel: #393E46; /* Slate Grey */
            --bg-panel-accent: #2d323a; /* Darker Slate for depth */
            --bg-navbar: #1a1d23; /* Near Black */
            --bg-modal: #2a2f38; /* Slightly lighter modal background */
            --text-primary-light: #EEEEEE; /* Off-white for readability */
            --text-primary-dark: #222831; /* Dark Charcoal for light backgrounds */
            --text-secondary: #B0B8C4; /* Muted grey for less important text */

            /* Accent Colors (Blueprint & Amber) */
            --accent-primary: #00ADB5; /* Main Teal/Blue Accent */
            --accent-secondary: #FFC107; /* Amber for highlights, warnings, and wins */
            --accent-red: #E84545; /* Error / Loss Red */
            --accent-green: #90D26D; /* Success Green */

            /* Multiplier Colors */
            --multiplier-2x-color: #00ADB5;
            --multiplier-3x-color: #5C6BC0; /* Indigo */
            --multiplier-5x-color: #FF7043; /* Deep Orange */

            --font-primary: 'Roboto Mono', monospace;
            --border-radius-main: 4px; /* Sharper corners */
            --border-radius-small: 2px;
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.3);
            --shadow-strong: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        /* --- Cosmic & Quantum Themes (Adjusted for new base) --- */
        body.cosmic-theme {
            --bg-main: #000428; --bg-panel: #004e92; --bg-panel-accent: #1a6f9f;
            --text-primary-light: #E0E7FF; --text-secondary: #A5B4FC;
            background: radial-gradient(ellipse at bottom, var(--bg-main) 0%, #000 100%);
        }
        body.quantum-theme {
            --bg-main: #0D2A24; --bg-panel: #04443A; --bg-panel-accent: #065F46;
            --text-primary-light: #ECFDF5; --text-secondary: #A7F3D0;
            background-color: var(--bg-main);
            background-image: linear-gradient(var(--bg-panel-accent) 1px, transparent 1px), linear-gradient(to right, var(--bg-panel-accent) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        @keyframes pulseWarningBorder {
            0%, 100% { border-color: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }
            50% { border-color: var(--accent-secondary); box-shadow: 0 0 12px var(--accent-secondary); }
        }
        @keyframes pulseSymbol {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.4); color: var(--accent-secondary); }
        }
        @keyframes glow {
            0% { box-shadow: 0 0 4px var(--accent-primary); }
            50% { box-shadow: 0 0 10px var(--accent-primary), 0 0 14px var(--accent-primary); }
            100% { box-shadow: 0 0 4px var(--accent-primary); }
        }
       
        /* --- NEW FEEDBACK ANIMATION --- */
        @keyframes feedback-animation {
            0% { transform: translateY(0) scale(0.9); opacity: 1; }
            80% { transform: translateY(-80px) scale(1.1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.1); opacity: 0; }
        }
        .feedback-item {
            position: absolute;
            padding: 8px 16px;
            background-color: rgba(26, 29, 35, 0.9);
            border: 1px solid var(--accent-secondary);
            border-radius: var(--border-radius-main);
            color: var(--text-primary-light);
            font-size: 1.1rem;
            font-weight: 700;
            z-index: 2000;
            pointer-events: none;
            animation: feedback-animation 2.5s ease-out forwards;
            text-align: center;
        }
        .feedback-item.positive { border-color: var(--accent-green); }
        .feedback-item.negative { border-color: var(--accent-red); }
        .feedback-item.neutral { border-color: var(--accent-primary); }
        /* --- End Feedback Animation --- */

        .selectable-pet { animation: glow 2s infinite ease-in-out; border-color: var(--accent-primary) !important; }
        .symbol-pulse-animation { animation: pulseSymbol 1.2s ease-in-out; }

        /* --- LAYOUT FIXES FOR MOBILE --- */
        html { height: 100%; overflow: hidden; }
        
        body {
            font-family: var(--font-primary);
            background: var(--bg-main);
            color: var(--text-primary-light);
            transition: background 0.5s ease;
            margin: 0; padding: 0; 
            height: 100vh; /* Full viewport height */
            width: 100vw; /* Full viewport width */
            overflow: hidden; /* Lock the body from scrolling */
            display: flex; flex-direction: column; align-items: center;
        }

        /* REVISED: Main container now uses flexbox to manage space */
        .main-container {
            display: flex; justify-content: center; align-items: flex-start;
            width: 100%; max-width: 420px; flex-grow: 1; overflow: hidden;
            margin: 0 auto; padding: 10px; /* REVISED: Removed large bottom padding */
            box-sizing: border-box; position: relative;
        }
        
        #feedback-overlay {
            position: absolute; bottom: 120px; /* REVISED: Adjusted position */
            left: 50%;
            transform: translateX(-50%); width: 80%;
            height: 100px; z-index: 1999; pointer-events: none;
            display: flex; flex-direction: column-reverse; align-items: center; gap: 5px;
        }

        /* --- Panel Styling --- */
        .game {
            background: var(--bg-panel); border-radius: var(--border-radius-main);
            box-shadow: var(--shadow-strong); padding: 10px;
            transition: background 0.3s ease, border-color 0.3s ease;
            box-sizing: border-box; display: flex; flex-direction: column;
            align-items: center; position: relative; width: 100%; text-align: center;
            border: 2px solid var(--bg-panel-accent);
            height: 100%; /* Make the game fill the main-container */
            overflow: hidden; /* Prevent ANY scrolling */
        }
        .game.food-warning { background: #a12c2c !important; border-color: var(--accent-red) !important; }
        .game.food-warning .food-meter-icon, .game.food-warning .food-meter-value { color: var(--text-primary-light); }

        /* REVISED: Structure to prevent scroll and ensure visibility */
        .game-header { width: 100%; flex-shrink: 0; }
        .game-content {
            width: 100%; flex-grow: 1; /* Allows this area to fill remaining space */
            overflow: hidden; /* NO SCROLLING */
            display: flex; flex-direction: column; align-items: center;
            justify-content: space-around; /* CRITICAL CHANGE for layout */
        }

        #game-main-title {
            font-size: 1rem; font-weight: 500; color: var(--text-secondary);
            letter-spacing: 1px; margin: 0 auto 8px auto;
        }
        #game-main-title.upgrade-mode-active {
            font-size: 1.2rem; font-weight: 700; color: var(--accent-secondary);
        }
        
        /* Meters (Food & Power) */
        .meters-wrapper { display: flex; gap: 10px; width: 100%; margin-bottom: 8px; }
        .power-meter-container, .food-meter-container { display: flex; align-items: center; gap: 8px; flex: 1; }
        .power-meter-bar, .food-meter {
            flex-grow: 1; height: 16px; background-color: rgba(0,0,0,0.3);
            border: 1px solid var(--bg-panel-accent); border-radius: var(--border-radius-small); overflow: hidden;
        }
        .power-meter-fill { height: 100%; background: var(--accent-secondary); transition: width 0.4s ease; }
        .food-meter-fill { height: 100%; background: var(--accent-green); transition: width 0.4s ease; }
        #power-meter-indicator-icon, .food-meter-icon { font-size: 20px; flex-shrink: 0; }
        .next-power-bill-display, .food-meter-value { font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); }
        
        /* Symbol Inventory */
        .symbol-inventory {
            margin: 2px auto; padding: 5px; font-size: 1rem;
            min-height: 40px; display: grid; grid-template-columns: repeat(auto-fit, minmax(42px, 1fr));
            gap: 5px; align-items: center; background: rgba(0,0,0,0.25);
            border: 1px solid var(--bg-panel-accent); border-radius: var(--border-radius-small);
            width: 100%; box-sizing: border-box;
        }

        /* Slot Grid */
        .slot-grid {
            display: inline-grid;
            grid-template-columns: repeat(4, clamp(55px, 14vw, 65px));
            gap: clamp(6px, 1.5vw, 10px); margin: 4px 0; /* Reduced margin */
        }
        .slot-cell {
            width: 100%; aspect-ratio: 1 / 1; display: flex; justify-content: center; align-items: center;
            font-size: clamp(26px, 7vw, 36px); background: var(--bg-panel-accent);
            border: 1px solid var(--border-color, #2d323a); border-radius: var(--border-radius-small);
            position: relative; cursor: default;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
            overflow: hidden; perspective: 1000px;
        }
        .slot-cell.clickable-food, .slot-cell.clickable-cat { cursor: pointer; }
        .slot-flipper { transform-style: preserve-3d; position: relative; width: 100%; height: 100%; }
        .slot-face, .slot-back {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            border-radius: var(--border-radius-small);
        }
        .slot-face { background: var(--bg-panel-accent); }
        .slot-back { transform: rotateY(180deg); background: transparent; }
        .slot-cell .base-value-text {
            position: absolute; top: 2px; left: 3px; font-size: 0.8rem; font-weight: 700;
            color: var(--accent-secondary); text-shadow: 1px 1px 2px rgba(0,0,0,0.9);
        }
        .slot-cell .base-value-text.multiplied-payout { text-shadow: 0 0 5px var(--accent-secondary); }
        .multiplier-value-text { position: absolute; top: 2px; right: 3px; font-size: 0.8rem; font-weight: bold; }
        .slot-cell.top-right-locked { background-color: var(--accent-secondary); border-color: var(--accent-secondary); }
        .lock-icon { position: absolute; top: 0px; right: 1px; font-size: 0.9rem; z-index: 20; color: var(--accent-secondary); }
        .lock-icon.no-locks { opacity: 0.5; color: var(--text-secondary); }
        .slot-cell.multi-2x { border-color: var(--multiplier-2x-color); }
        .slot-cell.multi-3x { border-color: var(--multiplier-3x-color); }
        .slot-cell.multi-5x { border-color: var(--multiplier-5x-color); }
        .slot-cell.multi-2x .multiplier-value-text { color: var(--multiplier-2x-color); }
        .slot-cell.multi-3x .multiplier-value-text { color: var(--multiplier-3x-color); }
        .slot-cell.multi-5x .multiplier-value-text { color: var(--multiplier-5x-color); }
        .schrodinger-cat-effect { box-shadow: 0 0 8px var(--accent-green), inset 0 0 5px var(--accent-green) !important; border: 1px dashed var(--accent-green) !important; }
        .schrodinger-cat-effect::after { content: "üêà"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 38px; z-index: 5; pointer-events: none; color: transparent; background: linear-gradient(45deg, var(--accent-green), var(--accent-primary)); -webkit-background-clip: text; background-clip: text; opacity: 0.6; }

        /* Win Displays & Controls */
        .win-display, .phone-message-display { font-size: 0.9rem; font-weight: 600; min-height: 18px; text-align: center; margin-bottom: 2px; }
        .win-display { color: var(--text-primary-light); }
        .win-display.game-over { color: var(--accent-red); font-size: 1rem; }
        .phone-message-display.friendly, .phone-message-display.profit { color: var(--accent-green); }
        .phone-message-display.loss { color: var(--accent-red); }
        .phone-message-display.takeout-confirm { color: var(--text-primary-light); }
        .controls { display: flex; gap: 8px; align-items: stretch; justify-content: center; margin: 2px 0; width: 100%; }
        .btn { padding: 8px 16px; font-size: 1rem; border: none; border-bottom: 3px solid rgba(0,0,0,0.4); border-radius: var(--border-radius-small); cursor: pointer; transition: all 0.15s ease; box-shadow: var(--shadow-subtle); font-weight: 700; background: var(--accent-primary); color: var(--text-primary-dark); }
        .btn:active:not(:disabled) { transform: translateY(1px); border-bottom-width: 1px; }
        .btn:disabled { cursor: not-allowed; filter: brightness(0.6) grayscale(0.4); }
        .btn-spin { flex-grow: 1; }
        .btn-lucky { flex-shrink: 0; background-color: #6a4c93; color: var(--text-primary-light); }
        .btn-lucky.active { background: #c1121f; }
        .btn.btn-spin-lucky { background: #c1121f; color: var(--text-primary-light); }
        .btn.btn-spin-bill-unpaid { animation: pulseWarningBorder 1.2s infinite; background: var(--accent-red); }
        .coin-display { font-size: 1rem; font-weight: bold; margin-top: 2px; color: var(--accent-secondary); }

        /* Inventory Window */
        .inventory-window { width: 100%; margin-top: 4px; padding: 6px; background: rgba(0,0,0,0.25); border: 1px solid var(--bg-panel-accent); border-radius: var(--border-radius-small);}
        .inventory-content { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; font-size: 0.9rem; }
        .inventory-item { padding: 4px 8px; background: var(--bg-panel-accent); border-radius: var(--border-radius-small); box-shadow: var(--shadow-subtle); color: var(--text-secondary); border: 1px solid var(--bg-panel-accent); }
        .inventory-item.clickable { cursor: pointer; background-color: var(--accent-primary); color: var(--text-primary-dark); }
        .inventory-item-gift { background-color: var(--accent-secondary) !important; color: var(--text-primary-dark) !important; font-weight: bold;}
        .inventory-item.clickable[style*="opacity: 0.7"] { cursor: not-allowed; transform: none; background-color: var(--bg-panel-accent); color: var(--text-secondary); }

        /* REVISED: Bottom Navigation Bar is now part of the flex layout */
        .bottom-nav-bar {
            width: 100%; 
            max-width: 420px; /* Match the main container width */
            background: var(--bg-navbar); 
            border-top: 2px solid #3e444f;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.3); 
            z-index: 500; 
            padding: 8px 10px;
            box-sizing: border-box; 
            transition: background-color 0.3s ease, border-color 0.3s ease;
            flex-shrink: 0; /* Prevents it from shrinking */
        }
        .bottom-utility-section { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .status-effects-window {
            padding: 4px; width: 100%; min-height: 48px; display: flex;
            justify-content: center; align-items: center; gap: 5px; flex-wrap: wrap;
        }
        .status-effect-item {
            min-height: 18px; display: flex; flex-direction: row; justify-content: center; align-items: center;
            gap: 5px; flex: 1; min-width: 40px; background: rgba(0,0,0,0.3);
            padding: 3px 5px; border-radius: var(--border-radius-small); color: var(--text-primary-light);
        }
        .buff-emoji { font-size: 0.9rem; }
        .buff-countdown, .buff-value { font-size: 0.75rem; font-weight: bold; }
        .buff-countdown { color: var(--accent-secondary); }
        .buff-value { color: var(--accent-green); }

        /* Bottom Nav Buttons */
        .bottom-controls-bar { display: flex; justify-content: space-around; gap: 8px; width: 100%; }
        .utility-trigger { flex: 1; display: flex; justify-content: center; align-items: center; }
        .utility-btn {
            font-size: 22px; width: 48px; height: 48px; border-radius: 50%;
            background-color: var(--accent-secondary); display: flex; justify-content: center;
            align-items: center; cursor: pointer; transition: all 0.2s ease;
            border: 2px solid #b8860b; color: #333;
        }
        .utility-btn.toggled-off { background-color: rgba(0,0,0,0.25); color: rgba(255,255,255,0.4); border-color: transparent; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.3s ease; padding: 15px; box-sizing: border-box; }
        .modal-overlay.hidden { opacity: 0; pointer-events: none; }
        .modal-window { width: 100%; max-width: 500px; max-height: 90vh; position: relative; display: flex; flex-direction: column; background-color: var(--bg-modal); border-radius: var(--border-radius-main); border: 2px solid #4a4a8a; color: var(--text-primary-light); box-shadow: var(--shadow-strong); }
        .modal-title { font-size: 1.3rem; color: var(--accent-primary); text-align: center; margin: 15px 0; padding-bottom: 10px; border-bottom: 1px solid var(--accent-primary); }
        .modal-close-btn { position: absolute; top: 6px; right: 10px; font-size: 30px; color: #fff; background: none; border: none; cursor: pointer; z-index: 1001; }
        .modal-content { overflow-y: auto; font-size: 0.9rem; line-height: 1.6; padding: 10px 15px; }
        .modal-content strong { color: var(--accent-secondary); }
        .modal-content hr { border-color: #4a4a8a; margin: 15px 0; border-style: solid; border-width: 1px 0 0 0; }
        .payout-option.highlight { color: var(--accent-secondary); font-weight: bold; background-color: color-mix(in srgb, var(--accent-secondary) 20%, transparent); padding: 2px 5px; border-radius: 4px; display: inline-block; }

        /* Shop Modal */
        #shop-modal-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        .shop-item-btn {
            padding: 10px; font-size: 0.9rem; border: 1px solid #4a4a8a; border-radius: var(--border-radius-small);
            cursor: pointer; transition: all 0.2s ease; font-weight: 500; text-align: center;
            background-color: var(--bg-panel-accent); color: var(--text-primary-light); box-shadow: var(--shadow-subtle);
        }
        .shop-item-cost { font-weight: bold; display: block; margin-top: 5px; color: var(--text-primary-dark) !important; background: var(--accent-secondary); padding: 3px 5px; border-radius: 6px; }
        .shop-item-btn:disabled { filter: grayscale(0.7) brightness(0.6); cursor: not-allowed; }

        /* Phone Modal */
        #phone-modal-content .btn { width: 85%; margin: 10px auto; display: block; }
        #investments-btn { background: var(--accent-green); }
        #takeout-area { background: #FF7043; }
        .investment-ui, .takeout-ui { display: flex; flex-direction: column; gap: 12px; padding: 12px; }
        .investment-ui input[type="range"], .takeout-ui input[type="range"] { accent-color: var(--accent-primary); }
        .investment-ui #invest-amount-display, .takeout-ui #takeout-amount-display { font-size: 1.1rem; font-weight: bold; text-align: center; }

        /* Pet Modal */
        #pet-modal-content { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 8px; min-height: 240px; }
        .pet-info-container { text-align: center; width: 100%; }
        .pet-status-emoji { font-size: 48px; }
        .pet-description { font-size: 0.9rem; color: var(--text-primary-light); min-height: 20px; font-weight: 500; margin-top: 5px; }
        .pet-bottom-area { width: 100%; text-align: center; }
        #pet-toy-display { font-size: 22px; }
        .pet-food-consumption { font-size: 0.8rem; color: var(--text-secondary); }
        .alien-visitor-text { font-size: 1rem; font-weight: bold; color: var(--accent-green); line-height: 1.4; text-align: center; }
        .alien-emoji-large { font-size: 48px; }

        /* Guide Modal */
        #guide-icons-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 220px; margin: 15px auto; }
        .guide-icon { font-size: 36px; cursor: pointer; transition: transform 0.2s ease; text-align: center; }
        #guide-back-btn { display: block; width: 85%; margin: 0 auto 15px auto; background-color: var(--accent-primary); }
        .guide-topic-content h4 { font-size: 1.1rem; color: var(--accent-primary); margin-top: 12px; margin-bottom: 8px; border-bottom: 1px solid #4a4a8a; padding-bottom: 5px; }
        .guide-topic-content ul { list-style-type: none; padding-left: 0; margin-bottom: 10px; }
        .guide-topic-content li { margin-bottom: 6px; }
        .btn.btn-how-to-play { background: #6a4c93; color: var(--text-primary-light); display: block; width: 85%; margin: 0 auto 15px auto; }

        /* Gift Modals */
        #gift-choice-content h4 { font-size: 1.3rem; color: var(--accent-secondary); text-align: center; border: none; }
        .gift-choices-container { display: flex; flex-direction: column; gap: 15px; align-items: center; }

        /* --- NEW: Special Gift Alert Modal Styles --- */
        @keyframes gift-glow {
            0%, 100% { box-shadow: 0 0 15px var(--accent-secondary), 0 0 25px var(--accent-secondary); border-color: var(--accent-secondary); }
            50% { box-shadow: 0 0 25px #FFD700, 0 0 40px #FFD700; border-color: #FFD700; }
        }
        .modal-window.gift-alert-window {
            text-align: center;
            border: 3px solid var(--accent-secondary);
            animation: gift-glow 2s infinite ease-in-out;
        }
        #special-gift-alert-content h2 {
            font-size: 2rem;
            color: var(--accent-secondary);
            margin-bottom: 15px;
        }
        #special-gift-alert-content .gift-emoji {
            font-size: 80px;
            display: block;
            margin: 20px 0;
            transform-origin: bottom center;
            animation: gift-bounce 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        @keyframes gift-bounce {
            0% { transform: scale(0.5); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        #special-gift-alert-content p {
            font-size: 1.1rem;
            margin-bottom: 25px;
        }
        #special-gift-alert-close-btn {
            display: block;
            width: 80%;
            margin: 0 auto;
        }
    </style>
</head>
<body>

<div class="main-container">
    <div id="feedback-overlay"></div> 
    <div class="game">
        <div class="game-header">
            <h1 id="game-main-title">KEEP SPINNING!</h1>
            <div class="meters-wrapper">
                <div class="power-meter-container">
                    <div class="power-meter-icon" id="power-meter-indicator-icon">üîå</div>
                    <div class="power-meter-bar">
                        <div class="power-meter-fill" id="power-meter-fill"></div>
                    </div>
                    <div class="next-power-bill-display" id="next-power-bill-cost-display"></div>
                </div>
                
                <div class="food-meter-container">
                    <div class="food-icon-area">
                       <span class="food-meter-icon">üçΩÔ∏è</span>
                       <span class="food-meter-value" id="food-meter-value-display"></span>
                    </div>
                    <div class="food-meter">
                        <div class="food-meter-fill" id="food-meter-fill-display"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-content">
            <div class="symbol-inventory" id="symbol-inventory-display"></div>
            <div class="slot-grid" id="slot-grid"></div>
            <div class="win-display" id="total-win-display"></div>
            <div class="phone-message-display" id="phone-message-display"></div>
            <div class="controls">
                <button id="lucky-btn" class="btn btn-lucky">LL</button>
                <button id="spin-btn" class="btn btn-spin">Spin - 20 ü™ô</button>
            </div>
            <div class="coin-display" id="coins-display"></div>
            <div class="inventory-window">
                <div id="player-inventory-content" class="inventory-content"></div>
            </div>
        </div>
    </div>
</div>

<nav class="bottom-nav-bar">
    <div class="bottom-utility-section">
        <div class="status-effects-window">
            <div id="donut-buff-status" class="status-effect-item"></div>
            <div id="cat-buff-status" class="status-effect-item"></div>
            <div id="alien-buff-status" class="status-effect-item"></div>
            <div id="phone-buff-status" class="status-effect-item"></div>
            <div id="cosmic-mode-status" class="status-effect-item"></div>
            <div id="quantum-mode-status" class="status-effect-item"></div>
            <div id="permanent-buff-status" class="status-effect-item"></div>
            <div id="nest-status" class="status-effect-item"></div>
            <div id="feather-status" class="status-effect-item"></div>
            <div id="beetle-status" class="status-effect-item"></div>
            <div id="branch-status" class="status-effect-item"></div>
        </div>
        <div class="bottom-controls-bar">
            <div id="window-trigger-container" class="utility-trigger">
                <div id="window-trigger-btn" class="utility-btn">ü™ü</div>
            </div>
            <div id="pet-trigger-container" class="utility-trigger">
                <div id="pet-trigger-btn" class="utility-btn">üíô</div>
            </div>
            <div id="phone-trigger-container" class="utility-trigger">
                <div id="phone-trigger-btn" class="utility-btn">üì±</div>
            </div>
            <div id="shop-trigger-container" class="utility-trigger">
                <div id="shop-trigger-btn" class="utility-btn">üè™</div>
            </div>
            <div id="guide-trigger-container" class="utility-trigger">
                <div id="guide-trigger-btn" class="utility-btn">‚ùî</div>
            </div>
        </div>
    </div>
</nav>

<!-- Modals -->
<div id="alien-media-payout-modal" class="modal-overlay hidden">
    <div class="modal-window">
        <button id="alien-media-payout-close-btn" class="modal-close-btn">&times;</button>
        <div id="alien-media-payout-content" class="modal-content"></div>
    </div>
</div>

<div id="gift-choice-modal" class="modal-overlay hidden">
    <div class="modal-window">
        <div id="gift-choice-content" class="modal-content">
            <h4>Choose Your Gift!</h4>
            <p>Select one permanent buff to aid you.</p>
            <div class="gift-choices-container">
                <button id="gift-choice-bird-btn" class="btn">üê¶ +1 To All Birds</button>
                <button id="gift-choice-food-btn" class="btn">üçΩÔ∏è +1 Food Replenish</button>
                <button id="gift-choice-locks-btn" class="btn">üîê +3 Lock Items</button>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Special Gift Alert Modal -->
<div id="special-gift-alert-modal" class="modal-overlay hidden">
    <div class="modal-window gift-alert-window">
        <div id="special-gift-alert-content" class="modal-content">
            <!-- Content is generated by JavaScript -->
        </div>
    </div>
</div>

<div id="shop-modal-overlay" class="modal-overlay hidden">
    <div class="modal-window">
        <button id="shop-modal-close-btn" class="modal-close-btn">&times;</button>
        <h3 class="modal-title">üè™ Shop</h3>
        <div id="shop-modal-content" class="modal-content"></div>
    </div>
</div>

<div id="guide-selection-modal-overlay" class="modal-overlay hidden">
    <div class="modal-window">
        <button id="guide-selection-modal-close-btn" class="modal-close-btn">&times;</button>
        <h3 class="modal-title">‚ùî Guide Topics</h3>
        <div id="guide-selection-modal-content" class="modal-content"></div>
    </div>
</div>

<div id="pet-modal-overlay" class="modal-overlay hidden">
    <div class="modal-window">
        <button id="pet-modal-close-btn" class="modal-close-btn">&times;</button>
        <h3 class="modal-title" id="pet-modal-title">üíô Companion</h3>
        <div id="pet-modal-content" class="modal-content"></div>
    </div>
</div>

<div id="phone-modal-overlay" class="modal-overlay hidden">
    <div class="modal-window">
        <button id="phone-modal-close-btn" class="modal-close-btn">&times;</button>
        <h3 class="modal-title">üì± Phone</h3>
        <div id="phone-modal-content" class="modal-content"></div>
    </div>
</div>

<div id="black-hole-modal" class="modal-overlay hidden">
    <div class="modal-window">
        <button id="black-hole-close-btn" class="modal-close-btn">&times;</button>
        <div id="black-hole-content" class="modal-content" style="text-align: center;"></div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONSTANTS & CONFIG ---
    const GAME_CONFIG = {
        initialCatCount: 4, maxFoodMeter: 20, maxPower: 40, cosmicModeDuration: 20,
        quantumModeDuration: 20, maxBeetles: 1, maxFeathers: 5, spinCostBase: 20,
        luckyLinesSpinCost: 30, multiplierSlotIndex: 7, gridSize: 8, initialCoins: 75,
        initialLockItems: 3, baseSpinFoodConsumption: 1, catFoodConsumption: 1,
        luckyLinesBonus: 150, investmentDuration: 10, takeoutDuration: 10,
        donutBuffDuration: 10, sushiBuffDuration: 3, birdGainChance: 0.15, birdLossChance: 0.15,
        spamTextChance: 0.25, spamTextCost: 35, friendlyTextGain: 10, parrotBeetleDropChance: 0.15,
        doveBranchDropChance: 0.15, owlFeatherDropChance: 0.15, ufoAlienDropChance: 0.15,
        gameOverOnUnpaidBillChance: 0.05, powerBillBaseCost: 125, powerBillIncrement: 125,
        maxFoodSymbolCap: 8, maxTotalBirdsCap: 8, schrodingerCatsCount: 2,
    };

    const INITIAL_SYMBOLS_CONFIG = [
        { emoji: "üçü", value: 2, count: 4, refill: 10, isFood: true },
        { emoji: "üç£", value: 1, count: 3, refill: 10, isFood: true },
        { emoji: "üç©", value: 3, count: 3, refill: 10, isFood: true },
        { emoji: "ü´ê", value: 0, count: 0, refill: 5, isFood: true, hidden: false },
        { emoji: "üêà‚Äç‚¨õ", value: 2, count: GAME_CONFIG.initialCatCount, refill: 0, isFood: false },
        { emoji: "ü¶ú", value: 3, count: 0, refill: 0, isFood: false, hidden: false },
        { emoji: "ü¶â", value: 0, count: 0, refill: 0, isFood: false, hidden: false },
        { emoji: "üïäÔ∏è", value: 1, count: 0, refill: 0, isFood: false, hidden: false },
        { emoji: "üê¶‚Äçüî•", value: 5, count: 0, refill: 0, isFood: false, hidden: false },
        { emoji: "ü™ê", value: 16, count: 0, refill: 0, isFood: false, isCosmic: true, hidden: false },
        { emoji: "üå†", value: 11, count: 0, refill: 0, isFood: false, isCosmic: true, hidden: false },
        { emoji: "üåí", value: 9, count: 0, refill: 0, isFood: false, isCosmic: true, hidden: false },
        { emoji: "ÔøΩ", value: 7, count: 0, refill: 0, isFood: false, isCosmic: true, hidden: false }
    ];

    const SHOP_ITEMS_CONFIG = [
        { name: "Mouse Toy", emoji: "üêÅ", cost: 200 }, { name: "Camera", emoji: "üìπ", cost: 3000 },
        { name: "Bird Nest", emoji: "ü™π", cost: 1000 }, { name: "Black Hole", emoji: "‚ö´", cost: 10000 },
        { name: "Cosmic Upgrade", emoji: "üî≠", cost: 2000, powerCost: 2, isUpgrade: true, type: 'cosmic' },
        { name: "Quantum Upgrade", emoji: "‚öõÔ∏è", cost: 6000, powerCost: 4, isUpgrade: true, type: 'quantum' },
    ];

    // --- DOM ELEMENTS ---
    const DOM_ELEMENTS = {
        gameDiv: document.querySelector('.game'), grid: document.getElementById("slot-grid"),
        coinsDisplay: document.getElementById("coins-display"), luckyBtn: document.getElementById("lucky-btn"),
        totalWinDisplay: document.getElementById("total-win-display"), phoneMessageDisplay: document.getElementById("phone-message-display"),
        foodMeterFill: document.getElementById("food-meter-fill-display"), foodMeterValue: document.getElementById("food-meter-value-display"),
        symbolInventoryDisplay: document.getElementById("symbol-inventory-display"), playerInventoryContent: document.getElementById("player-inventory-content"),
        shopContent: document.getElementById("shop-modal-content"), powerMeterFill: document.getElementById("power-meter-fill"),
        powerMeterIndicatorIcon: document.getElementById("power-meter-indicator-icon"), nextPowerBillCostDisplay: document.getElementById("next-power-bill-cost-display"),
        donutBuffStatusEl: document.getElementById('donut-buff-status'), catBuffStatusEl: document.getElementById('cat-buff-status'),
        alienBuffStatusEl: document.getElementById('alien-buff-status'), phoneBuffStatusEl: document.getElementById('phone-buff-status'),
        cosmicModeStatusEl: document.getElementById('cosmic-mode-status'), quantumModeStatusEl: document.getElementById('quantum-mode-status'),
        permanentBuffStatusEl: document.getElementById('permanent-buff-status'), spinBtn: document.getElementById('spin-btn'),
        gameMainTitle: document.getElementById("game-main-title"), alienMediaPayoutModal: document.getElementById("alien-media-payout-modal"),
        alienMediaPayoutContent: document.getElementById("alien-media-payout-content"), alienMediaPayoutCloseBtn: document.getElementById("alien-media-payout-close-btn"),
        giftChoiceModal: document.getElementById("gift-choice-modal"), giftChoiceBirdBtn: document.getElementById("gift-choice-bird-btn"),
        giftChoiceFoodBtn: document.getElementById("gift-choice-food-btn"), giftChoiceLocksBtn: document.getElementById("gift-choice-locks-btn"),
        shopTriggerBtn: document.getElementById("shop-trigger-btn"), guideTriggerBtn: document.getElementById("guide-trigger-btn"),
        shopModalOverlay: document.getElementById("shop-modal-overlay"), shopModalCloseBtn: document.getElementById("shop-modal-close-btn"),
        guideSelectionModalOverlay: document.getElementById("guide-selection-modal-overlay"), guideSelectionModalCloseBtn: document.getElementById("guide-selection-modal-close-btn"),
        guideSelectionModalContent: document.getElementById("guide-selection-modal-content"), windowTriggerBtn: document.getElementById('window-trigger-btn'),
        petTriggerBtn: document.getElementById('pet-trigger-btn'), phoneTriggerBtn: document.getElementById('phone-trigger-btn'),
        petModalOverlay: document.getElementById('pet-modal-overlay'), petModalCloseBtn: document.getElementById('pet-modal-close-btn'),
        petModalContent: document.getElementById('pet-modal-content'), petModalTitle: document.getElementById('pet-modal-title'),
        phoneModalOverlay: document.getElementById('phone-modal-overlay'), phoneModalCloseBtn: document.getElementById('phone-modal-close-btn'),
        phoneModalContent: document.getElementById('phone-modal-content'), nestStatusEl: document.getElementById('nest-status'),
        featherStatusEl: document.getElementById('feather-status'), beetleStatusEl: document.getElementById('beetle-status'),
        branchStatusEl: document.getElementById('branch-status'), blackHoleModal: document.getElementById('black-hole-modal'),
        blackHoleContent: document.getElementById('black-hole-content'), blackHoleCloseBtn: document.getElementById('black-hole-close-btn'),
        feedbackOverlay: document.getElementById('feedback-overlay'),
        specialGiftAlertModal: document.getElementById('special-gift-alert-modal'), // NEW
        specialGiftAlertContent: document.getElementById('special-gift-alert-content'), // NEW
    };

    // --- GAME STATE VARIABLES ---
    let symbols = [];
    const playerState = {};
    const slotMachineState = {};
    const activeEffects = {};
    const windowFeatureState = {};
    const phoneFeatureState = {};
    const uiState = {};

    function initializeGameVariables() {
        playerState.coins = GAME_CONFIG.initialCoins;
        playerState.foodMeter = GAME_CONFIG.maxFoodMeter;
        playerState.power = GAME_CONFIG.maxPower;
        playerState.inventory = { "üìπ": 0, "‚òï": 2, "üëΩ": 0, " ": 0, "‚ö´": 0, "üéÅ": 0 };
        playerState.lockItems = GAME_CONFIG.initialLockItems;
        playerState.billsPaidSoFar = 0;
        playerState.spinCount = 0;
        playerState.giftAwarded = false;
        playerState.spinsSinceLastBlueberry = 0;
        playerState.camerasPurchasedThisGame = 0;

        slotMachineState.luckyLines = false;
        slotMachineState.topRightLocked = false;
        slotMachineState.topRightSymbol = null;
        slotMachineState.currentWin = 0;
        slotMachineState.currentGridSymbols = Array(GAME_CONFIG.gridSize).fill(null);
        slotMachineState.currentMultiplier = getRandomMultiplier();
        slotMachineState.schrodingerCells = [];

        activeEffects.hasPetCat = false;
        activeEffects.hasPetDove = false;
        activeEffects.hasAlienVisitor = false;
        activeEffects.spinsWithCat = 0;
        activeEffects.currentCatStatus = 'üò∫';
        activeEffects.previousCatStatus = 'üò∫';
        activeEffects.hasMouseToy = false;
        activeEffects.donutBuffActive = false;
        activeEffects.donutBuffSpinsLeft = 0;
        activeEffects.sushiCatBuffActive = false;
        activeEffects.sushiCatBuffSpinsLeft = 0;
        activeEffects.cosmicUpgradeActive = false;
        activeEffects.cosmicUpgradeSpinsLeft = 0;
        activeEffects.quantumUpgradeActive = false;
        activeEffects.quantumUpgradeSpinsLeft = 0;
        activeEffects.cosmicUpgradePenaltyActive = false;
        activeEffects.quantumUpgradePenaltyActive = false;
        activeEffects.cosmicModeCompleted = false;
        activeEffects.quantumModeCompleted = false;
        activeEffects.alienDroppedByUFO = false;
        activeEffects.permanentBirdBuff = false;
        activeEffects.permanentFoodReplenishBuff = false;

        windowFeatureState.birdGainedThisSpin = null;
        windowFeatureState.hasBirdNest = false;
        windowFeatureState.feathers = 0;
        windowFeatureState.beetles = 0;
        windowFeatureState.hasBranch = false;
        windowFeatureState.branchesDroppedThisGame = 0;

        phoneFeatureState.phoneOn = false;
        phoneFeatureState.investmentActive = false;
        phoneFeatureState.investmentAmount = 0;
        phoneFeatureState.investmentSpinsLeft = 0;
        phoneFeatureState.takeoutActive = false;
        phoneFeatureState.takeoutSpinsLeft = 0;
        phoneFeatureState.takeoutFoodAmount = 0;

        uiState.isGameOver = false;
        uiState.windowOpen = true;
        uiState.foodWarningActive = false;

        symbols = JSON.parse(JSON.stringify(INITIAL_SYMBOLS_CONFIG)).map(s => ({ ...s, originalValue: s.value }));
        symbols.forEach(s => { if (s.isCosmic) s.count = 0; });
    }

    // --- HELPER & FEEDBACK FUNCTIONS ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
    function getRandomMultiplier() { return [2, 3, 5][Math.floor(Math.random() * 3)]; }

    function showFeedbackAnimation(text, type = 'neutral') {
        const feedbackEl = document.createElement('div');
        feedbackEl.className = `feedback-item ${type}`;
        feedbackEl.innerHTML = text;
        DOM_ELEMENTS.feedbackOverlay.appendChild(feedbackEl);
        setTimeout(() => {
            feedbackEl.remove();
        }, 2500);
    }

    function getSymbolsForSpin() {
        let newGridSetup = Array(GAME_CONFIG.gridSize).fill(null);
        const isLockEffectivelyActive = slotMachineState.topRightLocked;
        let effectiveSymbolsConfig = JSON.parse(JSON.stringify(symbols));
        let lockedSymbolForGrid = null;
        if (isLockEffectivelyActive && slotMachineState.topRightSymbol) {
            lockedSymbolForGrid = slotMachineState.topRightSymbol;
            const symbolInBagConfig = effectiveSymbolsConfig.find(s => s.emoji === lockedSymbolForGrid.emoji);
            if (symbolInBagConfig && symbolInBagConfig.count > 0) symbolInBagConfig.count--;
        }
        let bag = [];
        effectiveSymbolsConfig.forEach(symbol => {
            let shouldBeInBag = !symbol.isCosmic && !symbol.hidden;
            if (symbol.isCosmic) {
                if (activeEffects.cosmicUpgradePenaltyActive || activeEffects.cosmicUpgradeActive) shouldBeInBag = true;
                else shouldBeInBag = false;
            }
            if (symbol.count > 0 && shouldBeInBag) {
                for (let i = 0; i < symbol.count; i++) bag.push({ ...symbol });
            }
        });
        shuffleArray(bag);
        let availableSlotIndices = [];
        for (let i = 0; i < GAME_CONFIG.gridSize; i++) {
            if (isLockEffectivelyActive && i === 3) newGridSetup[i] = lockedSymbolForGrid;
            else availableSlotIndices.push(i);
        }
        shuffleArray(availableSlotIndices);
        for (const slotIndex of availableSlotIndices) {
            if (bag.length > 0) newGridSetup[slotIndex] = bag.pop();
            else newGridSetup[slotIndex] = null;
        }
        return newGridSetup;
    }
    function getTotalBirdCount() {
        let totalBirds = 0;
        const birdEmojis = ["ü¶ú", "ü¶â", "üïäÔ∏è", "üê¶‚Äçüî•"];
        birdEmojis.forEach(emoji => {
            const birdSymbol = symbols.find(s => s.emoji === emoji);
            if (birdSymbol) totalBirds += birdSymbol.count;
        });
        return totalBirds;
    }

    // --- GAME LOGIC FUNCTIONS ---
    function gameOver(reason) {
        if (uiState.isGameOver) return;
        uiState.isGameOver = true;
        DOM_ELEMENTS.totalWinDisplay.textContent = `Game Over: ${reason}`;
        DOM_ELEMENTS.totalWinDisplay.classList.add('game-over');
        DOM_ELEMENTS.luckyBtn.disabled = true;
        document.querySelectorAll('.shop-item-btn').forEach(btn => btn.disabled = true);
        document.querySelectorAll('.slot-cell').forEach(cell => cell.onclick = null);
        document.querySelectorAll('.inventory-item.clickable').forEach(item => {
            item.onclick = null; item.style.cursor = 'not-allowed';
        });
        if (activeEffects.cosmicUpgradeActive) deactivateCosmicUpgradeBonusMode(false);
        if (activeEffects.quantumUpgradeActive) deactivateQuantumUpgradeBonusMode(false);
        closeAllWindows();
        updateDisplays();
    }
    function spin() {
        if (DOM_ELEMENTS.spinBtn.textContent === 'SPINNING...' || uiState.isGameOver || DOM_ELEMENTS.spinBtn.disabled) return;
        playerState.spinCount++;
        // REVISED: Gift logic now calls the special alert function
        if (playerState.spinCount === 60 && !playerState.giftAwarded) {
            playerState.inventory['üéÅ']++;
            playerState.giftAwarded = true;
            showSpecialGiftAlert();
        }
        DOM_ELEMENTS.phoneMessageDisplay.textContent = '';
        DOM_ELEMENTS.phoneMessageDisplay.className = 'phone-message-display';
        if (playerState.inventory['üìÉ'] > 0 && playerState.power <= 0) {
            if (Math.random() < GAME_CONFIG.gameOverOnUnpaidBillChance) {
                gameOver("Neglected Power Bill!"); return;
            }
        }
        if (playerState.foodMeter <= 0) { gameOver("Out of food!"); return; }
        DOM_ELEMENTS.spinBtn.disabled = true;
        DOM_ELEMENTS.totalWinDisplay.textContent = '';
        DOM_ELEMENTS.totalWinDisplay.classList.remove('game-over');
        let currentSpinCost = slotMachineState.luckyLines ? GAME_CONFIG.luckyLinesSpinCost : GAME_CONFIG.spinCostBase;
        if (playerState.coins < currentSpinCost) { gameOver("Out of coins!"); return; }
        if (activeEffects.hasAlienVisitor) {
            const friesSymbol = symbols.find(s => s.emoji === "üçü");
            if (friesSymbol && friesSymbol.count > 0) friesSymbol.count = 0;
        }
        let baseConsumption = GAME_CONFIG.baseSpinFoodConsumption;
        let foodToConsumeThisSpin = Math.max(0, baseConsumption);
        if (activeEffects.hasPetCat) foodToConsumeThisSpin += GAME_CONFIG.catFoodConsumption;
        if (playerState.foodMeter < foodToConsumeThisSpin) { gameOver("Not enough food for this spin!"); return; }
        const isLockEffectivelyActive = slotMachineState.topRightLocked;
        if (isLockEffectivelyActive && !slotMachineState.currentGridSymbols[3]) {
            DOM_ELEMENTS.spinBtn.disabled = false;
            updateDisplays();
            return;
        }
        windowFeatureState.birdGainedThisSpin = null;
        playerState.coins -= currentSpinCost;
        playerState.foodMeter -= foodToConsumeThisSpin;
        playerState.foodMeter = Math.max(0, playerState.foodMeter);
        let powerConsumedThisSpin = 1;
        if (activeEffects.cosmicUpgradePenaltyActive) powerConsumedThisSpin += 2;
        if (activeEffects.quantumUpgradePenaltyActive) powerConsumedThisSpin += 4;
        if (playerState.power > 0) {
            playerState.power -= powerConsumedThisSpin;
            playerState.power = Math.max(0, playerState.power);
        }
        if (playerState.power <= 0 && playerState.inventory['üìÉ'] === 0) playerState.inventory['üìÉ']++;
        if (activeEffects.hasPetCat && !activeEffects.hasMouseToy) activeEffects.spinsWithCat++;
        if (activeEffects.hasPetDove) {
            playerState.spinsSinceLastBlueberry = (playerState.spinsSinceLastBlueberry || 0) + 1;
            if (playerState.spinsSinceLastBlueberry >= 10) {
                const blueberrySymbol = symbols.find(s => s.emoji === 'ü´ê');
                if (blueberrySymbol) blueberrySymbol.count++;
                playerState.spinsSinceLastBlueberry = 0;
            }
        }
        if (phoneFeatureState.investmentActive) handleInvestmentSpin();
        if (phoneFeatureState.takeoutActive) handleTakeoutSpin();
        if (activeEffects.cosmicUpgradeActive) activeEffects.cosmicUpgradeSpinsLeft--;
        if (activeEffects.quantumUpgradeActive) activeEffects.quantumUpgradeSpinsLeft--;
        if (uiState.windowOpen) {
            if (Math.random() < GAME_CONFIG.birdGainChance) {
                if (getTotalBirdCount() < GAME_CONFIG.maxTotalBirdsCap) {
                    const availableBirdTypes = ["ü¶ú", "ü¶â", "üïäÔ∏è", "üê¶‚Äçüî•"];
                    const randomBirdEmoji = availableBirdTypes[Math.floor(Math.random() * availableBirdTypes.length)];
                    windowFeatureState.birdGainedThisSpin = randomBirdEmoji;
                }
            }
            if (windowFeatureState.hasBirdNest) { /* Nest protects */ }
            else if (Math.random() < GAME_CONFIG.birdLossChance) {
                let birdsEligibleToFly = symbols.filter(s => ["ü¶ú", "ü¶â", "üïäÔ∏è", "üê¶‚Äçüî•"].includes(s.emoji) && s.count > 0);
                if (isLockEffectivelyActive && slotMachineState.topRightSymbol && ["ü¶ú", "ü¶â", "üïäÔ∏è", "üê¶‚Äçüî•"].includes(slotMachineState.topRightSymbol.emoji)) {
                    const lockedBirdType = slotMachineState.topRightSymbol.emoji;
                    const symbolEntry = symbols.find(s => s.emoji === lockedBirdType);
                    if (symbolEntry && symbolEntry.count === 1) birdsEligibleToFly = birdsEligibleToFly.filter(b => b.emoji !== lockedBirdType);
                }
                if (birdsEligibleToFly.length > 0) {
                    if (windowFeatureState.beetles > 0) windowFeatureState.beetles--;
                    else {
                        const birdToLoseIndex = Math.floor(Math.random() * birdsEligibleToFly.length);
                        const birdToLoseEmoji = birdsEligibleToFly[birdToLoseIndex].emoji;
                        const birdSymbolInMainArray = symbols.find(s => s.emoji === birdToLoseEmoji);
                        if (birdSymbolInMainArray && birdSymbolInMainArray.count > 0) {
                            birdSymbolInMainArray.count--;
                            showFeedbackAnimation(`-1 ${birdToLoseEmoji}`, 'negative');
                        }
                    }
                }
            }
        }
        if (phoneFeatureState.phoneOn && Math.random() < GAME_CONFIG.spamTextChance) {
            if (Math.random() < 0.5) {
                playerState.coins -= GAME_CONFIG.spamTextCost; showPhoneMessage(`‚ö†Ô∏è -${GAME_CONFIG.spamTextCost} ü™ô`, "loss");
            } else {
                playerState.coins += GAME_CONFIG.friendlyTextGain; showPhoneMessage(`üë• +${GAME_CONFIG.friendlyTextGain} ü™ô`, "friendly");
            }
            playerState.coins = Math.max(0, playerState.coins);
        }
        slotMachineState.currentMultiplier = getRandomMultiplier();
        slotMachineState.currentGridSymbols = getSymbolsForSpin();
        slotMachineState.schrodingerCells = [];
        if (activeEffects.quantumUpgradeActive) {
            const availableIndicesForSchrodinger = [];
            for (let k = 0; k < GAME_CONFIG.gridSize; k++) {
                if (slotMachineState.currentGridSymbols[k]) availableIndicesForSchrodinger.push(k);
            }
            shuffleArray(availableIndicesForSchrodinger);
            for (let k = 0; k < GAME_CONFIG.schrodingerCatsCount && availableIndicesForSchrodinger.length > 0; k++) {
                slotMachineState.schrodingerCells.push(availableIndicesForSchrodinger.pop());
            }
        }
        DOM_ELEMENTS.spinBtn.textContent = 'SPINNING...';
        
        animateSpin(slotMachineState.currentGridSymbols, slotMachineState.currentMultiplier);

        const spinCompleteTimeout = 800; // REVISED: Faster timeout
        setTimeout(() => {
            let animatedBird = null;
            try {
                if (uiState.isGameOver && DOM_ELEMENTS.spinBtn.textContent === 'GAME OVER') return;
                
                updateGridDOM(slotMachineState.currentGridSymbols, slotMachineState.currentMultiplier);

                slotMachineState.currentGridSymbols.forEach((item) => {
                    if (item) {
                        if (item.emoji === "ü¶ú" && Math.random() < GAME_CONFIG.parrotBeetleDropChance) {
                            if (!windowFeatureState.hasBirdNest && windowFeatureState.beetles < GAME_CONFIG.maxBeetles) windowFeatureState.beetles++;
                        } else if (item.emoji === "üïäÔ∏è" && Math.random() < GAME_CONFIG.doveBranchDropChance) {
                            if (!windowFeatureState.hasBranch && windowFeatureState.branchesDroppedThisGame < 1) {
                                windowFeatureState.hasBranch = true; windowFeatureState.branchesDroppedThisGame++;
                            }
                        } else if (item.emoji === "ü¶â" && Math.random() < GAME_CONFIG.owlFeatherDropChance) {
                            if (windowFeatureState.feathers < GAME_CONFIG.maxFeathers) windowFeatureState.feathers++;
                        } else if (item.emoji === "üõ∏") {
                            if (activeEffects.cosmicUpgradePenaltyActive && !activeEffects.hasAlienVisitor && playerState.inventory["üëΩ"] < 1 && Math.random() < GAME_CONFIG.ufoAlienDropChance) {
                                playerState.inventory["üëΩ"]++; activeEffects.alienDroppedByUFO = true;
                            }
                        }
                    }
                });
                calculatePayout();
                if (activeEffects.donutBuffActive) {
                    activeEffects.donutBuffSpinsLeft--;
                    if (activeEffects.donutBuffSpinsLeft <= 0) activeEffects.donutBuffActive = false;
                }
                if (activeEffects.sushiCatBuffActive) {
                    activeEffects.sushiCatBuffSpinsLeft--;
                    if (activeEffects.sushiCatBuffSpinsLeft <= 0) activeEffects.sushiCatBuffActive = false;
                }
                DOM_ELEMENTS.totalWinDisplay.textContent = slotMachineState.currentWin > 0 ? `Win: ${slotMachineState.currentWin} coins!` : 'No Win';
                if (windowFeatureState.birdGainedThisSpin) {
                    const birdToFinallyAdd = symbols.find(s => s.emoji === windowFeatureState.birdGainedThisSpin);
                    if (birdToFinallyAdd) {
                        if (getTotalBirdCount() < GAME_CONFIG.maxTotalBirdsCap) {
                            birdToFinallyAdd.count++; animatedBird = birdToFinallyAdd.emoji;
                            showFeedbackAnimation(`+1 ${birdToFinallyAdd.emoji}`, 'positive');
                        }
                    }
                    windowFeatureState.birdGainedThisSpin = null;
                }
                if (activeEffects.cosmicUpgradeActive && activeEffects.cosmicUpgradeSpinsLeft <= 0) deactivateCosmicUpgradeBonusMode(true);
                if (activeEffects.quantumUpgradeActive && activeEffects.quantumUpgradeSpinsLeft <= 0) deactivateQuantumUpgradeBonusMode(true);
                if (playerState.foodMeter <= 0 && !uiState.isGameOver) gameOver("Out of food!");
            } catch (error) { console.error("Error in spin timeout callback:", error); }
            finally { updateDisplays(animatedBird); }
        }, spinCompleteTimeout);
    }
    function getSingleItemPayout(item, index) {
        if (!item) return 0;
        let itemValue = item.originalValue;
        if (item.isCosmic && activeEffects.hasAlienVisitor) itemValue += 12;
        if (item.emoji === "üç©" && activeEffects.donutBuffActive) itemValue += 3;
        else if (item.emoji === "üêà‚Äç‚¨õ" && activeEffects.hasPetCat) {
            let catBase = item.originalValue;
            if (activeEffects.sushiCatBuffActive) itemValue = catBase + 5;
            else if (activeEffects.currentCatStatus === 'üò∫') itemValue = catBase + 1;
            else if (activeEffects.currentCatStatus === 'üôÄ' || activeEffects.currentCatStatus === 'üôÄü™≤') itemValue = catBase - 1;
            itemValue = Math.max(1, itemValue);
        } else if (["ü¶ú", "ü¶â", "üïäÔ∏è", "üê¶‚Äçüî•"].includes(item.emoji)) {
            if (windowFeatureState.feathers > 0) itemValue += windowFeatureState.feathers;
            if (activeEffects.permanentBirdBuff) itemValue += 1;
            if (item.emoji === "üïäÔ∏è" && activeEffects.hasPetDove) itemValue += 2;
        }
        if (activeEffects.quantumUpgradeActive && slotMachineState.schrodingerCells.includes(index)) {
            if (item.emoji === "üêà‚Äç‚¨õ") itemValue *= 500;
        }
        if (activeEffects.quantumUpgradeActive) {
            if (index >= 4 && index <= 7) itemValue *= slotMachineState.currentMultiplier;
        } else if (activeEffects.cosmicUpgradeActive) {
            if (index >= 4 && index <= 7) itemValue *= slotMachineState.currentMultiplier;
        } else {
            if (index === GAME_CONFIG.multiplierSlotIndex) itemValue *= slotMachineState.currentMultiplier;
        }
        return Math.max(0, itemValue);
    }
    function calculatePayout() {
        let totalPayout = 0;
        const individualPayouts = Array(GAME_CONFIG.gridSize).fill(0);
        slotMachineState.currentGridSymbols.forEach((item, i) => {
            if (item) {
                const itemPayout = getSingleItemPayout(item, i);
                totalPayout += itemPayout;
                individualPayouts[i] = itemPayout;
            }
        });
        if (slotMachineState.luckyLines) {
            const topRow = slotMachineState.currentGridSymbols.slice(0, 4);
            const bottomRow = slotMachineState.currentGridSymbols.slice(4, 8);
            if (topRow.length === 4 && topRow.every(s => s && s.emoji === topRow[0].emoji)) totalPayout += GAME_CONFIG.luckyLinesBonus;
            if (bottomRow.length === 4 && bottomRow.every(s => s && s.emoji === bottomRow[0].emoji)) totalPayout += GAME_CONFIG.luckyLinesBonus;
        }
        slotMachineState.currentWin = totalPayout;
        playerState.coins += totalPayout;
    }

    // --- UPDATE DISPLAY FUNCTIONS ---
    function updateDisplays(animatedSymbolEmoji = null) {
        DOM_ELEMENTS.coinsDisplay.textContent = `Coins ${playerState.coins}`;
        DOM_ELEMENTS.foodMeterFill.style.width = `${(playerState.foodMeter / GAME_CONFIG.maxFoodMeter) * 100}%`;
        DOM_ELEMENTS.foodMeterValue.textContent = `${playerState.foodMeter}/${GAME_CONFIG.maxFoodMeter}`;
        updateSymbolInventoryDisplay(animatedSymbolEmoji);
        updatePlayerInventoryDisplay();
        updatePetModal();
        setupShop();
        updatePowerDisplay();
        updateNextPowerBillCostDisplay();
        updateStatusEffectsWindow();
        updateWindowButtonState();
        if (playerState.foodMeter <= 4 && playerState.foodMeter > 0) {
            if (DOM_ELEMENTS.gameDiv) DOM_ELEMENTS.gameDiv.classList.add('food-warning');
            uiState.foodWarningActive = true;
        } else {
            if (DOM_ELEMENTS.gameDiv) DOM_ELEMENTS.gameDiv.classList.remove('food-warning');
            uiState.foodWarningActive = false;
        }
        if (uiState.isGameOver) {
            DOM_ELEMENTS.spinBtn.textContent = 'GAME OVER';
            DOM_ELEMENTS.spinBtn.disabled = true;
            DOM_ELEMENTS.spinBtn.classList.remove('btn-spin-lucky', 'btn-spin-bill-unpaid');
        } else {
            DOM_ELEMENTS.spinBtn.disabled = false;
            let currentSpinButtonCostText = slotMachineState.luckyLines ? `${GAME_CONFIG.luckyLinesSpinCost} ü™ô` : `${GAME_CONFIG.spinCostBase} ü™ô`;
            DOM_ELEMENTS.luckyBtn.classList.toggle('active', slotMachineState.luckyLines);
            DOM_ELEMENTS.spinBtn.classList.toggle('btn-spin-lucky', slotMachineState.luckyLines);
            DOM_ELEMENTS.spinBtn.textContent = `Spin - ${currentSpinButtonCostText}`;
            DOM_ELEMENTS.spinBtn.classList.toggle('btn-spin-bill-unpaid', playerState.inventory['üìÉ'] > 0 && playerState.power <= 0);
        }
        if (DOM_ELEMENTS.luckyBtn) DOM_ELEMENTS.luckyBtn.disabled = uiState.isGameOver;
    }
    function updateSymbolInventoryDisplay(animatedSymbolEmoji = null) {
        DOM_ELEMENTS.symbolInventoryDisplay.innerHTML = "";
        symbols.filter(s => s.count > 0 && !s.hidden).forEach(symbol => {
            const span = document.createElement("span");
            span.textContent = `${symbol.emoji} ${symbol.count}`;
            if (symbol.emoji === animatedSymbolEmoji) span.classList.add('symbol-pulse-animation');
            DOM_ELEMENTS.symbolInventoryDisplay.appendChild(span);
        });
    }
    function updatePlayerInventoryDisplay() {
        DOM_ELEMENTS.playerInventoryContent.innerHTML = "";
        const lockSpan = document.createElement("span");
        lockSpan.className = 'inventory-item clickable';
        lockSpan.textContent = `üîê ${playerState.lockItems}`;
        if (!uiState.isGameOver) lockSpan.onclick = toggleGridLock;
        DOM_ELEMENTS.playerInventoryContent.appendChild(lockSpan);
        for (const itemEmoji in playerState.inventory) {
            if (playerState.inventory[itemEmoji] > 0) {
                const itemSpan = document.createElement("span");
                itemSpan.className = 'inventory-item';
                itemSpan.textContent = `${itemEmoji} ${playerState.inventory[itemEmoji]}`;
                if (!uiState.isGameOver) {
                    if (itemEmoji === "‚òï") {
                        itemSpan.classList.add("clickable");
                        itemSpan.style.opacity = activeEffects.donutBuffActive ? "0.7" : "1";
                        if (!activeEffects.donutBuffActive) itemSpan.onclick = consumeCoffee; else itemSpan.onclick = null;
                    } else if (itemEmoji === "üëΩ") {
                        itemSpan.classList.add("clickable");
                        itemSpan.style.opacity = (!activeEffects.hasAlienVisitor) ? "1" : "0.7";
                        if (!activeEffects.hasAlienVisitor) itemSpan.onclick = activateAlienVisitor; else itemSpan.onclick = null;
                    } else if (itemEmoji === "üìÉ") {
                        itemSpan.classList.add("clickable"); itemSpan.onclick = consumePowerBill;
                    } else if (itemEmoji === "üìπ") {
                        itemSpan.classList.add("clickable");
                        itemSpan.style.opacity = activeEffects.hasAlienVisitor ? "1" : "0.7";
                        if (activeEffects.hasAlienVisitor) itemSpan.onclick = consumeCamera; else itemSpan.onclick = null;
                    } else if (itemEmoji === "üéÅ") {
                        itemSpan.classList.add("clickable", "inventory-item-gift"); itemSpan.onclick = showGiftChoiceModal;
                    } else if (itemEmoji === "‚ö´") {
                        itemSpan.classList.add("clickable"); itemSpan.onclick = consumeBlackHole;
                    }
                }
                DOM_ELEMENTS.playerInventoryContent.appendChild(itemSpan);
            }
        }
    }
    function updatePetModal() {
        const content = DOM_ELEMENTS.petModalContent; content.innerHTML = "";
        let titleEmojis = []; const companionSections = [];
        
        activeEffects.previousCatStatus = activeEffects.currentCatStatus;

        if (activeEffects.hasAlienVisitor) {
            titleEmojis.push("üëΩ");
            const alienText = document.createElement('div');
            alienText.className = 'alien-visitor-text';
            let alienInfo = `<span class="alien-emoji-large">üëΩ</span><br/>Cosmic Visitor<br/>(+12 to Cosmic Symbols)`;
            const friesSymbol = symbols.find(s => s.emoji === "üçü");
            if (friesSymbol && friesSymbol.count > 0) alienInfo += `<br/><span style="font-size:0.8em; color: var(--accent-secondary);">Will consume ${friesSymbol.count} üçü</span>`;
            else alienInfo += `<br/><span style="font-size:0.8em; color: var(--text-secondary);">No üçü to consume</span>`;
            alienText.innerHTML = alienInfo;
            companionSections.push(alienText);
        }
        if (activeEffects.hasPetCat) {
            titleEmojis.push("üêà‚Äç‚¨õ");
            const catContainer = document.createElement('div'); catContainer.className = 'pet-info-container';
            let newStatus = 'üò∫';
            if (!activeEffects.hasMouseToy && activeEffects.spinsWithCat >= 20) newStatus = 'üòø';
            if (getTotalBirdCount() >= 4 && !windowFeatureState.hasBirdNest) newStatus = 'üòº';
            if (windowFeatureState.beetles > 0 && !windowFeatureState.hasBirdNest) newStatus = 'üôÄü™≤';
            if (activeEffects.sushiCatBuffActive) newStatus = 'üòªüç£';
            activeEffects.currentCatStatus = newStatus;

            if (activeEffects.currentCatStatus !== activeEffects.previousCatStatus) {
                let feedbackText = '';
                switch(newStatus) {
                    case 'üò∫': feedbackText = 'üò∫ +1'; break;
                    case 'üòø': feedbackText = 'üòø ¬±0'; break;
                    case 'üòº': feedbackText = 'üòº ¬±0'; break;
                    case 'üôÄü™≤': feedbackText = 'üôÄ -1'; break;
                    case 'üòªüç£': feedbackText = 'üòª +5'; break;
                }
                if(feedbackText) showFeedbackAnimation(feedbackText, 'neutral');
            }

            const mainArea = document.createElement('div'); mainArea.className = 'pet-main-area';
            const petDiv = document.createElement('div'); petDiv.className = 'pet-display';
            petDiv.innerHTML = `<span class="pet-status-emoji">${activeEffects.currentCatStatus}</span>`; mainArea.appendChild(petDiv);
            const petDescDiv = document.createElement('div'); petDescDiv.className = 'pet-description';
            if (activeEffects.currentCatStatus === 'üòªüç£') petDescDiv.textContent = `All Cats +5!`;
            else if (activeEffects.currentCatStatus === 'üò∫') petDescDiv.textContent = '+1 All Cats';
            else if (activeEffects.currentCatStatus === 'üòø') petDescDiv.textContent = 'Wants toy/No buff';
            else if (activeEffects.currentCatStatus === 'üòº') petDescDiv.textContent = 'Too many birds/no buff.';
            else if (activeEffects.currentCatStatus === 'üôÄü™≤') petDescDiv.textContent = '-1 All Cats (Scared by ü™≤!)';
            mainArea.appendChild(petDescDiv); catContainer.appendChild(mainArea);
            const petBottomArea = document.createElement('div'); petBottomArea.className = 'pet-bottom-area';
            if (activeEffects.hasMouseToy) {
                const toySpan = document.createElement('span'); toySpan.id = 'pet-toy-display'; toySpan.textContent = 'üêÅ'; petBottomArea.appendChild(toySpan);
            }
            const foodConsumptionDiv = document.createElement('div'); foodConsumptionDiv.className = 'pet-food-consumption';
            foodConsumptionDiv.textContent = `(-${GAME_CONFIG.catFoodConsumption} üçΩÔ∏è per spin)`; petBottomArea.appendChild(foodConsumptionDiv);
            if (petBottomArea.childElementCount > 0) catContainer.appendChild(petBottomArea);
            companionSections.push(catContainer);
        }
        if (activeEffects.hasPetDove) {
            titleEmojis.push("üïäÔ∏è");
            const doveContainer = document.createElement('div'); doveContainer.className = 'pet-info-container';
            doveContainer.innerHTML = `
                <div class="pet-main-area">
                    <span class="pet-status-emoji">üïäÔ∏è</span>
                    <div class="pet-description">Peaceful Companion (+2 to üïäÔ∏è)</div>
                </div>
                <div class="pet-bottom-area" style="margin-top: 10px;">
                    <div class="pet-food-consumption">+1 ü´ê every 10 spins</div>
                </div>`;
            companionSections.push(doveContainer);
        }
        if (companionSections.length > 0) {
            companionSections.forEach((section, index) => {
                content.appendChild(section);
                if (index < companionSections.length - 1) {
                    const separator = document.createElement('hr'); content.appendChild(separator);
                }
            });
        } else {
            content.innerHTML = '<div>No companion active. Adopt a üêà‚Äç‚¨õ or üïäÔ∏è from the grid, or activate an üëΩ from your inventory.</div>';
            titleEmojis.push("üíô");
        }
        DOM_ELEMENTS.petModalTitle.innerHTML = `${titleEmojis.join('')} Companion`;
    }
    function updateWindowButtonState() {
        if (DOM_ELEMENTS.windowTriggerBtn) {
            DOM_ELEMENTS.windowTriggerBtn.textContent = uiState.windowOpen ? 'ü™ü' : '‚¨ú';
            DOM_ELEMENTS.windowTriggerBtn.classList.toggle('toggled-off', !uiState.windowOpen);
        }
    }

    function animateSpin(gridSymbols, currentMultiplier) {
        DOM_ELEMENTS.grid.innerHTML = "";
        
        gridSymbols.forEach((item, index) => {
            const cell = document.createElement("div");
            cell.className = "slot-cell";

            let isMultiplierCell = false;
            if (activeEffects.quantumUpgradeActive || activeEffects.cosmicUpgradeActive) {
                if (index >= 4 && index <= 7) isMultiplierCell = true;
            } else {
                if (index === GAME_CONFIG.multiplierSlotIndex) isMultiplierCell = true;
            }

            if (isMultiplierCell) cell.classList.add(`multi-${currentMultiplier}x`);
            if (activeEffects.quantumUpgradeActive && slotMachineState.schrodingerCells.includes(index)) cell.classList.add('schrodinger-cat-effect');
            if (index === 3 && slotMachineState.topRightLocked) cell.classList.add("top-right-locked");

            const flipper = document.createElement('div');
            flipper.className = 'slot-flipper';

            const frontFace = document.createElement('div');
            frontFace.className = 'slot-face';

            const backFace = document.createElement('div');
            backFace.className = 'slot-back';
            
            const emojiSpan = document.createElement("span");
            emojiSpan.textContent = item ? item.emoji : '';
            backFace.appendChild(emojiSpan);

            const baseValueSpan = document.createElement("span");
            baseValueSpan.className = "base-value-text";
            if (item) {
                const finalPayout = getSingleItemPayout(item, index);
                baseValueSpan.textContent = finalPayout;
                if (isMultiplierCell) baseValueSpan.classList.add('multiplied-payout');
            }
            backFace.appendChild(baseValueSpan);
            
            if (isMultiplierCell) {
                const multiTextSpan = document.createElement("span");
                multiTextSpan.className = "multiplier-value-text";
                multiTextSpan.textContent = `${currentMultiplier}x`;
                backFace.appendChild(multiTextSpan);
            }

            flipper.appendChild(frontFace);
            flipper.appendChild(backFace);
            cell.appendChild(flipper);
            DOM_ELEMENTS.grid.appendChild(cell);

            requestAnimationFrame(() => {
                // REVISED: Faster animation
                const delay = index * 50; 
                flipper.style.transition = `transform 0.4s ease-in-out ${delay}ms`;
                flipper.style.transform = 'rotateY(180deg)';
            });
        });
    }

    function updateGridDOM(gridSymbols, currentMultiplier) {
        DOM_ELEMENTS.grid.innerHTML = "";
    
        gridSymbols.forEach((item, index) => {
            const div = document.createElement("div");
            div.className = "slot-cell";
            DOM_ELEMENTS.grid.appendChild(div);

            div.classList.remove('schrodinger-cat-effect', 'selectable-pet');

            const emojiSpan = document.createElement("span");
            emojiSpan.textContent = item ? item.emoji : '';
            div.appendChild(emojiSpan);

            const baseValueSpan = document.createElement("span");
            baseValueSpan.className = "base-value-text";
            div.appendChild(baseValueSpan);

            let isMultiplierCellForThisSpin = false;
            if (activeEffects.quantumUpgradeActive || activeEffects.cosmicUpgradeActive) {
                if (index >= 4 && index <= 7) isMultiplierCellForThisSpin = true;
            } else {
                if (index === GAME_CONFIG.multiplierSlotIndex) isMultiplierCellForThisSpin = true;
            }

            if (item) {
                const finalPayout = getSingleItemPayout(item, index);
                baseValueSpan.textContent = finalPayout;
                if (isMultiplierCellForThisSpin) baseValueSpan.classList.add('multiplied-payout');
            } else {
                baseValueSpan.textContent = '';
            }

            div.classList.remove('multi-2x', 'multi-3x', 'multi-5x');
            if (isMultiplierCellForThisSpin) {
                div.classList.add(`multi-${currentMultiplier}x`);
                const multiTextSpan = document.createElement("span");
                multiTextSpan.className = "multiplier-value-text";
                multiTextSpan.textContent = `${currentMultiplier}x`;
                div.appendChild(multiTextSpan);
            }

            if (activeEffects.quantumUpgradeActive && slotMachineState.schrodingerCells.includes(index)) div.classList.add('schrodinger-cat-effect');

            if (index === 3) {
                if (slotMachineState.topRightLocked) div.classList.add("top-right-locked");
                if (item) {
                    const lockDiv = document.createElement("div");
                    lockDiv.className = "lock-icon";
                    if (slotMachineState.topRightLocked) {
                        lockDiv.textContent = 'üîí';
                        lockDiv.classList.add("locked-state");
                    } else {
                        lockDiv.textContent = 'üîì';
                        if (playerState.lockItems <= 0) lockDiv.classList.add("no-locks");
                    }
                    div.appendChild(lockDiv);
                }
            }

            if (item && item.isFood && !uiState.isGameOver) {
                const foodItemInBag = symbols.find(s => s.emoji === item.emoji);
                if (foodItemInBag && foodItemInBag.count > 0 && playerState.foodMeter < GAME_CONFIG.maxFoodMeter) {
                    div.classList.add('clickable-food');
                    div.onclick = () => clickFoodEmoji(item.emoji, index);
                }
            }

            if (item && item.emoji === "üêà‚Äç‚¨õ" && !activeEffects.hasPetCat && !uiState.isGameOver) {
                div.classList.add('clickable-cat', 'selectable-pet');
                div.onclick = () => clickCatEmoji(index);
            }

            if (item && item.emoji === "üïäÔ∏è" && !activeEffects.hasPetDove && !uiState.isGameOver) {
                div.classList.add('clickable-food', 'selectable-pet');
                div.onclick = () => clickDoveEmoji(index);
            }
        });
    }

    function updatePowerDisplay() {
        if (DOM_ELEMENTS.powerMeterFill) DOM_ELEMENTS.powerMeterFill.style.width = `${(playerState.power / GAME_CONFIG.maxPower) * 100}%`;
        if (DOM_ELEMENTS.powerMeterIndicatorIcon) DOM_ELEMENTS.powerMeterIndicatorIcon.innerHTML = "<span class='base-power-icon'>üîå</span>";
    }
    function updateNextPowerBillCostDisplay() {
        if (DOM_ELEMENTS.nextPowerBillCostDisplay) {
            const billCost = GAME_CONFIG.powerBillBaseCost + (playerState.billsPaidSoFar * GAME_CONFIG.powerBillIncrement);
            DOM_ELEMENTS.nextPowerBillCostDisplay.textContent = `üìÉ${billCost}ü™ô`;
        }
    }
    function updateStatusEffectsWindow() {
        const donutActive = activeEffects.donutBuffActive && activeEffects.donutBuffSpinsLeft > 0;
        DOM_ELEMENTS.donutBuffStatusEl.innerHTML = donutActive ? `<span class="buff-emoji">üç©</span> <span class="buff-countdown">${activeEffects.donutBuffSpinsLeft}</span>` : '';
        DOM_ELEMENTS.donutBuffStatusEl.style.display = donutActive ? 'flex' : 'none';
        DOM_ELEMENTS.catBuffStatusEl.innerHTML = ''; DOM_ELEMENTS.catBuffStatusEl.style.display = 'none';
        if (activeEffects.hasPetCat) {
            let catHTML = ''; const currentStatus = activeEffects.currentCatStatus;
            if (currentStatus === 'üòªüç£') catHTML = `<span class="buff-emoji">üòª</span> <span class="buff-value">+5</span> <span class="buff-countdown">${activeEffects.sushiCatBuffSpinsLeft}</span>`;
            else if (currentStatus === 'üò∫') catHTML = `<span class="buff-emoji">üò∫</span> <span class="buff-value">+1</span>`;
            else if (currentStatus === 'üôÄü™≤') catHTML = `<span class="buff-emoji">üôÄ</span> <span class="buff-value" style="color: var(--accent-red);">-1</span>`;
            else if (currentStatus === 'üòø' || currentStatus === 'üòº') catHTML = `<span class="buff-emoji">${currentStatus.substring(0, 2)}</span>`;
            if (catHTML) { DOM_ELEMENTS.catBuffStatusEl.innerHTML = catHTML; DOM_ELEMENTS.catBuffStatusEl.style.display = 'flex'; }
        }
        const alienActive = activeEffects.hasAlienVisitor;
        DOM_ELEMENTS.alienBuffStatusEl.innerHTML = alienActive ? `<span class="buff-emoji">üëΩ</span> <span class="buff-value">+12</span>` : '';
        DOM_ELEMENTS.alienBuffStatusEl.style.display = alienActive ? 'flex' : 'none';
        const cosmicBonusModeActive = activeEffects.cosmicUpgradeActive && activeEffects.cosmicUpgradeSpinsLeft > 0;
        DOM_ELEMENTS.cosmicModeStatusEl.innerHTML = cosmicBonusModeActive ? `<span class="buff-emoji">üî≠</span> <span class="buff-countdown">${activeEffects.cosmicUpgradeSpinsLeft}</span>` : '';
        DOM_ELEMENTS.cosmicModeStatusEl.style.display = cosmicBonusModeActive ? 'flex' : 'none';
        const quantumBonusModeActive = activeEffects.quantumUpgradeActive && activeEffects.quantumUpgradeSpinsLeft > 0;
        DOM_ELEMENTS.quantumModeStatusEl.innerHTML = quantumBonusModeActive ? `<span class="buff-emoji">‚öõÔ∏è</span> <span class="buff-countdown">${activeEffects.quantumUpgradeSpinsLeft}</span>` : '';
        DOM_ELEMENTS.quantumModeStatusEl.style.display = quantumBonusModeActive ? 'flex' : 'none';
        DOM_ELEMENTS.permanentBuffStatusEl.innerHTML = ''; DOM_ELEMENTS.permanentBuffStatusEl.style.display = 'none';
        let permanentBuffsHTML = '';
        if (activeEffects.permanentBirdBuff) permanentBuffsHTML += `<span>üê¶+1</span>`;
        if (activeEffects.permanentFoodReplenishBuff) permanentBuffsHTML += `<span>üçΩÔ∏è+1</span>`;
        if (permanentBuffsHTML) { DOM_ELEMENTS.permanentBuffStatusEl.innerHTML = permanentBuffsHTML; DOM_ELEMENTS.permanentBuffStatusEl.style.display = 'flex'; }
        const phoneActive = phoneFeatureState.phoneOn;
        if (phoneActive) {
            const spinsLeft = Math.max(phoneFeatureState.investmentSpinsLeft, phoneFeatureState.takeoutSpinsLeft);
            DOM_ELEMENTS.phoneBuffStatusEl.innerHTML = `<span class="buff-emoji">üì±</span> <span class="buff-countdown">${spinsLeft}</span>`;
            DOM_ELEMENTS.phoneBuffStatusEl.style.display = 'flex';
        } else {
            DOM_ELEMENTS.phoneBuffStatusEl.innerHTML = ''; DOM_ELEMENTS.phoneBuffStatusEl.style.display = 'none';
        }
        const nestActive = windowFeatureState.hasBirdNest;
        DOM_ELEMENTS.nestStatusEl.innerHTML = nestActive ? `<span class="buff-emoji">ü™π</span>` : '';
        DOM_ELEMENTS.nestStatusEl.style.display = nestActive ? 'flex' : 'none';
        const feathers = windowFeatureState.feathers;
        DOM_ELEMENTS.featherStatusEl.innerHTML = feathers > 0 ? `<span class="buff-emoji">ü™∂</span> <span class="buff-countdown">${feathers}</span>` : '';
        DOM_ELEMENTS.featherStatusEl.style.display = feathers > 0 ? 'flex' : 'none';
        const beetles = windowFeatureState.beetles;
        DOM_ELEMENTS.beetleStatusEl.innerHTML = beetles > 0 ? `<span class="buff-emoji">ü™≤</span> <span class="buff-countdown">${beetles}</span>` : '';
        DOM_ELEMENTS.beetleStatusEl.style.display = beetles > 0 ? 'flex' : 'none';
        const branchActive = windowFeatureState.hasBranch;
        DOM_ELEMENTS.branchStatusEl.innerHTML = branchActive ? `<span class="buff-emoji">üåø</span>` : '';
        DOM_ELEMENTS.branchStatusEl.style.display = branchActive ? 'flex' : 'none';
    }

    // --- EVENT HANDLERS & UI INTERACTIONS ---
    function toggleLuckyLines() { if (!uiState.isGameOver) { slotMachineState.luckyLines = !slotMachineState.luckyLines; DOM_ELEMENTS.luckyBtn.classList.toggle("active", slotMachineState.luckyLines); updateDisplays(); } }
    function toggleGridLock() {
        if (uiState.isGameOver || !slotMachineState.currentGridSymbols[3]) return;
        const willBeLocked = !slotMachineState.topRightLocked;
        if (willBeLocked) {
            if (playerState.lockItems <= 0) return;
            playerState.lockItems--;
            slotMachineState.topRightSymbol = slotMachineState.currentGridSymbols[3];
            slotMachineState.topRightLocked = true;
        } else {
            slotMachineState.topRightSymbol = null;
            slotMachineState.topRightLocked = false;
        }
        updateGridDOM(slotMachineState.currentGridSymbols, slotMachineState.currentMultiplier);
        updateDisplays();
    }
    function toggleWindow() { uiState.windowOpen = !uiState.windowOpen; updateDisplays(); }
    function clickFoodEmoji(emoji, index) {
        if (uiState.isGameOver || playerState.foodMeter >= GAME_CONFIG.maxFoodMeter) return;
        const symbolOnGrid = slotMachineState.currentGridSymbols[index];
        if (symbolOnGrid && symbolOnGrid.emoji === emoji && symbolOnGrid.isFood) {
            const foodTypeInBag = symbols.find(s => s.emoji === emoji);
            if (foodTypeInBag && foodTypeInBag.count > 0) {
                foodTypeInBag.count--;
                let refillAmount = (symbolOnGrid.refill || 10) + (activeEffects.permanentFoodReplenishBuff ? 1 : 0);
                playerState.foodMeter = Math.min(GAME_CONFIG.maxFoodMeter, playerState.foodMeter + refillAmount);
                slotMachineState.currentGridSymbols[index] = null;
                if (emoji === "üç£" && activeEffects.hasPetCat && !activeEffects.sushiCatBuffActive) {
                    activeEffects.sushiCatBuffActive = true; activeEffects.sushiCatBuffSpinsLeft = GAME_CONFIG.sushiBuffDuration;
                }
                if (index === 3 && slotMachineState.topRightLocked) {
                    slotMachineState.topRightLocked = false; slotMachineState.topRightSymbol = null;
                }
                updateGridDOM(slotMachineState.currentGridSymbols, slotMachineState.currentMultiplier);
                updateDisplays();
            }
        }
    }
    function clickCatEmoji(index) {
        if (uiState.isGameOver || activeEffects.hasPetCat) return;
        const symbolOnGrid = slotMachineState.currentGridSymbols[index];
        const catSymbolData = symbols.find(s => s.emoji === "üêà‚Äç‚¨õ");
        if (symbolOnGrid && symbolOnGrid.emoji === "üêà‚Äç‚¨õ" && catSymbolData && catSymbolData.count > 0) {
            activeEffects.hasPetCat = true; activeEffects.spinsWithCat = 0;
            catSymbolData.count--;
            slotMachineState.currentGridSymbols[index] = null;
            if (index === 3 && slotMachineState.topRightLocked) {
                slotMachineState.topRightLocked = false; slotMachineState.topRightSymbol = null;
            }
            updateGridDOM(slotMachineState.currentGridSymbols, slotMachineState.currentMultiplier);
            updateDisplays();
        }
    }
    function clickDoveEmoji(index) {
        if (uiState.isGameOver || activeEffects.hasPetDove) return;
        const symbolOnGrid = slotMachineState.currentGridSymbols[index];
        const doveSymbolData = symbols.find(s => s.emoji === "üïäÔ∏è");
        if (symbolOnGrid && symbolOnGrid.emoji === "üïäÔ∏è" && doveSymbolData && doveSymbolData.count > 0) {
            activeEffects.hasPetDove = true; playerState.spinsSinceLastBlueberry = 0;
            doveSymbolData.count--;
            slotMachineState.currentGridSymbols[index] = null;
            if (index === 3 && slotMachineState.topRightLocked) {
                slotMachineState.topRightLocked = false; slotMachineState.topRightSymbol = null;
            }
            updateGridDOM(slotMachineState.currentGridSymbols, slotMachineState.currentMultiplier);
            updateDisplays();
        }
    }
    function purchaseItem(itemEmoji) {
        if (uiState.isGameOver) return;
        const itemData = SHOP_ITEMS_CONFIG.find(i => i.emoji === itemEmoji);
        if (!itemData) return;
        if (itemData.isUpgrade) {
            if (itemData.type === 'cosmic' && !activeEffects.cosmicUpgradePenaltyActive && !activeEffects.quantumUpgradeActive) {
                if (playerState.coins < itemData.cost) return;
                playerState.coins -= itemData.cost; activateCosmicUpgrade(); closeShopModal();
            } else if (itemData.type === 'quantum' && !activeEffects.quantumUpgradePenaltyActive && !activeEffects.cosmicUpgradeActive) {
                if (!activeEffects.cosmicModeCompleted || playerState.coins < itemData.cost) return;
                playerState.coins -= itemData.cost; activateQuantumUpgrade(); closeShopModal();
            }
        } else if (itemEmoji === "ü™π") {
            if (windowFeatureState.hasBirdNest) return;
            const hasDiscount = windowFeatureState.hasBranch;
            const finalCost = hasDiscount ? 250 : itemData.cost;
            if (playerState.coins < finalCost) return;
            playerState.coins -= finalCost;
            windowFeatureState.hasBirdNest = true;
            if (hasDiscount) windowFeatureState.hasBranch = false;
            if (windowFeatureState.beetles > 0) windowFeatureState.beetles = 0;
        } else if (itemEmoji === "üêÅ") {
            if (!activeEffects.hasPetCat || activeEffects.hasMouseToy || playerState.coins < itemData.cost) return;
            playerState.coins -= itemData.cost;
            activeEffects.hasMouseToy = true; activeEffects.spinsWithCat = 0;
        } else if (itemEmoji === "üìπ") {
            if (!activeEffects.hasAlienVisitor || playerState.camerasPurchasedThisGame >= 3 || playerState.coins < itemData.cost) return;
            playerState.coins -= itemData.cost;
            playerState.inventory[itemEmoji]++; playerState.camerasPurchasedThisGame++;
        } else {
            if (playerState.inventory[itemEmoji] > 0 && itemEmoji === "‚ö´") return;
            if (playerState.coins < itemData.cost) return;
            playerState.coins -= itemData.cost;
            playerState.inventory[itemEmoji]++;
        }
        updateDisplays();
    }
    function setupShop() {
        DOM_ELEMENTS.shopContent.innerHTML = "";
        const sortedShopItems = [...SHOP_ITEMS_CONFIG].sort((a, b) => a.cost - b.cost);
        sortedShopItems.forEach(item => {
            if ((item.emoji === "ü™π" && windowFeatureState.hasBirdNest) || (item.emoji === "üêÅ" && activeEffects.hasMouseToy) || (item.emoji === "üìπ" && playerState.camerasPurchasedThisGame >= 3)) return;
            if (item.isUpgrade) { if ((item.type === 'cosmic' && activeEffects.cosmicUpgradePenaltyActive) || (item.type === 'quantum' && activeEffects.quantumUpgradePenaltyActive)) return; }
            const btn = document.createElement("button"); btn.className = "shop-item-btn";
            let displayCost = item.cost;
            if (item.emoji === "ü™π") displayCost = windowFeatureState.hasBranch ? 250 : item.cost;
            let canBuy = true;
            if (playerState.coins < displayCost || uiState.isGameOver) canBuy = false;
            else if (item.emoji === "üêÅ") { if (!activeEffects.hasPetCat) canBuy = false; }
            else if (item.emoji === "üìπ") { if (!activeEffects.hasAlienVisitor || playerState.camerasPurchasedThisGame >= 3) canBuy = false; }
            else if (item.emoji === "‚ö´") { if (!activeEffects.quantumModeCompleted || playerState.inventory[item.emoji] >= 1) canBuy = false; }
            else if (item.isUpgrade) {
                if (activeEffects.cosmicUpgradeActive || activeEffects.quantumUpgradeActive) canBuy = false;
                if (item.type === 'quantum' && !activeEffects.cosmicModeCompleted) canBuy = false;
            }
            let itemName = item.name;
            if (item.emoji === 'üìπ') {
                const remaining = 3 - playerState.camerasPurchasedThisGame;
                itemName = `${item.name} (${remaining} left)`;
            }
            let buttonHTML = `${item.emoji} ${itemName}<strong class="shop-item-cost">${displayCost} ü™ô`;
            if (item.powerCost) buttonHTML += ` (-${item.powerCost}üîå)`;
            buttonHTML += `</strong>`;
            btn.innerHTML = buttonHTML;
            btn.onclick = () => purchaseItem(item.emoji);
            btn.disabled = !canBuy;
            DOM_ELEMENTS.shopContent.appendChild(btn);
        });
    }
    function showPhoneMessage(message, type) {
        if (uiState.isGameOver) return;
        DOM_ELEMENTS.phoneMessageDisplay.textContent = message;
        DOM_ELEMENTS.phoneMessageDisplay.className = `phone-message-display ${type}`;

        if (type === 'loss') {
            showFeedbackAnimation(`-${GAME_CONFIG.spamTextCost} ü™ô`, 'negative');
        } else if (type === 'friendly') {
            showFeedbackAnimation(`+${GAME_CONFIG.friendlyTextGain} ü™ô`, 'positive');
        }

        setTimeout(() => {
            if (DOM_ELEMENTS.phoneMessageDisplay.textContent === message) {
                DOM_ELEMENTS.phoneMessageDisplay.textContent = '';
                DOM_ELEMENTS.phoneMessageDisplay.className = 'phone-message-display';
            }
        }, 4000);
    }
    function setupPhoneModal() {
        DOM_ELEMENTS.phoneModalContent.innerHTML = '';
        const investmentBtn = document.createElement('button');
        investmentBtn.id = 'investments-btn'; investmentBtn.className = 'btn';
        investmentBtn.innerHTML = `üè¶ Investments`; investmentBtn.onclick = showInvestmentUI;
        DOM_ELEMENTS.phoneModalContent.appendChild(investmentBtn);
        const takeoutBtn = document.createElement('button');
        takeoutBtn.id = 'takeout-area'; takeoutBtn.className = 'btn';
        takeoutBtn.innerHTML = `ü•° Emoji Eats`; takeoutBtn.onclick = showTakeoutUI;
        DOM_ELEMENTS.phoneModalContent.appendChild(takeoutBtn);
        const isFeatureRunning = phoneFeatureState.investmentActive || phoneFeatureState.takeoutActive;
        investmentBtn.disabled = isFeatureRunning; takeoutBtn.disabled = isFeatureRunning;
    }
    function showInvestmentUI() {
        if (uiState.isGameOver || phoneFeatureState.investmentActive || phoneFeatureState.takeoutActive) return;
        const maxInvest = Math.min(playerState.coins, 1000);
        DOM_ELEMENTS.phoneModalContent.innerHTML = `
            <div class="investment-ui">
                <span>Invest (Max: ${maxInvest})</span>
                <span id="invest-amount-display">0</span>
                <input type="range" id="investment-slider" min="0" max="${maxInvest}" value="0">
                <button id="invest-btn" class="btn">Invest</button>
            </div>`;
        const slider = document.getElementById('investment-slider');
        const amountDisplay = document.getElementById('invest-amount-display');
        const button = document.getElementById('invest-btn');
        slider.oninput = () => { amountDisplay.textContent = slider.value; };
        button.onclick = () => { startInvestment(parseInt(slider.value)); };
    }
    function startInvestment(amount) {
        if (uiState.isGameOver || amount <= 0 || amount > playerState.coins || amount > 1000) return;
        phoneFeatureState.investmentAmount = amount; playerState.coins -= amount;
        phoneFeatureState.investmentActive = true; phoneFeatureState.phoneOn = true;
        phoneFeatureState.investmentSpinsLeft = GAME_CONFIG.investmentDuration;
        closePhoneModal(); updateDisplays();
    }
    function handleInvestmentSpin() {
        if (!phoneFeatureState.investmentActive || uiState.isGameOver) return;
        phoneFeatureState.investmentSpinsLeft--;
        if (phoneFeatureState.investmentSpinsLeft <= 0) resolveInvestment();
        updateDisplays();
    }
    function resolveInvestment() {
        if (!phoneFeatureState.investmentActive && !uiState.isGameOver) return;
        const profitMade = Math.random() < 0.75;
        let payoutAmount = profitMade ? Math.floor(phoneFeatureState.investmentAmount * 1.5) : Math.floor(phoneFeatureState.investmentAmount * 0.5);
        let messageText = `${profitMade ? 'üìà Profit!' : 'üìâ Loss!'} +${payoutAmount} ü™ô`;
        playerState.coins += payoutAmount; 
        
        if(profitMade) {
            showPhoneMessage(messageText, 'profit');
            showFeedbackAnimation(`üìà +${payoutAmount} ü™ô`, 'positive');
        } else {
            showPhoneMessage(messageText, 'loss');
            showFeedbackAnimation(`üìâ +${payoutAmount} ü™ô`, 'negative');
        }

        phoneFeatureState.investmentAmount = 0; phoneFeatureState.investmentActive = false;
        if (!phoneFeatureState.takeoutActive) phoneFeatureState.phoneOn = false;
        updateDisplays();
    }
    function showTakeoutUI() {
        if (uiState.isGameOver || phoneFeatureState.takeoutActive || phoneFeatureState.investmentActive) return;
        DOM_ELEMENTS.phoneModalContent.innerHTML = `
            <div class="takeout-ui">
                <span>Order Food: 15ü™ô each (10 for 100ü™ô).</span>
                <span id="takeout-amount-display">1</span>
                <input type="range" id="takeout-slider" min="1" max="10" value="1">
                <button id="takeout-confirm-btn" class="btn">Order</button>
            </div>`;
        const slider = document.getElementById('takeout-slider');
        const amountDisplay = document.getElementById('takeout-amount-display');
        const button = document.getElementById('takeout-confirm-btn');
        slider.oninput = () => { amountDisplay.textContent = slider.value; };
        button.onclick = () => { startTakeoutOrder(parseInt(slider.value)); };
    }
    function startTakeoutOrder(amount) {
        if (uiState.isGameOver || amount < 1 || amount > 10) return;
        let costPerItem = 15; let totalCost = amount * costPerItem;
        if (amount === 10) totalCost = 100;
        if (playerState.coins < totalCost) return;
        playerState.coins -= totalCost; phoneFeatureState.takeoutFoodAmount = amount;
        phoneFeatureState.takeoutActive = true; phoneFeatureState.phoneOn = true;
        phoneFeatureState.takeoutSpinsLeft = GAME_CONFIG.takeoutDuration;
        closePhoneModal(); updateDisplays();
    }
    function handleTakeoutSpin() {
        if (!phoneFeatureState.takeoutActive || uiState.isGameOver) return;
        phoneFeatureState.takeoutSpinsLeft--;
        if (phoneFeatureState.takeoutSpinsLeft <= 0) resolveTakeoutOrder();
        updateDisplays();
    }
    function resolveTakeoutOrder() {
        if (!phoneFeatureState.takeoutActive && !uiState.isGameOver) return;
        const foodSymbolsInGame = symbols.filter(s => s.isFood && !s.hidden && s.emoji !== 'ü´ê');
        if (foodSymbolsInGame.length > 0) {
            for (let i = 0; i < phoneFeatureState.takeoutFoodAmount; i++) {
                const randomFoodType = foodSymbolsInGame[Math.floor(Math.random() * foodSymbolsInGame.length)];
                const symbolToIncrement = symbols.find(sy => sy.emoji === randomFoodType.emoji);
                if (symbolToIncrement) symbolToIncrement.count = Math.min(GAME_CONFIG.maxFoodSymbolCap, symbolToIncrement.count + 1);
            }
        }
        showPhoneMessage(`ü•° +${phoneFeatureState.takeoutFoodAmount} food items delivered!`, "takeout-confirm");
        phoneFeatureState.takeoutActive = false; phoneFeatureState.takeoutFoodAmount = 0;
        if (!phoneFeatureState.investmentActive) phoneFeatureState.phoneOn = false;
        updateDisplays();
    }
    function consumeCoffee() {
        if (uiState.isGameOver || playerState.inventory["‚òï"] <= 0 || activeEffects.donutBuffActive) return;
        playerState.inventory["‚òï"]--;
        activeEffects.donutBuffActive = true;
        activeEffects.donutBuffSpinsLeft = GAME_CONFIG.donutBuffDuration;
        updateDisplays();
    }
    function consumePowerBill() {
        if (uiState.isGameOver || playerState.inventory['üìÉ'] <= 0) return;
        const billCost = GAME_CONFIG.powerBillBaseCost + (playerState.billsPaidSoFar * GAME_CONFIG.powerBillIncrement);
        if (playerState.coins < billCost) return;
        playerState.coins -= billCost; playerState.inventory['üìÉ']--;
        playerState.billsPaidSoFar++; playerState.power = GAME_CONFIG.maxPower;
        updateDisplays();
    }
    function consumeCamera() {
        if (uiState.isGameOver || playerState.inventory["üìπ"] <= 0 || !activeEffects.hasAlienVisitor) return;
        playerState.inventory["üìπ"]--;
        activeEffects.hasAlienVisitor = false; activeEffects.alienDroppedByUFO = false;
        const payout = Math.random() < 0.5 ? 4500 : 6000;
        playerState.coins += payout;
        const payout4500HTML = payout === 4500 ? `<span class="payout-option highlight">4500ü™ô</span>` : `4500ü™ô`;
        const payout6000HTML = payout === 6000 ? `<span class="payout-option highlight">6000ü™ô</span>` : `6000ü™ô`;
        const negotiationText = payout === 6000 ? 'You negotiated well!' : "You didn't negotiate well...";
        DOM_ELEMENTS.alienMediaPayoutContent.innerHTML = `You sold proof of alien life, scaring them away. Payouts: ${payout4500HTML} or ${payout6000HTML}.<br><br><strong>${negotiationText}</strong>`;
        DOM_ELEMENTS.alienMediaPayoutModal.classList.remove('hidden');
        updateDisplays();
    }
    function consumeBlackHole() {
        if (uiState.isGameOver || playerState.inventory["‚ö´"] <= 0) return;
        playerState.inventory["‚ö´"]--;
        DOM_ELEMENTS.blackHoleContent.innerHTML = `
            <p>The quantum upgrade resulted in the creation of a miniature black hole, swallowing the slot machine game into its singularity before collapsing just in time to avoid destroying the entire universe.</p>
            <p style="font-size: 24px;">üèÜ</p>
            <p><strong>Congratulations on your legendary run!</strong></p>`;
        gameOver("Achieved Singularity!");
        DOM_ELEMENTS.blackHoleModal.classList.remove('hidden');
    }
    function activateQuantumUpgrade() {
        if (uiState.isGameOver || activeEffects.quantumUpgradeActive || activeEffects.quantumUpgradePenaltyActive || activeEffects.cosmicUpgradeActive) return;
        activeEffects.quantumUpgradePenaltyActive = true; activeEffects.quantumUpgradeActive = true;
        activeEffects.quantumUpgradeSpinsLeft = GAME_CONFIG.quantumModeDuration;
        document.body.classList.add("quantum-theme");
        DOM_ELEMENTS.gameMainTitle.textContent = "QUANTUM MODE";
        DOM_ELEMENTS.gameMainTitle.classList.add('upgrade-mode-active');
        updateDisplays();
    }
    function activateCosmicUpgrade() {
        if (uiState.isGameOver || activeEffects.cosmicUpgradeActive || activeEffects.cosmicUpgradePenaltyActive || activeEffects.quantumUpgradeActive) return;
        activeEffects.cosmicUpgradePenaltyActive = true; activeEffects.cosmicUpgradeActive = true;
        activeEffects.cosmicUpgradeSpinsLeft = GAME_CONFIG.cosmicModeDuration;
        document.body.classList.add("cosmic-theme");
        DOM_ELEMENTS.gameMainTitle.textContent = "COSMIC MODE";
        DOM_ELEMENTS.gameMainTitle.classList.add('upgrade-mode-active');
        ["ü™ê", "üå†", "üåí", "üõ∏"].forEach(cosmicEmoji => {
            const symbol = symbols.find(s => s.emoji === cosmicEmoji);
            const initialCosmicSymbol = INITIAL_SYMBOLS_CONFIG.find(is => is.emoji === cosmicEmoji);
            if (symbol) {
                symbol.count = (symbol.count || 0) + 2; symbol.hidden = false;
            } else if (initialCosmicSymbol) {
                symbols.push({ ...initialCosmicSymbol, count: 2, originalValue: initialCosmicSymbol.value, hidden: false });
            }
        });
        updateDisplays();
    }
    function deactivateCosmicUpgradeBonusMode(showFeedback = true) {
        if (showFeedback) activeEffects.cosmicModeCompleted = true;
        activeEffects.cosmicUpgradeActive = false;
        document.body.classList.remove("cosmic-theme");
        if (!activeEffects.quantumUpgradeActive) {
            DOM_ELEMENTS.gameMainTitle.textContent = "KEEP SPINNING!";
            DOM_ELEMENTS.gameMainTitle.classList.remove('upgrade-mode-active');
        }
        updateDisplays();
    }
    function deactivateQuantumUpgradeBonusMode(showFeedback = true) {
        if (showFeedback) activeEffects.quantumModeCompleted = true;
        activeEffects.quantumUpgradeActive = false;
        document.body.classList.remove("quantum-theme");
        slotMachineState.schrodingerCells = [];
        if (!activeEffects.cosmicUpgradeActive) {
            DOM_ELEMENTS.gameMainTitle.textContent = "KEEP SPINNING!";
            DOM_ELEMENTS.gameMainTitle.classList.remove('upgrade-mode-active');
        }
        updateDisplays();
    }
    function activateAlienVisitor() {
        if (uiState.isGameOver || playerState.inventory["üëΩ"] <= 0 || activeEffects.hasAlienVisitor) return;
        playerState.inventory["üëΩ"]--; activeEffects.hasAlienVisitor = true;
        updateDisplays();
    }
    function showGiftChoiceModal() {
        if (uiState.isGameOver || playerState.inventory["üéÅ"] <= 0) return;
        DOM_ELEMENTS.giftChoiceModal.classList.remove('hidden');
    }
    // NEW: Function to show the special gift alert
    function showSpecialGiftAlert() {
        if (uiState.isGameOver) return;
        DOM_ELEMENTS.specialGiftAlertContent.innerHTML = `
            <h2>A Gift For You!</h2>
            <span class="gift-emoji">üéÅ</span>
            <p>You've earned a special reward! Check your inventory to open it.</p>
            <button id="special-gift-alert-close-btn" class="btn">Awesome!</button>
        `;
        DOM_ELEMENTS.specialGiftAlertModal.classList.remove('hidden');
        document.getElementById('special-gift-alert-close-btn').onclick = () => {
            DOM_ELEMENTS.specialGiftAlertModal.classList.add('hidden');
        };
    }
    function selectGift(choice) {
        if (playerState.inventory["üéÅ"] <= 0) return;
        playerState.inventory["üéÅ"]--;
        if (choice === 'bird') activeEffects.permanentBirdBuff = true;
        else if (choice === 'food') activeEffects.permanentFoodReplenishBuff = true;
        else if (choice === 'locks') playerState.lockItems += 3;
        DOM_ELEMENTS.giftChoiceModal.classList.add('hidden');
        updateDisplays();
    }
    function showGuideTopics() {
        const content = DOM_ELEMENTS.guideSelectionModalContent;
        content.innerHTML = `
            <button id="guide-how-to-play-btn" class="btn btn-how-to-play">How to Play</button>
             <div id="guide-icons-container">
                <span class="guide-icon" data-topic="window">ü™ü</span><span class="guide-icon" data-topic="food">üçΩÔ∏è</span>
                <span class="guide-icon" data-topic="companion">üíô</span><span class="guide-icon" data-topic="phone">üì±</span>
                <span class="guide-icon" data-topic="power">üîå</span><span class="guide-icon" data-topic="upgrades">üõ†Ô∏è</span>
            </div>
            <div class="guide-topic-content" id="guide-info-display"><p>Select an icon for gameplay information.</p></div>`;
        document.getElementById('guide-how-to-play-btn').addEventListener('click', () => displayGuideInfo('how-to-play'));
        content.querySelectorAll('.guide-icon').forEach(icon => {
            icon.addEventListener('click', () => displayGuideInfo(icon.dataset.topic));
        });
    }
    function displayGuideInfo(topic) {
        let content = '';
        switch (topic) {
            case 'how-to-play': content = `<h4>How to Play</h4><p>Your slot machine seems to be connected with the <strong>world itself.</strong> <p>Birds fly through your window and enter the game. You order food on your phone, but it shows up as game symbols. It's all connected. The game ends if you run out of food, coins, or fail to pay your power bill in a timely manner.</p><ul><li><strong>Focus:</strong> Pay attention to food, hitting 0 means game over.</li><li><strong>Budget:</strong> Keep an eye on the next power bill and time your investments and purchases accordingly.</li><li><strong>Strategy:</strong> Use items, buffs and new companions to win bigger payouts.</li><li><strong>Goal:</strong> Upgrade your slot machine to peer into the cosmos, probe the quantum realm, and be there for its ultimate end.</li></ul>`; break;
            case 'window': content = `<h4>ü™ü The Window & Birds</h4><ul><li><strong>Window Open (ü™ü):</strong> 15% chance to gain a bird, 15% chance to lose one per spin.</li><li><strong>Window Closed (‚¨ú):</strong> Birds are safe; no gains or losses.</li><li><strong>Bird Drops (15% chance per bird):</strong></li><li>&nbsp;&nbsp;<strong>ü¶ú</strong> drops <strong>ü™≤ Beetle</strong></li><li>&nbsp;&nbsp;<strong>ü¶â</strong> drops <strong>ü™∂ Feather</strong></li><li>&nbsp;&nbsp;<strong>üïäÔ∏è</strong> drops <strong>üåø Branch</strong></li><li><strong>Items & Maximums:</strong></li><li>&nbsp;&nbsp;<strong>Total Birds:</strong> Max 8.</li><li>&nbsp;&nbsp;<strong>ü™∂ Feathers:</strong> +1 value to all birds. Max 5.</li><li>&nbsp;&nbsp;<strong>ü™≤ Beetles:</strong> Consumes in place of a bird escape. Scares cats. Max 1.</li><li>&nbsp;&nbsp;<strong>üåø Branch:</strong> Consumed to discount ü™π Nest in shop. Only one drops per game.</li><li>&nbsp;&nbsp;<strong>ü™π Nest (Shop):</strong> Permanently protects all birds from leaving, prevents ü™≤ and calms cat (removes üòº).</li></ul>`; break;
            case 'food': content = `<h4>üçΩÔ∏è Food & Consumables</h4><ul><li><strong>Food Meter:</strong> Game ends at 0. Max food is 20.</li><li><strong>Replenish:</strong> Click food on grid (üçü, üç£, üç©) to use one from your inventory.</li><li>&nbsp;&nbsp;Food gives +10 üçΩÔ∏è.</li><li>&nbsp;&nbsp;Blueberries (ü´ê) only give +5 üçΩÔ∏è.</li><li><strong>Max Food Items:</strong> You can hold a maximum of 8 of any single food type.</li><li><strong>Special Effects:</strong></li><li>&nbsp;&nbsp;<strong>‚òï Coffee:</strong> Use from inventory. For 10 spins, üç© are worth +3 more value.</li><li>&nbsp;&nbsp;<strong>üç£ Sushi:</strong> Shares with cat. üòª cat buff. +5 value for 3 spins.</li></ul>`; break;
            case 'companion': content = `<h4>üíô Companions</h4><p>Adopt companions from the grid to gain buffs. You can have a Cat, a Dove, and an Alien all at once.</p><ul><li><strong>üêà‚Äç‚¨õ Cat:</strong> Costs 1 üçΩÔ∏è per spin. Its value changes with its mood.</li><li>&nbsp;&nbsp;<strong>üò∫ Happy:</strong> +1 value.</li><li>&nbsp;&nbsp;<strong>üòª Sushi:</strong> +5 value for 3 spins.</li><li>&nbsp;&nbsp;<strong>üòø Sad:</strong> No buff. Needs a üêÅ Toy.</li><li>&nbsp;&nbsp;<strong>üòº Annoyed:</strong> No buff. Too many birds (4+).</li><li>&nbsp;&nbsp;<strong>üôÄ Scared:</strong> -1 value. Scared by ü™≤.</li><li><strong>üïäÔ∏è Dove:</strong> Tame from the grid. Gives +2 value to all doves and provides +1 ü´ê every 10 spins.</li><li><strong>üëΩ Alien:</strong> üõ∏ has 15% chance to drop üëΩ. Activate from inventory. Adds +12 value to Cosmic symbols but eats all üçü each spin.</li></ul>`; break;
            case 'phone': content = `<h4>üì± Phone</h4><p>Phone actions take 10 spins to complete. While active, you have a 25% chance each spin to get a text: +10ü™ô or -35ü™ô.</p><ul><li><strong>ü•° Emoji Eats:</strong> Order a delivery of random food items.</li><li><strong>üè¶ Investments:</strong> Invest coins:</li><li>&nbsp;&nbsp;<strong>75% chance</strong> of 1.5x profit.</li><li>&nbsp;&nbsp;<strong>25% chance</strong> of 0.5x loss.</li></ul>`; break;
            case 'power': content = `<h4>üîå Power & Bills</h4><ul><li>Power decreases every spin (-1 base, more with upgrades).</li><li>If power reaches 0, you get a üìÉ Bill in your inventory.</li><li>You must pay the bill by clicking it. The cost increases each time.</li><li><strong>Warning:</strong> Spinning with an unpaid bill has a <strong>5% chance of instant Game Over</strong>.</li></ul>`; break;
            case 'upgrades': content = `<h4>üõ†Ô∏è Upgrades & Endgame</h4><p><strong>LL Button (Lucky Lines):</strong> Increases spin cost, but allows four-in-a-row to give 150 coin bonus.</p><ul><li><strong>üî≠ Cosmic Upgrade:</strong></li><li>&nbsp;&nbsp;Adds permanent -2 üîå drain per spin.</li><li>&nbsp;&nbsp;Triggers 20-spin <strong>Cosmic Mode</strong> where the multiplier affects the entire bottom row. Gain special cosmic symbols, including the important üõ∏.</li><li><strong>‚öõÔ∏è Quantum Upgrade:</strong></li><li>&nbsp;&nbsp;Adds permanent -4 üîå drain per spin.</li><li>&nbsp;&nbsp;Triggers 20-spin <strong>Quantum Mode</strong> where the multiplier affects the entire bottom row. Two random grid cells per spin invoke Schr√∂dinger's Cat experiment: if a üêà‚Äç‚¨õ lands there, its value is multiplied by <strong>500x</strong>!</li><li><strong>‚ö´ Black Hole:</strong></li><li>&nbsp;&nbsp;Available in the shop only after completing Quantum Mode. Using it wins the game.</li></ul>`; break;
            default: content = '<p>Select an icon for gameplay information.</p>';
        }
        const backButtonHTML = `<button id="guide-back-btn" class="btn">Back to Topics</button>`;
        const fullContent = `<div class="guide-topic-content">${content}</div>`;
        DOM_ELEMENTS.guideSelectionModalContent.innerHTML = backButtonHTML + fullContent;
        document.getElementById('guide-back-btn').addEventListener('click', showGuideTopics);
    }
    function openShopModal() { if (!uiState.isGameOver) DOM_ELEMENTS.shopModalOverlay.classList.remove('hidden'); }
    function closeShopModal() { DOM_ELEMENTS.shopModalOverlay.classList.add('hidden'); }
    function openGuideSelectionModal() { if (!uiState.isGameOver) { showGuideTopics(); DOM_ELEMENTS.guideSelectionModalOverlay.classList.remove('hidden'); } }
    function closeGuideSelectionModal() { DOM_ELEMENTS.guideSelectionModalOverlay.classList.add('hidden'); }
    function openPetModal() { if (!uiState.isGameOver) DOM_ELEMENTS.petModalOverlay.classList.remove('hidden'); }
    function closePetModal() { DOM_ELEMENTS.petModalOverlay.classList.add('hidden'); }
    function openPhoneModal() { if (!uiState.isGameOver) { setupPhoneModal(); DOM_ELEMENTS.phoneModalOverlay.classList.remove('hidden'); } }
    function closePhoneModal() { DOM_ELEMENTS.phoneModalOverlay.classList.add('hidden'); }
    function closeAllWindows() {
        DOM_ELEMENTS.alienMediaPayoutModal.classList.add('hidden');
        DOM_ELEMENTS.giftChoiceModal.classList.add('hidden');
        DOM_ELEMENTS.shopModalOverlay.classList.add('hidden');
        DOM_ELEMENTS.guideSelectionModalOverlay.classList.add('hidden');
        DOM_ELEMENTS.petModalOverlay.classList.add('hidden');
        DOM_ELEMENTS.phoneModalOverlay.classList.add('hidden');
        DOM_ELEMENTS.blackHoleModal.classList.add('hidden');
        DOM_ELEMENTS.specialGiftAlertModal.classList.add('hidden'); // NEW
    }
    function initGame() {
        initializeGameVariables();
        DOM_ELEMENTS.spinBtn.addEventListener('click', spin);
        DOM_ELEMENTS.luckyBtn.addEventListener('click', toggleLuckyLines);
        DOM_ELEMENTS.windowTriggerBtn.addEventListener('click', toggleWindow);
        DOM_ELEMENTS.petTriggerBtn.addEventListener('click', openPetModal);
        DOM_ELEMENTS.phoneTriggerBtn.addEventListener('click', openPhoneModal);
        DOM_ELEMENTS.shopTriggerBtn.addEventListener('click', openShopModal);
        DOM_ELEMENTS.guideTriggerBtn.addEventListener('click', openGuideSelectionModal);
        DOM_ELEMENTS.shopModalCloseBtn.addEventListener('click', closeShopModal);
        DOM_ELEMENTS.guideSelectionModalCloseBtn.addEventListener('click', closeGuideSelectionModal);
        DOM_ELEMENTS.petModalCloseBtn.addEventListener('click', closePetModal);
        DOM_ELEMENTS.phoneModalCloseBtn.addEventListener('click', closePhoneModal);
        DOM_ELEMENTS.alienMediaPayoutCloseBtn.addEventListener('click', () => DOM_ELEMENTS.alienMediaPayoutModal.classList.add('hidden'));
        DOM_ELEMENTS.blackHoleCloseBtn.addEventListener('click', () => DOM_ELEMENTS.blackHoleModal.classList.add('hidden'));
        [DOM_ELEMENTS.shopModalOverlay, DOM_ELEMENTS.guideSelectionModalOverlay, DOM_ELEMENTS.petModalOverlay, DOM_ELEMENTS.phoneModalOverlay, DOM_ELEMENTS.alienMediaPayoutModal, DOM_ELEMENTS.blackHoleModal, DOM_ELEMENTS.specialGiftAlertModal].forEach(overlay => {
            overlay.addEventListener('click', (event) => { if (event.target === overlay) overlay.classList.add('hidden'); });
        });
        DOM_ELEMENTS.giftChoiceBirdBtn.addEventListener('click', () => selectGift('bird'));
        DOM_ELEMENTS.giftChoiceFoodBtn.addEventListener('click', () => selectGift('food'));
        DOM_ELEMENTS.giftChoiceLocksBtn.addEventListener('click', () => selectGift('locks'));
        DOM_ELEMENTS.luckyBtn.textContent = 'LL';
        DOM_ELEMENTS.gameMainTitle.textContent = "KEEP SPINNING!";
        DOM_ELEMENTS.gameMainTitle.classList.remove('upgrade-mode-active');
        closeAllWindows();
        slotMachineState.currentGridSymbols = getSymbolsForSpin();
        slotMachineState.currentMultiplier = getRandomMultiplier();
        updateGridDOM(slotMachineState.currentGridSymbols, slotMachineState.currentMultiplier);
        updateDisplays();
    }
    initGame();
});
</script>
</body>
</html>
